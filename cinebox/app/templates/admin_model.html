{% extends "base.html" %}

{% block title %}Quản lý Model - CineBox{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-brain"></i> Quản lý Model Collaborative Filtering</h2>
            <hr>
        </div>
    </div>

    <!-- Model Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Trạng thái Model</h5>
                </div>
                <div class="card-body">
                    <div id="model-status">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p>Đang tải thông tin model...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-users"></i> Trạng thái Users</h5>
                </div>
                <div class="card-body">
                    <div id="user-status">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p>Đang tải thông tin users...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Retrain Model -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-sync-alt"></i> Retrain Model</h5>
                </div>
                <div class="card-body">
                    <p>Retrain model để bao gồm users mới và ratings mới từ database.</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Lưu ý:</strong> Quá trình retrain có thể mất vài phút và sẽ tạo backup model cũ.
                    </div>
                    
                    <button id="retrain-btn" class="btn btn-primary" onclick="retrainModel()">
                        <i class="fas fa-sync-alt"></i> Retrain Model
                    </button>
                    
                    <div id="retrain-progress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%">
                                Đang retrain model...
                            </div>
                        </div>
                    </div>
                    
                    <div id="retrain-result" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-tools"></i> Hành động</h5>
                </div>
                <div class="card-body">
                    <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại Dashboard
                    </a>
                    <button class="btn btn-info" onclick="refreshStatus()">
                        <i class="fas fa-refresh"></i> Làm mới
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load model status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadModelStatus();
});

function loadModelStatus() {
    fetch('/api/model_status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayModelStatus(data.modelInfo);
                displayUserStatus(data.users);
            } else {
                document.getElementById('model-status').innerHTML = 
                    '<div class="alert alert-danger">Lỗi: ' + data.message + '</div>';
            }
        })
        .catch(error => {
            document.getElementById('model-status').innerHTML = 
                '<div class="alert alert-danger">Lỗi khi tải thông tin model: ' + error + '</div>';
        });
}

function displayModelStatus(modelInfo) {
    const statusHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>Thông tin Model:</h6>
                <ul class="list-unstyled">
                    <li><strong>Trạng thái:</strong> <span class="badge badge-success">${modelInfo.status}</span></li>
                    <li><strong>Số users:</strong> ${modelInfo.n_users}</li>
                    <li><strong>Số items:</strong> ${modelInfo.n_items}</li>
                    <li><strong>Đường dẫn:</strong> ${modelInfo.model_path}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Chi tiết:</h6>
                <ul class="list-unstyled">
                    <li><strong>User factors:</strong> ${modelInfo.user_factors_shape ? modelInfo.user_factors_shape.join(' x ') : 'N/A'}</li>
                    <li><strong>Item factors:</strong> ${modelInfo.item_factors_shape ? modelInfo.item_factors_shape.join(' x ') : 'N/A'}</li>
                </ul>
            </div>
        </div>
    `;
    document.getElementById('model-status').innerHTML = statusHtml;
}

function displayUserStatus(users) {
    let statusHtml = '<div class="table-responsive"><table class="table table-sm">';
    statusHtml += '<thead><tr><th>User ID</th><th>Email</th><th>Ratings</th><th>Trong Model</th></tr></thead><tbody>';
    
    users.forEach(user => {
        const inModelBadge = user.inModel ? 
            '<span class="badge badge-success">Có</span>' : 
            '<span class="badge badge-warning">Không</span>';
        
        statusHtml += `
            <tr>
                <td>${user.userId}</td>
                <td>${user.email}</td>
                <td>${user.ratingCount}</td>
                <td>${inModelBadge}</td>
            </tr>
        `;
    });
    
    statusHtml += '</tbody></table></div>';
    document.getElementById('user-status').innerHTML = statusHtml;
}

function retrainModel() {
    const btn = document.getElementById('retrain-btn');
    const progress = document.getElementById('retrain-progress');
    const result = document.getElementById('retrain-result');
    
    // Disable button and show progress
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang retrain...';
    progress.style.display = 'block';
    result.innerHTML = '';
    
    fetch('/api/retrain_model', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        progress.style.display = 'none';
        
        if (data.success) {
            result.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> ' + data.message + '</div>';
            // Reload status after successful retrain
            setTimeout(() => {
                loadModelStatus();
            }, 1000);
        } else {
            result.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> ' + data.message + '</div>';
        }
    })
    .catch(error => {
        progress.style.display = 'none';
        result.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times"></i> Lỗi: ' + error + '</div>';
    })
    .finally(() => {
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Retrain Model';
    });
}

function refreshStatus() {
    loadModelStatus();
}
</script>
{% endblock %}
