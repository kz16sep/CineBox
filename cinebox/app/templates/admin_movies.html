{% extends 'base.html' %}
{% block title %}Qu·∫£n l√Ω phim ¬∑ CineBox{% endblock %}
{% block content %}
<div class="admin">
  <h1>üé¨ Qu·∫£n l√Ω phim</h1>
  
  <!-- Hi·ªÉn th·ªã flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <style>
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(-20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .flash-message {
          animation: slideIn 0.3s ease-out;
        }
      </style>
      {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}" style="background: {% if category == 'success' %}#10b981{% else %}#ef4444{% endif %}; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
          <span style="font-size: 1.2em;">{% if category == 'success' %}‚úÖ{% else %}‚ùå{% endif %}</span>
          <span style="flex: 1;">{{ message }}</span>
          <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">‚úï</button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
  
  <!-- Progress bar cho similarity calculation -->
  {% if new_movie_id %}
  <div id="similarity-progress-container" style="background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
      <h3 style="margin: 0; color: #fff; font-size: 1.1em;">üîÑ ƒêang t√≠nh similarity cho phim ID: {{ new_movie_id }}</h3>
      <button onclick="document.getElementById('similarity-progress-container').style.display='none'" style="background: transparent; border: none; color: #999; font-size: 1.2em; cursor: pointer;">‚úï</button>
    </div>
    <div style="background: #2a2a2a; border-radius: 4px; height: 24px; overflow: hidden; margin-bottom: 8px;">
      <div id="similarity-progress-bar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85em; font-weight: 600;">
        <span id="similarity-progress-text">0%</span>
      </div>
    </div>
    <div id="similarity-progress-message" style="color: #ccc; font-size: 0.9em;">ƒêang b·∫Øt ƒë·∫ßu...</div>
  </div>
  {% endif %}
  
  <!-- Thanh t√¨m ki·∫øm -->
  <div class="admin-search-bar">
    <form method="GET" action="{{ url_for('main.admin_movies') }}" class="search-form">
      <div class="search-input-group">
        <input 
          type="text" 
          name="q" 
          value="{{ search_query or '' }}"
          placeholder="T√¨m ki·∫øm phim theo t√™n..." 
          class="search-input"
        />
        <button type="submit" class="search-btn">
          <span>üîç</span>
        </button>
        {% if search_query %}
        <a href="{{ url_for('main.admin_movies') }}" class="clear-search-btn">‚úï</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Th·ªëng k√™ -->
  <div class="admin-stats">
    <div class="stat-item">
      <span class="stat-label">T·ªïng s·ªë phim:</span>
      <span class="stat-value">{{ pagination.total if pagination else movies|length }}</span>
    </div>
    {% if search_query %}
    <div class="stat-item">
      <span class="stat-label">K·∫øt qu·∫£ t√¨m ki·∫øm:</span>
      <span class="stat-value">{{ movies|length }}</span>
    </div>
    {% endif %}
  </div>

  <!-- N√∫t th√™m phim -->
  <div class="admin-actions">
    <a class="btn btn-primary" href="{{ url_for('main.admin_movie_create') }}">
      ‚ûï Th√™m phim m·ªõi
    </a>
  </div>

  <!-- B·∫£ng phim -->
  <div class="admin-table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Poster</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th>NƒÉm</th>
          <th>L∆∞·ª£t xem</th>
          <th>Ng√†y t·∫°o</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        {% for movie in movies %}
        <tr>
          <td class="movie-id">{{ movie.movieId }}</td>
          <td class="movie-poster">
            {% if movie.posterUrl and movie.posterUrl != "1" %}
              <img src="{{ movie.posterUrl }}" alt="{{ movie.title }}" class="poster-thumb">
            {% else %}
              <div class="poster-placeholder">üìΩÔ∏è</div>
            {% endif %}
          </td>
          <td class="movie-title">{{ movie.title }}</td>
          <td class="movie-year">{{ movie.releaseYear or '-' }}</td>
          <td class="movie-views">{{ movie.viewCount or 0 }}</td>
          <td class="movie-date">{{ movie.createdAt.strftime('%d/%m/%Y') if movie.createdAt else '-' }}</td>
          <td class="movie-actions">
            <a class="btn btn-sm btn-primary" href="{{ url_for('main.admin_movie_edit', movie_id=movie.movieId) }}">
              ‚úèÔ∏è S·ª≠a
            </a>
            <form method="post" action="{{ url_for('main.admin_movie_delete', movie_id=movie.movieId) }}" 
                  style="display:inline" 
                  onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a phim \"{{ movie.title }}\"?');">
              <button class="btn btn-sm btn-delete" type="submit">üóëÔ∏è X√≥a</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="no-data">
            {% if search_query %}
              Kh√¥ng t√¨m th·∫•y phim n√†o v·ªõi t·ª´ kh√≥a "{{ search_query }}"
            {% else %}
              Ch∆∞a c√≥ phim n√†o trong h·ªá th·ªëng
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ph√¢n trang -->
  {% if pagination and pagination.pages > 1 %}
  <div class="pagination">
    <div class="pagination-info">
      Hi·ªÉn th·ªã {{ ((pagination.page - 1) * pagination.per_page + 1) }} - 
      {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
      trong t·ªïng s·ªë {{ pagination.total }} phim
    </div>
    
    <div class="pagination-controls">
      {% if pagination.has_prev %}
        <a href="{{ url_for('main.admin_movies', page=pagination.prev_num, q=search_query) }}" 
           class="btn-pagination">‚Üê Trang tr∆∞·ªõc</a>
      {% else %}
        <span class="btn-pagination" style="opacity: 0.5; cursor: not-allowed;">‚Üê Trang tr∆∞·ªõc</span>
      {% endif %}
      
      <span class="page-info">
        Trang {{ pagination.page }} / {{ pagination.pages }}
      </span>
      
      {% if pagination.has_next %}
        <a href="{{ url_for('main.admin_movies', page=pagination.next_num, q=search_query) }}" 
           class="btn-pagination">Trang sau ‚Üí</a>
      {% else %}
        <span class="btn-pagination" style="opacity: 0.5; cursor: not-allowed;">Trang sau ‚Üí</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<style>
.admin {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.admin h1 {
  color: #fff;
  margin-bottom: 30px;
  font-size: 2.5rem;
  text-align: center;
}

.admin-search-bar {
  margin-bottom: 20px;
}

.search-form {
  max-width: 500px;
  margin: 0 auto;
}

.search-input-group {
  display: flex;
  align-items: center;
  background: var(--panel);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 8px;
  position: relative;
}

.search-input {
  flex: 1;
  background: transparent;
  border: none;
  color: #fff;
  padding: 12px 16px;
  font-size: 16px;
  outline: none;
}

.search-input::placeholder {
  color: var(--muted);
}

.search-btn {
  background: var(--primary);
  border: none;
  color: #fff;
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s ease;
}

.search-btn:hover {
  background: var(--primary-2);
}

.clear-search-btn {
  position: absolute;
  right: 60px;
  color: var(--muted);
  text-decoration: none;
  font-size: 18px;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
}

.clear-search-btn:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.1);
}

.admin-stats {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  justify-content: center;
}

.stat-item {
  background: var(--panel);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 12px;
  padding: 15px 20px;
  text-align: center;
}

.stat-label {
  color: var(--muted);
  font-size: 0.9rem;
  display: block;
  margin-bottom: 5px;
}

.stat-value {
  color: var(--primary);
  font-size: 1.5rem;
  font-weight: bold;
}

.admin-actions {
  margin-bottom: 20px;
  text-align: center;
}

.admin-table-container {
  background: var(--panel);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
}

.admin-table th {
  background: var(--panel-2);
  color: #fff;
  padding: 15px 12px;
  text-align: left;
  font-weight: 600;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.admin-table td {
  padding: 12px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  color: #fff;
  vertical-align: middle;
}

.admin-table tr:hover {
  background: rgba(255, 255, 255, 0.02);
}

.movie-id {
  width: 60px;
  text-align: center;
  color: var(--muted);
}

.movie-poster {
  width: 80px;
  text-align: center;
}

.poster-thumb {
  width: 50px;
  height: 70px;
  object-fit: cover;
  border-radius: 6px;
}

.poster-placeholder {
  width: 50px;
  height: 70px;
  background: var(--panel-2);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: var(--muted);
}

.movie-title {
  font-weight: 600;
  max-width: 300px;
}

.movie-year, .movie-views, .movie-date {
  text-align: center;
  color: var(--muted);
}

.movie-actions {
  text-align: center;
}

.movie-actions .btn {
  margin: 0 2px;
  padding: 6px 12px;
  font-size: 12px;
}

.btn-delete {
  background: #ef4444 !important;
  color: #fff !important;
  border: 1px solid #dc2626 !important;
}

.btn-delete:hover {
  background: #dc2626 !important;
  border-color: #b91c1c !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.no-data {
  text-align: center;
  color: var(--muted);
  font-style: italic;
  padding: 40px !important;
}

.pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding: 20px;
  background: var(--panel);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 12px;
}

.pagination-info {
  color: var(--muted);
  font-size: 0.9rem;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 15px;
}

.page-info {
  color: #fff;
  font-weight: 600;
}

@media (max-width: 768px) {
  .admin {
    padding: 15px;
  }
  
  .admin-table-container {
    overflow-x: auto;
  }
  
  .admin-table {
    min-width: 800px;
  }
  
  .pagination {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .admin-stats {
    flex-direction: column;
    align-items: center;
  }
}
</style>

{% if new_movie_id %}
<script>
(function() {
  const movieId = {{ new_movie_id }};
  const progressContainer = document.getElementById('similarity-progress-container');
  const progressBar = document.getElementById('similarity-progress-bar');
  const progressText = document.getElementById('similarity-progress-text');
  const progressMessage = document.getElementById('similarity-progress-message');
  
  let pollInterval;
  let checkCount = 0;
  const maxChecks = 300; // T·ªëi ƒëa 5 ph√∫t (300 * 1 gi√¢y)
  
  function updateProgress(data) {
    const progress = data.progress || 0;
    const status = data.status || 'running';
    const message = data.message || '';
    
    progressBar.style.width = progress + '%';
    progressText.textContent = progress + '%';
    progressMessage.textContent = message;
    
    if (status === 'completed') {
      progressBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
      clearInterval(pollInterval);
      // ·∫®n progress bar sau 3 gi√¢y
      setTimeout(() => {
        if (progressContainer) {
          progressContainer.style.transition = 'opacity 0.5s';
          progressContainer.style.opacity = '0';
          setTimeout(() => {
            progressContainer.style.display = 'none';
          }, 500);
        }
      }, 3000);
    } else if (status === 'error') {
      progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
      clearInterval(pollInterval);
    }
  }
  
  function checkProgress() {
    checkCount++;
    if (checkCount > maxChecks) {
      clearInterval(pollInterval);
      progressMessage.textContent = '‚è±Ô∏è ƒê√£ qu√° th·ªùi gian ch·ªù, vui l√≤ng t·∫£i l·∫°i trang';
      return;
    }
    
    fetch(`/api/similarity-progress/${movieId}`)
      .then(response => response.json())
      .then(data => {
        updateProgress(data);
        
        if (data.status === 'completed' || data.status === 'error') {
          clearInterval(pollInterval);
        }
      })
      .catch(error => {
        console.error('Error checking progress:', error);
        if (checkCount > 10) {
          clearInterval(pollInterval);
          progressMessage.textContent = '‚ùå L·ªói khi ki·ªÉm tra ti·∫øn tr√¨nh';
        }
      });
  }
  
  // B·∫Øt ƒë·∫ßu poll m·ªói 1 gi√¢y
  checkProgress(); // Check ngay l·∫≠p t·ª©c
  pollInterval = setInterval(checkProgress, 1000);
})();
</script>
{% endif %}
{% endblock %}


