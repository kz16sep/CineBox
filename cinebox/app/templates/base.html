<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}CineBox{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
      /* Scale to√†n b·ªô trang web xu·ªëng 80% */
      * {
        box-sizing: border-box;
      }
      
      body {
        transform: scale(0.8);
        transform-origin: 0 0;
        width: 125%;
      }
    </style>
  </head>
  <body class="theme-dark">
    <header class="navbar">
      <div class="container">
        <a href="{{ url_for('main.home') }}" class="logo">Cine<span>Box</span></a>
        <form class="search" action="{{ url_for('main.search') }}" method="GET">
          <div class="search-input-group">
            <input 
              type="text" 
              name="q" 
              placeholder="T√¨m ki·∫øm phim, series.." 
              class="search-input"
              id="headerSearchInput"
              autocomplete="off"
            />
            <button type="submit" class="search-btn">
              <span>üîç</span>
            </button>
          </div>
          
          <!-- Search Suggestions Dropdown -->
          <div class="search-suggestions" id="headerSearchSuggestions" style="display: none;">
            <div class="suggestions-list" id="headerSuggestionsList">
              <!-- Suggestions will be populated by JavaScript -->
            </div>
          </div>
        </form>
        <nav>
          {% if session.get('user_id') %}
            <div class="user-box">
              {% if session.get('role') == 'Admin' %}
                <a class="btn btn-primary" href="{{ url_for('main.admin_dashboard') }}">Admin</a>
              {% endif %}
              <div class="avatar-container">
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                {% if session.get('avatar') and session.get('avatar').startswith('/avatar/') %}
                  <img class="avatar" src="{{ session.get('avatar') }}" alt="avatar" onclick="document.getElementById('avatar-upload').click()" title="Click ƒë·ªÉ ƒë·ªïi avatar">
                {% else %}
                  <img class="avatar" src="{{ session.get('avatar') or url_for('static', filename='img/avatar_default.png') }}" alt="avatar" onclick="document.getElementById('avatar-upload').click()" title="Click ƒë·ªÉ ƒë·ªïi avatar">
                {% endif %}
              </div>
              <span class="username">{{ session.get('username') or 'User' }}</span>
              <a class="btn btn-secondary" href="{{ url_for('main.account') }}">T√†i kho·∫£n c·ªßa t√¥i</a>
            </div>
          {% else %}
            
          {% endif %}
        </nav>
      </div>
    </header>

    <main class="container main-content">
      {% block content %}{% endblock %}
    </main>

    <footer class="footer">
      <div class="container">¬© 2024 CINEBOX ¬∑ ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng ¬∑ Li√™n h·ªá</div>
    </footer>

    <script>
    // Header Search Suggestions
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('headerSearchInput');
        const suggestionsContainer = document.getElementById('headerSearchSuggestions');
        const suggestionsList = document.getElementById('headerSuggestionsList');
        
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            console.log('Search input changed:', query);
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                console.log('Fetching suggestions for:', query);
                fetchSuggestions(query);
            }, 300);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });
        
        // Show suggestions when focusing on input
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                suggestionsContainer.style.display = 'block';
            }
        });
        
        function fetchSuggestions(query) {
            console.log('Fetching suggestions for query:', query);
            fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=6`)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Suggestions data:', data);
                    if (data.success) {
                        displaySuggestions(data.suggestions);
                    }
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                });
        }
        
        function displaySuggestions(suggestions) {
            console.log('Displaying suggestions:', suggestions);
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsList.innerHTML = suggestions.map(suggestion => `
                <div class="suggestion-item" onclick="selectHeaderSuggestion('${suggestion.title.replace(/'/g, "\\'")}')">
                    <div class="suggestion-poster" style="background-image: url('${suggestion.poster}')"></div>
                    <div class="suggestion-info">
                        <div class="suggestion-title">${suggestion.title}</div>
                        ${suggestion.year ? `<div class="suggestion-year">${suggestion.year}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            console.log('Suggestions HTML:', suggestionsList.innerHTML);
            suggestionsContainer.style.display = 'block';
        }
        
        // Make selectHeaderSuggestion globally available
        window.selectHeaderSuggestion = function(title) {
            searchInput.value = title;
            suggestionsContainer.style.display = 'none';
            searchInput.form.submit();
        };
    });

    // Avatar upload function
    function uploadAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('avatar', file);
            
            // Show loading
            const avatar = document.querySelector('.avatar');
            const originalSrc = avatar.src;
            avatar.style.opacity = '0.5';
            
            // Upload to server
            fetch('/upload-avatar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update avatar immediately
                    avatar.src = data.avatar_url + '?t=' + new Date().getTime();
                    avatar.style.opacity = '1';
                    
                    // Show success message
                    alert('ƒê·ªïi avatar th√†nh c√¥ng!');
                } else {
                    // Restore original avatar
                    avatar.src = originalSrc;
                    avatar.style.opacity = '1';
                    alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ ƒë·ªïi avatar'));
                }
            })
            .catch(error => {
                // Restore original avatar
                avatar.src = originalSrc;
                avatar.style.opacity = '1';
                console.error('Error:', error);
                alert('L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server');
            });
        }
    }
    </script>
  </body>
  </html>


