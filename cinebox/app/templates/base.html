<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}CineBox{% endblock %}</title>
    {% if session.user_id %}
    <meta name="user-id" content="{{ session.user_id }}">
    {% endif %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon_cinebox.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon_cinebox.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/favicon_cinebox.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        width: 100%;
      }
    </style>
  </head>
  <body class="theme-dark">
    <header class="navbar">
      <div class="container">
        <a href="{{ url_for('main.home') }}" class="logo">Cine<span>Box</span></a>
        <form class="search" action="{{ url_for('main.search') }}" method="GET">
          <div class="search-input-group">
            <input 
              type="text" 
              name="q" 
              placeholder="T√¨m ki·∫øm phim, series.." 
              class="search-input"
              id="headerSearchInput"
              autocomplete="off"
            />
            <button type="submit" class="search-btn">
              <span>üîç</span>
            </button>
          </div>
          
          <!-- Search Suggestions Dropdown -->
          <div class="search-suggestions" id="headerSearchSuggestions" style="display: none;">
            <div class="suggestions-list" id="headerSuggestionsList">
              <!-- Suggestions will be populated by JavaScript -->
            </div>
          </div>
        </form>
        <nav>
          {% if session.get('user_id') %}
            <div class="user-box">
              {% if session.get('role') == 'Admin' %}
                <a class="btn btn-primary" href="{{ url_for('main.admin_dashboard') }}">Admin</a>
              {% endif %}
              <div class="avatar-container">
                <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                {% if session.get('avatar') and session.get('avatar').startswith('/avatar/') %}
                  <img class="avatar" src="{{ session.get('avatar') }}" alt="avatar" onclick="document.getElementById('avatar-upload').click()" title="Click ƒë·ªÉ ƒë·ªïi avatar">
                {% else %}
                  <img class="avatar" src="{{ session.get('avatar') or url_for('static', filename='img/avatar_default.png') }}" alt="avatar" onclick="document.getElementById('avatar-upload').click()" title="Click ƒë·ªÉ ƒë·ªïi avatar">
                {% endif %}
              </div>
              <span class="username">{{ session.get('username') or 'User' }}</span>
              <a class="btn btn-secondary" href="{{ url_for('main.account') }}">T√†i kho·∫£n c·ªßa t√¥i</a>
            </div>
          {% else %}
            
          {% endif %}
        </nav>
      </div>
    </header>

    <main class="container main-content">
      {% block content %}{% endblock %}
    </main>

    <footer class="footer">
      <div class="container">¬© 2025 CINEBOX ¬∑ ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng ¬∑ Li√™n h·ªá</div>
    </footer>

    <script>
    window.CineBox = window.CineBox || {};

    window.CineBox.renderSuggestions = function(groups, container, onSelect) {
        if (!container) return false;
        container.innerHTML = "";
        if (!groups || !groups.length) {
            return false;
        }
        groups.forEach(group => {
            const groupEl = document.createElement('div');
            groupEl.className = 'suggestion-group';
            if (group.label) {
                const label = document.createElement('div');
                label.className = 'suggestion-group-label';
                label.textContent = group.label;
                groupEl.appendChild(label);
            }
            (group.items || []).forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = `suggestion-item match-${item.matchType || 'title'}`;
                
                const poster = document.createElement('div');
                poster.className = 'suggestion-poster';
                poster.style.backgroundImage = `url('${item.poster}')`;
                
                const info = document.createElement('div');
                info.className = 'suggestion-info';
                const titleEl = document.createElement('div');
                titleEl.className = 'suggestion-title';
                titleEl.textContent = item.title;
                info.appendChild(titleEl);
                if (item.year) {
                    const yearEl = document.createElement('div');
                    yearEl.className = 'suggestion-year';
                    yearEl.textContent = item.year;
                    info.appendChild(yearEl);
                }
                if (item.subtitle) {
                    const meta = document.createElement('div');
                    meta.className = 'suggestion-meta';
                    meta.innerHTML = item.subtitle;
                    info.appendChild(meta);
                }
                
                itemEl.appendChild(poster);
                itemEl.appendChild(info);
                itemEl.addEventListener('click', () => onSelect(item));
                groupEl.appendChild(itemEl);
            });
            container.appendChild(groupEl);
        });
        return true;
    };

    document.addEventListener('DOMContentLoaded', function() {
        initHeaderSearchSuggestions();
        initQuickPreview();
    });

    function initHeaderSearchSuggestions() {
        const searchInput = document.getElementById('headerSearchInput');
        const suggestionsContainer = document.getElementById('headerSearchSuggestions');
        const suggestionsList = document.getElementById('headerSuggestionsList');
        if (!searchInput || !suggestionsContainer || !suggestionsList) return;
        
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(searchTimeout);
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(() => fetchSuggestions(query), 250);
        });
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });
        
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                suggestionsContainer.style.display = 'block';
            }
        });
        
        function fetchSuggestions(query) {
            fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=9`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        suggestionsContainer.style.display = 'none';
                        return;
                    }
                    const hasData = window.CineBox.renderSuggestions(
                        data.groups,
                        suggestionsList,
                        (item) => selectHeaderSuggestion(item)
                    );
                    suggestionsContainer.style.display = hasData ? 'block' : 'none';
                })
                .catch(() => {
                    suggestionsContainer.style.display = 'none';
                });
        }
        
        window.selectHeaderSuggestion = function(itemOrTitle) {
            const title = typeof itemOrTitle === 'string' ? itemOrTitle : (itemOrTitle?.title || '');
            if (!title) return;
            searchInput.value = title;
            suggestionsContainer.style.display = 'none';
            searchInput.form?.submit();
        };
    }

    const previewCache = {};
    const previewTimers = new WeakMap();
    const PREVIEW_HOLD_DELAY = 3000;
    let activePreviewCard = null;

    function initQuickPreview() {
        const cards = document.querySelectorAll('[data-preview-id]');
        cards.forEach(card => {
            if (card.dataset.previewBound === 'true') return;
            card.dataset.previewBound = 'true';
            card.addEventListener('pointerenter', handlePreviewHoverStart);
            card.addEventListener('pointerdown', handlePreviewPressStart);
            card.addEventListener('pointerup', handlePreviewPressEnd);
            card.addEventListener('pointercancel', handlePreviewPointerCancel);
            card.addEventListener('pointerleave', handlePreviewPointerLeave);
        });
        window.CineBox.refreshPreviewTargets = initQuickPreview;
    }

    function startPreviewTimer(card) {
        clearPreviewTimer(card);
        const timer = setTimeout(() => {
            previewTimers.delete(card);
            activatePreview(card);
        }, PREVIEW_HOLD_DELAY);
        previewTimers.set(card, timer);
    }

    function handlePreviewHoverStart(event) {
        const card = event.currentTarget;
        if (event.pointerType && event.pointerType !== 'mouse' && event.pointerType !== 'pen') return;
        startPreviewTimer(card);
    }

    function handlePreviewPressStart(event) {
        const card = event.currentTarget;
        const movieId = card.dataset.previewId;
        if (!movieId) return;
        if (event.pointerType && event.pointerType !== 'touch') return;
        if (!event.isPrimary) return;
        startPreviewTimer(card);
    }

    function handlePreviewPressEnd(event) {
        const card = event.currentTarget;
        clearPreviewTimer(card);
    }

    function handlePreviewPointerCancel(event) {
        const card = event.currentTarget;
        clearPreviewTimer(card);
        if (card.dataset.previewActive === 'true') {
            hidePreview(card);
            if (activePreviewCard === card) {
                activePreviewCard = null;
            }
        }
    }

    function handlePreviewPointerLeave(event) {
        const card = event.currentTarget;
        clearPreviewTimer(card);
        if (card.dataset.previewActive === 'true') {
            hidePreview(card);
            if (activePreviewCard === card) {
                activePreviewCard = null;
            }
        }
    }

    function activatePreview(card) {
        const movieId = card.dataset.previewId;
        if (!movieId) return;
        if (activePreviewCard && activePreviewCard !== card) {
            hidePreview(activePreviewCard);
        }
        activePreviewCard = card;
        card.dataset.previewActive = 'true';
        const overlay = ensurePreviewOverlay(card);
        overlay.classList.add('active');
        overlay.innerHTML = `<div class="preview-loading">ƒêang t·∫£i...</div>`;
        getPreviewData(movieId).then(data => {
            if (activePreviewCard !== card) return;
            renderPreviewContent(overlay, data);
        }).catch(() => {
            overlay.innerHTML = `<div class="preview-loading">Kh√¥ng c√≥ preview</div>`;
        });
    }

    function hidePreview(card) {
        const overlay = card.querySelector('.preview-overlay');
        if (overlay) {
            overlay.classList.remove('active');
            overlay.innerHTML = '';
        }
        delete card.dataset.previewActive;
    }

    function clearPreviewTimer(card) {
        const timer = previewTimers.get(card);
        if (timer) {
            clearTimeout(timer);
            previewTimers.delete(card);
        }
    }

    function ensurePreviewOverlay(card) {
        let overlay = card.querySelector('.preview-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'preview-overlay';
            card.appendChild(overlay);
        }
        return overlay;
    }

    function getPreviewData(movieId) {
        if (!previewCache[movieId]) {
            previewCache[movieId] = fetch(`/api/movie-preview/${movieId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) throw new Error('No preview');
                    return data.preview;
                })
                .catch(err => {
                    delete previewCache[movieId];
                    throw err;
                });
        }
        return previewCache[movieId];
    }

    function renderPreviewContent(overlay, preview) {
        overlay.innerHTML = '';
        if (preview.embedUrl) {
            const iframe = document.createElement('iframe');
            iframe.src = preview.embedUrl;
            iframe.allow = "autoplay; encrypted-media";
            iframe.setAttribute('title', preview.title);
            overlay.appendChild(iframe);
        } else if (preview.fallbackImages && preview.fallbackImages.length) {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'preview-fallback';
            imgDiv.style.backgroundImage = `url('${preview.fallbackImages[0]}')`;
            overlay.appendChild(imgDiv);
        } else {
            overlay.innerHTML = `<div class="preview-loading">Kh√¥ng c√≥ preview</div>`;
        }
    }

    // Avatar upload function
    function uploadAvatar(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File qu√° l·ªõn! Vui l√≤ng ch·ªçn file nh·ªè h∆°n 5MB.');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            formData.append('avatar', file);
            
            // Show loading
            const avatar = document.querySelector('.avatar');
            const originalSrc = avatar.src;
            avatar.style.opacity = '0.5';
            
            // Upload to server
            fetch('/upload-avatar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update avatar immediately
                    avatar.src = data.avatar_url + '?t=' + new Date().getTime();
                    avatar.style.opacity = '1';
                    
                    // Show success message
                    alert('ƒê·ªïi avatar th√†nh c√¥ng!');
                } else {
                    // Restore original avatar
                    avatar.src = originalSrc;
                    avatar.style.opacity = '1';
                    alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ ƒë·ªïi avatar'));
                }
            })
            .catch(error => {
                // Restore original avatar
                avatar.src = originalSrc;
                avatar.style.opacity = '1';
                console.error('Error:', error);
                alert('L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server');
            });
        }
    }
    </script>
  </body>
  </html>


