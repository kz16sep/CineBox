{% extends 'base.html' %}
{% block title %}{{ movie.title }} ¬∑ CineBox{% endblock %}
{% block content %}

<!-- Toast Notification -->
<div id="toast" class="toast">
  <div class="toast-content">
    <span id="toast-message"></span>
  </div>
</div>
<section class="detail">
  <!-- Movie Hero Section -->
  <div class="detail-hero">
    <div class="hero-backdrop" style="background-image: url('{{ movie.backdrop }}')"></div>
    <div class="hero-content">
      <div class="movie-poster">
        <!-- Back Button -->
        <button class="back-button" onclick="history.back()" title="Quay v·ªÅ trang tr∆∞·ªõc">
          <span class="back-icon">‚Üê</span>
          <span class="back-text">Quay l·∫°i</span>
        </button>
        <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="poster-img">
      </div>
      <div class="movie-info">
        <h1 class="movie-title">{{ movie.title }}</h1>
        
        <div class="movie-meta">
          {% if movie.year %}<span class="meta-item">üìÖ {{ movie.year }}</span>{% endif %}
          {% if movie.duration %}<span class="meta-item">‚è±Ô∏è {{ movie.duration }}</span>{% endif %}
          {% if movie.genres %}<span class="meta-item">üé≠ {{ ', '.join(movie.genres|map(attribute='name')) }}</span>{% endif %}
          <span class="meta-item">
            <span id="avg-rating-display">‚≠ê 0.0</span>
            <span id="rating-count">(0 ƒë√°nh gi√°)</span>
          </span>
        </div>
        
        <div class="movie-actions">
          <a class="btn btn-primary btn-watch" href="{{ url_for('main.watch', movie_id=movie.id) }}">
            ‚ñ∂ Xem phim
          </a>
          <a class="btn btn-secondary btn-trailer" href="{{ url_for('main.trailer', movie_id=movie.id) }}">
            üé¨ Xem trailer
          </a>
          <button id="watchlistBtn" class="btn btn-secondary" onclick="toggleWatchlist({{ movie.id }})">
            <span id="watchlistIcon">üìã</span>
            <span id="watchlistText">Xem sau</span>
          </button>
          <button id="favoriteBtn" class="btn btn-secondary" onclick="toggleFavorite({{ movie.id }})">
            <span id="favoriteIcon">ü§ç</span>
            <span id="favoriteText">Y√™u th√≠ch</span>
          </button>
        </div>
        
        <!-- Rating Section -->
        <div class="rating-section">
          <h3>ƒê√°nh gi√° phim</h3>
          <div class="rating-container">
            <div class="star-rating" id="star-rating">
              <span class="star" data-rating="1">‚òÖ</span>
              <span class="star" data-rating="2">‚òÖ</span>
              <span class="star" data-rating="3">‚òÖ</span>
              <span class="star" data-rating="4">‚òÖ</span>
              <span class="star" data-rating="5">‚òÖ</span>
            </div>
            <div class="rating-info">
              <span id="user-rating-text">Ch∆∞a ƒë√°nh gi√°</span>
              <button id="delete-rating-btn" class="btn-delete-rating" style="display: none;">X√≥a ƒë√°nh gi√°</button>
            </div>
          </div>
        </div>
        
        <!-- Movie Genres Section -->
        {% if movie.genres %}
        <div class="movie-genres-section">
          <h3>Th·ªÉ lo·∫°i:</h3>
          <div class="genre-tags">
            {% for genre in movie.genres %}
              <a href="{{ url_for('main.genre_page', genre_slug=genre.slug) }}" 
                 class="genre-tag">
                {{ genre.name }}
              </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}
        
        {% if movie.description %}
        <div class="movie-description">
          <h3>N·ªôi dung phim</h3>
          <p>{{ movie.description }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Related Movies Section -->
{% if related %}
<section class="related-section">
  <h3>üé¨ Phim li√™n quan & G·ª£i √Ω cho b·∫°n</h3>
  <div class="cards-container">
    <div class="cards" id="relatedCards">
    {% for m in related %}
    <div class="card">
      <a href="{{ url_for('main.detail', movie_id=m.movieId) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ m.posterUrl }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
          <div class="card-meta">
            {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
            {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
          </div>
          {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
          {% if m.similarity %}
          <div class="similarity-score">
            <span class="similarity-label">ƒê·ªô t∆∞∆°ng ƒë·ªìng:</span>
            <span class="similarity-value">{{ "%.1f"|format(m.similarity * 100) }}%</span>
          </div>
          {% endif %}
          <div class="movie-rating" data-movie-id="{{ m.id }}">
            <span class="rating-stars">‚≠ê 0.0</span>
            <!-- <span class="rating-count">(0)</span> -->
          </div>
        </div>
      </a>
    </div>
    {% endfor %}
    </div>
  </div>
  
  <!-- Pagination cho related movies -->
  {% if related_pagination and related_pagination.pages > 1 %}
  <div class="pagination">
    <div class="pagination-info">
      <span>Trang {{ related_pagination.page }} / {{ related_pagination.pages }}</span>
    </div>
    <div class="pagination-controls">
      {% if related_pagination.has_prev %}
        <a href="{{ url_for('main.detail', movie_id=movie_id, related_page=related_pagination.prev_num) }}" class="btn-pagination">‚Äπ Tr∆∞·ªõc</a>
      {% endif %}
      
      <div class="page-numbers">
        {% for page_num in range(1, related_pagination.pages + 1) %}
          {% if page_num == related_pagination.page %}
            <span class="page-number current">{{ page_num }}</span>
          {% elif page_num <= 3 or page_num > related_pagination.pages - 3 or (page_num >= related_pagination.page - 1 and page_num <= related_pagination.page + 1) %}
            <a href="{{ url_for('main.detail', movie_id=movie_id, related_page=page_num) }}" class="page-number">{{ page_num }}</a>
          {% elif page_num == 4 or page_num == related_pagination.pages - 3 %}
            <span class="page-ellipsis">...</span>
          {% endif %}
        {% endfor %}
      </div>
      
      {% if related_pagination.has_next %}
        <a href="{{ url_for('main.detail', movie_id=movie_id, related_page=related_pagination.next_num) }}" class="btn-pagination">Ti·∫øp ‚Ä∫</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>
{% endif %}

<style>
/* Toast Notification Styles */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #2d3748;
  color: white;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  transform: translateX(400px);
  transition: transform 0.3s ease-in-out;
  max-width: 300px;
  border-left: 4px solid #48bb78;
}

.toast.show {
  transform: translateX(0);
}

.toast-content {
  display: flex;
  align-items: center;
  gap: 8px;
}

.toast.success {
  border-left-color: #48bb78;
}

.toast.error {
  border-left-color: #f56565;
}

/* Back Button Styles */
.back-button {
  position: absolute;
  top: 15px;
  left: 15px;
  z-index: 10;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 25px;
  padding: 10px 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.back-button:hover {
  background: rgba(59, 130, 246, 0.9);
  border-color: #3b82f6;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

.back-icon {
  font-size: 18px;
  font-weight: bold;
}

.back-text {
  font-size: 14px;
}

/* Detail Hero Styles */
.detail-hero {
  position: relative;
  min-height: 60vh;
  overflow: hidden;
  margin-bottom: 40px;
}

.hero-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  filter: blur(10px);
  opacity: 0.3;
  z-index: 1;
}

.hero-content {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  gap: 30px;
  padding: 40px;
  min-height: 60vh;
}

.movie-poster {
  flex-shrink: 0;
}

.poster-img {
  width: 300px;
  height: 450px;
  object-fit: cover;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}

.movie-info {
  flex: 1;
  color: white;
}

.movie-title {
  font-size: 3rem;
  font-weight: bold;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
}

.movie-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 30px;
  font-size: 1.1rem;
}

.meta-item {
  background: rgba(255, 255, 255, 0.1);
  padding: 8px 16px;
  border-radius: 20px;
  backdrop-filter: blur(10px);
}

.movie-actions {
  display: flex;
  gap: 15px;
  margin-bottom: 30px;
}

.btn-watch {
  font-size: 1.2rem;
  padding: 15px 30px;
  background: #e50914;
  border: none;
  border-radius: 8px;
  color: white;
  text-decoration: none;
  font-weight: bold;
  transition: all 0.3s ease;
}

.btn-watch:hover {
  background: #f40612;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(229, 9, 20, 0.4);
}

.btn-secondary {
  font-size: 1.1rem;
  padding: 15px 25px;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 8px;
  color: white;
  text-decoration: none;
  font-weight: bold;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-secondary.favorited {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  border-color: #ff6b6b;
  color: white;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}

.btn-secondary.favorited:hover {
  background: linear-gradient(135deg, #ff7b7b, #ff6b24);
  border-color: #ff7b7b;
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
  transform: translateY(-2px);
}

.btn-secondary.watchlisted {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  border-color: #4CAF50;
  color: white;
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.btn-secondary.watchlisted:hover {
  background: linear-gradient(135deg, #45a049, #4CAF50);
  border-color: #4CAF50;
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
  transform: translateY(-2px);
}

.movie-description {
  max-width: 800px;
}

.movie-description h3 {
  font-size: 1.5rem;
  margin-bottom: 15px;
  color: #fff;
}

.movie-description p {
  font-size: 1.1rem;
  line-height: 1.6;
  color: #ccc;
}

/* Related Movies Styles */
.related-section {
  margin: 40px 0;
}

.related-section h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.cards {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  padding: 10px 0 20px 0;
  scrollbar-width: thin;
  scrollbar-color: #4CAF50 #2a2a2a;
}

/* Custom scrollbar for WebKit browsers (Chrome, Safari, Edge) */
.cards::-webkit-scrollbar {
  height: 8px;
}

.cards::-webkit-scrollbar-track {
  background: #2a2a2a;
  border-radius: 4px;
  box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.3);
}

.cards::-webkit-scrollbar-thumb {
  background: linear-gradient(90deg, #4CAF50, #45a049);
  border-radius: 4px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.cards::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(90deg, #45a049, #4CAF50);
  box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
  transform: scaleY(1.2);
}

.cards::-webkit-scrollbar-thumb:active {
  background: linear-gradient(90deg, #3d8b40, #4CAF50);
}

.cards::-webkit-scrollbar-corner {
  background: #2a2a2a;
}

/* Smooth scrolling */
.cards {
  scroll-behavior: smooth;
}

/* Cards container with scroll buttons */
.cards-container {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

.scroll-btn {
  background: rgba(76, 175, 80, 0.8);
  border: none;
  color: white;
  font-size: 24px;
  font-weight: bold;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.scroll-btn:hover {
  background: rgba(76, 175, 80, 1);
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.scroll-btn:active {
  transform: scale(0.95);
}

.scroll-left {
  position: absolute;
  left: -50px;
}

.scroll-right {
  position: absolute;
  right: -50px;
}

/* Hide scroll buttons on mobile */
@media (max-width: 768px) {
  .scroll-btn {
    display: none;
  }
  
  .cards-container {
    gap: 0;
  }
}

.card {
  flex: 0 0 250px;
  text-decoration: none;
  color: inherit;
  transition: transform 0.3s ease;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  overflow: hidden;
  backdrop-filter: blur(10px);
}

.card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.poster {
  width: 100%;
  height: 320px;
  background-size: cover;
  background-position: center;
}

.card-content {
  padding: 15px;
}

.card-title {
  color: #fff;
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 1rem;
  line-height: 1.3;
}

.similarity-score {
  margin: 8px 0;
  font-size: 0.9rem;
}

.similarity-label {
  color: #888;
}

.similarity-value {
  color: #4CAF50;
  font-weight: bold;
}

.stars {
  color: #ffd700;
  font-size: 0.9rem;
  margin-top: 5px;
}

/* Responsive */
@media (max-width: 768px) {
  .hero-content {
    flex-direction: column;
    text-align: center;
    padding: 20px;
  }
  
  .poster-img {
    width: 200px;
    height: 300px;
  }
  
  .movie-title {
    font-size: 2rem;
  }
  
  .movie-actions {
    justify-content: center;
  }
  
  .cards {
    gap: 15px;
  }
  
  .card {
    flex: 0 0 200px;
  }
  
  .poster {
    height: 250px;
  }
}

/* Movie Genres Section - Enhanced */
.movie-genres-section {
  margin: 40px 0;
  padding: 25px 0;
  border-top: 2px solid rgba(59, 130, 246, 0.3);
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05));
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.movie-genres-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
  animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.movie-genres-section h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.4em;
  font-weight: 700;
  text-align: left;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.movie-genres-section h3::after {
  content: 'üé¨';
  margin-left: 10px;
  font-size: 1.2em;
}

.genre-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: flex-start;
  padding: 0 20px;
}

.genre-tag {
  background: linear-gradient(135deg, #1e293b, #334155);
  color: #e2e8f0;
  padding: 12px 24px;
  border-radius: 30px;
  text-decoration: none;
  font-size: 1em;
  font-weight: 600;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.genre-tag::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.genre-tag:hover::before {
  left: 100%;
}

.genre-tag:hover {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: #fff;
  transform: translateY(-3px) scale(1.05);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
  border-color: #3b82f6;
}

.genre-tag:active {
  transform: translateY(-1px) scale(1.02);
}

/* Glow effect for genre tags */
.genre-tag:hover {
  box-shadow: 
    0 8px 25px rgba(59, 130, 246, 0.4),
    0 0 20px rgba(59, 130, 246, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

/* Rating Section Styles */
.rating-section {
  margin: 30px 0;
  padding: 25px 0;
  border-top: 2px solid rgba(255, 193, 7, 0.3);
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 152, 0, 0.05));
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.rating-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #ffc107, #ff9800, #ff5722, #e91e63);
  animation: shimmer 3s ease-in-out infinite;
}

.rating-section h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.4em;
  font-weight: 700;
  text-align: left;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.rating-section h3::after {
  content: '‚≠ê';
  margin-left: 10px;
  font-size: 1.2em;
}

.rating-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  align-items: flex-start;
}

.star-rating {
  display: flex;
  gap: 5px;
  font-size: 2rem;
  cursor: pointer;
}

.star {
  color: #666;
  transition: all 0.3s ease;
  user-select: none;
  position: relative;
}

.star.active {
  color: #ffc107 !important;
  transform: scale(1.1);
  text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.star:hover {
  color: #ffc107;
  transform: scale(1.1);
  text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.star:hover ~ .star:not(.active) {
  color: #666;
}

.rating-info {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}

#user-rating-text {
  color: #fff;
  font-size: 1.1rem;
  font-weight: 600;
}

.btn-delete-rating {
  background: rgba(244, 67, 54, 0.8);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-delete-rating:hover {
  background: rgba(244, 67, 54, 1);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
}

#avg-rating-display {
  color: #ffc107;
  font-weight: bold;
  font-size: 1.1rem;
}

#rating-count {
  color: #ccc;
  font-size: 0.9rem;
  margin-left: 5px;
}


/* Responsive */
@media (max-width: 768px) {
  .rating-section {
    margin: 20px 0;
    padding: 20px 0;
  }
  
  .star-rating {
    font-size: 1.8rem;
  }
  
  .rating-container {
    align-items: center;
  }
  
  .rating-info {
    justify-content: center;
    text-align: center;
  }
  
  .comments-section {
    margin: 30px 0;
    padding: 20px 0;
  }
  
  .comment-form {
    padding: 15px;
  }
  
  .comment-item {
    padding: 15px;
  }
  
  .replies {
    margin-left: 10px;
    padding-left: 10px;
  }
}

/* Fix text color and remove underlines for related movies cards */
.card-link {
  text-decoration: none !important;
  color: inherit !important;
}

.card-link:hover {
  text-decoration: none !important;
  color: inherit !important;
}

.card-title {
  color: #fff !important;
}

.card-meta {
  color: #fff !important;
}

.card-genres {
  color: #fff !important;
}

.movie-rating {
  color: #fff !important;
}

/* Fix pagination text color */
.pagination-info {
  color: #fff !important;
}

.pagination-info span {
  color: #fff !important;
}

.btn-pagination {
  color: #fff !important;
}

.page-number {
  color: #fff !important;
}

.page-number.current {
  color: #fff !important;
}

.page-ellipsis {
  color: #fff !important;
}

</style>

<script>
// Toast notification functions
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  
  toastMessage.textContent = message;
  toast.className = `toast ${type}`;
  toast.classList.add('show');
  
  // Auto hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function addToWatchlist(movieId) {
  fetch(`/add-watchlist/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('‚úÖ ' + data.message, 'success');
    } else {
      showToast('‚ùå ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi th√™m v√†o danh s√°ch xem sau', 'error');
  });
}

function addToFavorites(movieId) {
  fetch(`/add-favorite/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast('‚úÖ ' + data.message, 'success');
    } else {
      showToast('‚ùå ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi th√™m v√†o danh s√°ch y√™u th√≠ch', 'error');
  });
}

function toggleFavorite(movieId) {
  fetch(`/toggle-favorite/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateFavoriteButton(data.is_favorite);
      showToast('‚úÖ ' + data.message, 'success');
    } else {
      showToast('‚ùå ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i y√™u th√≠ch', 'error');
  });
}

function updateFavoriteButton(isFavorite) {
  const favoriteIcon = document.getElementById('favoriteIcon');
  const favoriteText = document.getElementById('favoriteText');
  const favoriteBtn = document.getElementById('favoriteBtn');
  
  if (!favoriteIcon || !favoriteText || !favoriteBtn) {
    console.warn('Favorite button elements not found');
    return;
  }
  
  if (isFavorite) {
    favoriteIcon.textContent = '‚ù§Ô∏è';
    favoriteText.textContent = 'ƒê√£ y√™u th√≠ch';
    favoriteBtn.classList.add('favorited');
  } else {
    favoriteIcon.textContent = 'ü§ç';
    favoriteText.textContent = 'Y√™u th√≠ch';
    favoriteBtn.classList.remove('favorited');
  }
}

function checkFavoriteStatus(movieId) {
  fetch(`/check-favorite/${movieId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateFavoriteButton(data.is_favorite);
    }
  })
  .catch(error => {
    console.error('Error checking favorite status:', error);
  });
}

function toggleWatchlist(movieId) {
  fetch(`/toggle-watchlist/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateWatchlistButton(data.is_watchlist);
      showToast('‚úÖ ' + data.message, 'success');
    } else {
      showToast('‚ùå ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('‚ùå C√≥ l·ªói x·∫£y ra khi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i xem sau', 'error');
  });
}

function updateWatchlistButton(isWatchlist) {
  const watchlistIcon = document.getElementById('watchlistIcon');
  const watchlistText = document.getElementById('watchlistText');
  const watchlistBtn = document.getElementById('watchlistBtn');
  
  if (!watchlistIcon || !watchlistText || !watchlistBtn) {
    console.warn('Watchlist button elements not found');
    return;
  }
  
  if (isWatchlist) {
    watchlistIcon.textContent = '‚úÖ';
    watchlistText.textContent = 'ƒê√£ th√™m';
    watchlistBtn.classList.add('watchlisted');
  } else {
    watchlistIcon.textContent = 'üìã';
    watchlistText.textContent = 'Xem sau';
    watchlistBtn.classList.remove('watchlisted');
  }
}

function checkWatchlistStatus(movieId) {
  fetch(`/check-watchlist/${movieId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateWatchlistButton(data.is_watchlist);
    }
  })
  .catch(error => {
    console.error('Error checking watchlist status:', error);
  });
}

// Scroll cards function
function scrollCards(direction) {
  const cardsContainer = document.getElementById('relatedCards');
  const scrollAmount = 300; // pixels to scroll
  
  if (direction === 'left') {
    cardsContainer.scrollBy({
      left: -scrollAmount,
      behavior: 'smooth'
    });
  } else if (direction === 'right') {
    cardsContainer.scrollBy({
      left: scrollAmount,
      behavior: 'smooth'
    });
  }
}

// Auto-hide scroll buttons based on scroll position
document.addEventListener('DOMContentLoaded', function() {
  const cardsContainer = document.getElementById('relatedCards');
  const leftBtn = document.querySelector('.scroll-left');
  const rightBtn = document.querySelector('.scroll-right');
  
  if (cardsContainer && leftBtn && rightBtn) {
    function updateScrollButtons() {
      const scrollLeft = cardsContainer.scrollLeft;
      const maxScroll = cardsContainer.scrollWidth - cardsContainer.clientWidth;
      
      // Show/hide left button
      if (scrollLeft <= 0) {
        leftBtn.style.opacity = '0.3';
        leftBtn.style.pointerEvents = 'none';
      } else {
        leftBtn.style.opacity = '1';
        leftBtn.style.pointerEvents = 'auto';
      }
      
      // Show/hide right button
      if (scrollLeft >= maxScroll - 10) { // 10px tolerance
        rightBtn.style.opacity = '0.3';
        rightBtn.style.pointerEvents = 'none';
      } else {
        rightBtn.style.opacity = '1';
        rightBtn.style.pointerEvents = 'auto';
      }
    }
    
    // Update buttons on scroll
    cardsContainer.addEventListener('scroll', updateScrollButtons);
    
    // Initial update
    updateScrollButtons();
  }
  
  // Check favorite and watchlist status when page loads
  const movieId = {{ movie.id }};
  if (movieId) {
    checkFavoriteStatus(movieId);
    checkWatchlistStatus(movieId);
    getRating(movieId);
  }
  
  // Load ratings for all related movies
  loadAllRatings();
  
  // Star rating event listeners
  const stars = document.querySelectorAll('.star');
  stars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.dataset.rating);
      // Update stars immediately on click
      updateStarRating(rating);
      // Then submit to server
      submitRating(movieId, rating);
    });
    
    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.dataset.rating);
      updateStarRating(rating);
    });
  });
  
  // Star rating container events
  const starRating = document.getElementById('star-rating');
  
  starRating.addEventListener('mouseleave', function() {
    // Restore to user's actual rating
    updateStarRating(currentUserRating);
  });
  
  // Delete rating button
  const deleteBtn = document.getElementById('delete-rating-btn');
  deleteBtn.addEventListener('click', function() {
    deleteRating(movieId);
  });
   
});

// Rating functions
function submitRating(movieId, rating) {
  fetch(`/submit-rating/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ rating: rating })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      updateRatingDisplay(data.user_rating, data.avg_rating, data.total_ratings);
      updateStarRating(data.user_rating);
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi ƒë√°nh gi√°', 'error');
  });
}

function deleteRating(movieId) {
  fetch(`/delete-rating/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      updateRatingDisplay(0, data.avg_rating, data.total_ratings);
      updateStarRating(0);
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi x√≥a ƒë√°nh gi√°', 'error');
  });
}

function getRating(movieId) {
  console.log('getRating called for movieId:', movieId);
  fetch(`/get-rating/${movieId}`)
  .then(response => response.json())
  .then(data => {
    console.log('Rating data received:', data);
    if (data.success) {
      console.log('User rating:', data.user_rating);
      updateRatingDisplay(data.user_rating, data.avg_rating, data.total_ratings);
      updateStarRating(data.user_rating);
    }
  })
  .catch(error => {
    console.error('Error getting rating:', error);
  });
}

function updateRatingDisplay(userRating, avgRating, totalRatings) {
  const avgRatingDisplay = document.getElementById('avg-rating-display');
  const ratingCount = document.getElementById('rating-count');
  const userRatingText = document.getElementById('user-rating-text');
  const deleteBtn = document.getElementById('delete-rating-btn');
  
  avgRatingDisplay.textContent = `‚≠ê ${avgRating}`;
  ratingCount.textContent = `(${totalRatings} ƒë√°nh gi√°)`;
  
  if (userRating > 0) {
    userRatingText.textContent = `B·∫°n ƒë√£ ƒë√°nh gi√°: ${userRating} sao`;
    deleteBtn.style.display = 'inline-block';
  } else {
    userRatingText.textContent = 'Ch∆∞a ƒë√°nh gi√°';
    deleteBtn.style.display = 'none';
  }
}

let currentUserRating = 0; // Track the user's actual rating

function updateStarRating(rating) {
  console.log('updateStarRating called with rating:', rating);
  const stars = document.querySelectorAll('.star');
  stars.forEach((star) => {
    const starRating = parseInt(star.dataset.rating);
    if (starRating <= rating) {
      star.classList.add('active');
      console.log(`Star ${starRating}: adding active class`);
    } else {
      star.classList.remove('active');
      console.log(`Star ${starRating}: removing active class`);
    }
  });
  
  // Verify the state after update
  const activeStars = document.querySelectorAll('.star.active');
  console.log(`After update: ${activeStars.length} stars are active`);
  
  // Store the rating if it's from API
  if (rating > 0) {
    currentUserRating = rating;
  }
}


// Rating functions for similar movies
function loadAllRatings() {
  console.log('loadAllRatings called');
  const ratingElements = document.querySelectorAll('.movie-rating[data-movie-id]');
  console.log('Found rating elements:', ratingElements.length);
  ratingElements.forEach(element => {
    const movieId = element.dataset.movieId;
    console.log('Processing movie ID:', movieId);
    loadMovieRating(movieId, element);
  });
}

function loadMovieRating(movieId, element) {
  console.log('Loading rating for movie:', movieId, 'element:', element);
  fetch(`/get-rating/${movieId}`)
  .then(response => response.json())
  .then(data => {
    console.log('Rating data received:', data);
    if (data.success) {
      const ratingStars = element.querySelector('.rating-stars');
      const ratingCount = element.querySelector('.rating-count');
      
      console.log('Found elements:', ratingStars, ratingCount);
      
      if (ratingStars && ratingCount) {
        ratingStars.textContent = `‚≠ê ${data.avg_rating}`;
        ratingCount.textContent = `(${data.total_ratings})`;
        console.log('Updated rating display for movie', movieId);
      } else {
        console.error('Could not find rating elements for movie', movieId);
      }
    } else {
      console.log('API returned success: false for movie', movieId);
    }
  })
  .catch(error => {
    console.error('Error loading rating for movie', movieId, ':', error);
  });
}

</script>
{% endblock %}


