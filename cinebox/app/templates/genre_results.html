{% extends 'base.html' %}
{% block title %}{{ genre_name }} ¬∑ CineBox{% endblock %}
{% block content %}
<style>
/* Gi·ªØ thanh t√¨m ki·∫øm hi·ªÉn th·ªã tr√™n trang th·ªÉ lo·∫°i */
.navbar .search {
  display: flex;
  flex: 1;
}

/* ƒê·∫£m b·∫£o thanh t√¨m ki·∫øm c√≥ k√≠ch th∆∞·ªõc ƒë·∫ßy ƒë·ªß */
.navbar .search-input-group {
  width: 100%;
}

.navbar .search-input {
  flex: 1;
  min-width: 300px;
}
</style>

<!-- Genre Filter Menu -->
<section class="genre-filter">
  <div class="genre-filter-container">
    <h3>üé¨ L·ªçc theo th·ªÉ lo·∫°i</h3>
    <div class="genre-buttons">
      <a href="{{ url_for('main.home') }}" 
         class="genre-btn"
         data-genre="all">
        T·∫•t c·∫£
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='action') }}" 
         class="genre-btn {{ 'active' if genre_slug == 'action' else '' }}"
         data-genre="action">
        üé¨ Action
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='adventure') }}" 
         class="genre-btn {{ 'active' if genre_slug == 'adventure' else '' }}"
         data-genre="adventure">
        üó∫Ô∏è Adventure
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='comedy') }}" 
         class="genre-btn {{ 'active' if genre_slug == 'comedy' else '' }}"
         data-genre="comedy">
        üòÇ Comedy
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='horror') }}" 
         class="genre-btn {{ 'active' if genre_slug == 'horror' else '' }}"
         data-genre="horror">
        üëª Horror
      </a>
    </div>
  </div>
</section>

<div class="genre-container">
  <div class="genre-header">
    <h1>üé¨ {{ genre_name }} Movies</h1>
    {% if movies %}
      <p class="genre-results-info">
        Found {{ total_results }} {{ genre_name.lower() }} movies
      </p>
    {% endif %}
  </div>
  
  {% if movies %}
    <div class="cards movies-grid">
      {% for m in movies %}
      <a class="card" href="{{ url_for('main.detail', movie_id=m.id) }}">
        <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
        <div class="card-meta">
          <span class="upload-time">Movie {{ m.id }}</span>
        </div>
          <div class="movie-rating" data-movie-id="{{ m.id }}">
            <span class="rating-stars">‚≠ê 0.0</span>
            <span class="rating-count">(0)</span>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if pagination and pagination.pages > 1 %}
    <div class="pagination">
      <div class="pagination-info">
        <span>Trang {{ pagination.page }} / {{ pagination.pages }}</span>
        <span>({{ pagination.total }} phim)</span>
      </div>
      
      <div class="pagination-controls">
        {% if pagination.has_prev %}
          <a href="{{ url_for('main.genre_page', genre_slug=genre_slug, page=pagination.prev_num) }}" class="btn-pagination">
            ‚Üê Trang tr∆∞·ªõc
          </a>
        {% else %}
          <span class="btn-pagination" style="opacity: 0.5; cursor: not-allowed;">‚Üê Trang tr∆∞·ªõc</span>
        {% endif %}
        
        <span class="page-info">Trang {{ pagination.page }} / {{ pagination.pages }}</span>
        
        {% if pagination.has_next %}
          <a href="{{ url_for('main.genre_page', genre_slug=genre_slug, page=pagination.next_num) }}" class="btn-pagination">
            Trang sau ‚Üí
          </a>
        {% else %}
          <span class="btn-pagination" style="opacity: 0.5; cursor: not-allowed;">Trang sau ‚Üí</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  {% else %}
    <div class="no-results">
      <div class="no-results-icon">üé¨</div>
      <h2>No Movies Found</h2>
      <p>No movies found in <strong>{{ genre_name }}</strong> genre</p>
      <a href="{{ url_for('main.home') }}" class="btn btn-primary">Back to Home</a>
    </div>
  {% endif %}
</div>

<style>
.genre-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.genre-header {
  text-align: center;
  margin-bottom: 30px;
}

.genre-header h1 {
  font-size: 2.5rem;
  color: var(--text-primary);
  margin-bottom: 10px;
}

.genre-results-info {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

.no-results {
  text-align: center;
  padding: 60px 20px;
}

.no-results-icon {
  font-size: 4rem;
  margin-bottom: 20px;
}

.no-results h2 {
  color: var(--text-primary);
  margin-bottom: 10px;
}

.no-results p {
  color: var(--text-secondary);
  margin-bottom: 30px;
}

/* Pagination Styles */
.pagination {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.pagination-info {
  color: #fff !important;
  font-size: 0.9em;
}

.pagination-info span {
  color: #fff !important;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.btn-pagination {
  background: var(--primary);
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.9em;
  transition: all 0.2s ease;
  border: none;
  cursor: pointer;
}

.btn-pagination:hover {
  background: var(--primary-2);
  color: white;
  text-decoration: none;
  transform: translateY(-1px);
}

.page-numbers {
  display: flex;
  gap: 5px;
  align-items: center;
}

.page-number {
  padding: 8px 12px;
  border-radius: 6px;
  text-decoration: none;
  color: #fff !important;
  background: var(--panel);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transition: all 0.2s ease;
  min-width: 40px;
  text-align: center;
}

.page-number:hover {
  background: var(--primary);
  color: white;
  text-decoration: none;
}

.page-number.current {
  background: var(--primary);
  color: #fff !important;
  font-weight: bold;
}

.page-ellipsis {
  color: #fff !important;
  padding: 8px 4px;
}

/* Loading state */
.movies-grid.loading {
  opacity: 0.6;
  pointer-events: none;
}

.movies-grid.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px;
  height: 40px;
  border: 3px solid var(--primary);
  border-top: 3px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
  .genre-header h1 {
    font-size: 2rem;
  }
  
  .genre-container {
    padding: 15px;
  }
}

.movie-rating {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 5px;
  font-size: 0.9rem;
}

.rating-stars {
  color: #ffc107;
  font-weight: bold;
}

.rating-count {
  color: #ccc;
  font-size: 0.8rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Attach genre filter listeners
    attachGenreFilterListeners();
    
    // Attach pagination listeners
    attachPaginationListeners();
    
    // Load ratings for all movies
    // loadAllRatings(); // disabled for consistent server-rendered ratings
});

// Rating functions
function loadAllRatings() {
  const ratingElements = document.querySelectorAll('.movie-rating[data-movie-id]');
  ratingElements.forEach(element => {
    const movieId = element.dataset.movieId;
    loadMovieRating(movieId, element);
  });
}

function loadMovieRating(movieId, element) {
  fetch(`/get-rating/${movieId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const ratingStars = element.querySelector('.rating-stars');
      const ratingCount = element.querySelector('.rating-count');
      const normalizedAvg = (data.avgRating ?? data.avg_rating ?? 0);
      const normalizedCount = (data.ratingCount ?? data.total_ratings ?? 0);
      
      ratingStars.textContent = `‚≠ê ${normalizedAvg}`;
      ratingCount.textContent = `(${normalizedCount})`;
    }
  })
  .catch(error => {
    console.error('Error loading rating for movie', movieId, ':', error);
  });
}

function attachGenreFilterListeners() {
    const genreLinks = document.querySelectorAll('.genre-btn');
    
    genreLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const genre = this.getAttribute('data-genre');
            
            // Remove active class from all buttons
            genreLinks.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // N·∫øu l√† "All" th√¨ chuy·ªÉn v·ªÅ trang ch·ªß
            if (genre === 'all') {
                // Chuy·ªÉn trang b√¨nh th∆∞·ªùng
                return;
            } else {
                // C√°c th·ªÉ lo·∫°i kh√°c: chuy·ªÉn trang b√¨nh th∆∞·ªùng
                return;
            }
        });
    });
}

function attachPaginationListeners() {
    const paginationLinks = document.querySelectorAll('.pagination-controls a');
    
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const url = this.href;
            
            // Show loading indicator
            showLoading();
            
            // Add loading class to movies grid
            const moviesGrid = document.querySelector('.movies-grid');
            if (moviesGrid) {
                moviesGrid.classList.add('loading');
            }
            
            // Fetch new page content
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Parse the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update movies grid
                    const newMoviesGrid = doc.querySelector('.movies-grid');
                    const currentMoviesGrid = document.querySelector('.movies-grid');
                    if (newMoviesGrid && currentMoviesGrid) {
                        currentMoviesGrid.innerHTML = newMoviesGrid.innerHTML;
                    }
                    
                    // Update pagination
                    const newPagination = doc.querySelector('.pagination');
                    const currentPagination = document.querySelector('.pagination');
                    if (newPagination && currentPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                        // Re-attach event listeners to new pagination links
                        attachPaginationListeners();
                    }
                    
                    // Update page info
                    const newPageInfo = doc.querySelector('.page-info');
                    const currentPageInfo = document.querySelector('.page-info');
                    if (newPageInfo && currentPageInfo) {
                        currentPageInfo.innerHTML = newPageInfo.innerHTML;
                    }
                    
                    // Update genre results info
                    const newGenreInfo = doc.querySelector('.genre-results-info');
                    const currentGenreInfo = document.querySelector('.genre-results-info');
                    if (newGenreInfo && currentGenreInfo) {
                        currentGenreInfo.innerHTML = newGenreInfo.innerHTML;
                    }
                    
                    // Scroll to top of movies section
                    const moviesSection = document.querySelector('.genre-container');
                    if (moviesSection) {
                        moviesSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                    // Fallback to normal page reload
                    window.location.href = url;
                });
        });
    });
}

function showLoading() {
    // Create loading overlay if it doesn't exist
    let loading = document.getElementById('loading-overlay');
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading-overlay';
        loading.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        `;
        loading.innerHTML = 'Loading...';
        document.body.appendChild(loading);
    }
    loading.style.display = 'flex';
}

function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading) {
        loading.style.display = 'none';
    }
}
</script>
{% endblock %}
