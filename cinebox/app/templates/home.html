{% extends 'base.html' %}
{% block title %}{% if genre_filter %}{{ genre_filter }} Â· CineBox{% else %}Trang chá»§ Â· CineBox{% endif %}{% endblock %}
{% block content %}
<section class="hero">
  <div class="hero-carousel">
    {% if carousel_movies %}
      {% for movie in carousel_movies %}
      <div class="hero-slide {{ 'active' if loop.first else '' }}" data-slide="{{ loop.index0 }}">
        <div class="hero-backdrop" style="background-image: url('{{ movie.backdrop }}')"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-text">
            <span class="badge">{% if genre_filter %}{{ genre_filter }}{% else %}NEW{% endif %}</span>
            <h1>{{ movie.title }}</h1>
            <p class="hero-description">{{ movie.description }}</p>
            <div class="hero-actions">
              <a class="btn btn-primary" href="{{ url_for('main.watch', movie_id=movie.id) }}">
                <span class="btn-icon">â–¶</span> Xem ngay
              </a>
              <a class="btn btn-secondary" href="{{ url_for('main.detail', movie_id=movie.id) }}">
                <span class="btn-icon">+</span> ThÃªm vÃ o danh sÃ¡ch
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Fallback -->
      <div class="hero-slide active">
        <div class="hero-backdrop" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-text">
            <span class="badge">NEW</span>
            <h1>CineBox</h1>
            <p class="hero-description">KhÃ¡m phÃ¡ tháº¿ giá»›i Ä‘iá»‡n áº£nh.</p>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  
  {% if carousel_movies and carousel_movies|length > 1 %}
  <button class="carousel-btn prev-btn" onclick="changeSlide(-1)">â€¹</button>
  <button class="carousel-btn next-btn" onclick="changeSlide(1)">â€º</button>
  {% endif %}
</section>

<!-- Genre Filter Menu -->
<section class="genre-filter">
  <div class="genre-filter-container">
    <h3>ğŸ¬ Thá»ƒ loáº¡i</h3>
    <div class="genre-buttons">
      <a href="{{ url_for('main.home') }}" class="genre-btn {{ 'active' if not genre_filter else '' }}">ğŸ  Trang chá»§</a>
      {% for genre in all_genres %}
        <a href="{{ url_for('main.home', genre=genre) }}" class="genre-btn {{ 'active' if genre_filter == genre else '' }}">{{ genre }}</a>
      {% endfor %}
    </div>
  </div>
</section>

<!-- 1. Phim má»›i nháº¥t (Grid 10 items) -->
{% if not genre_filter %}
<section>
  <h3>ğŸ†• Phim má»›i nháº¥t</h3>
  <div class="movies-grid-10">
    {% for m in latest_movies[:12] %}
    <div class="card" data-preview-id="{{ m.id }}">
      <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
          <div class="card-meta">
            {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
            {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
          </div>
          {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
          <div class="movie-rating" data-movie-id="{{ m.id }}">
            <span class="rating-stars">
              {% if m.avgRating and m.avgRating > 0 %}â­ {{ "%.1f"|format(m.avgRating) }}{% else %}â­ 0.0{% endif %}
            </span>
            {% if m.viewCount and m.viewCount > 0 %}
            <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">ğŸ‘ï¸ {{ m.viewCount }}</span>
            {% endif %}
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}">
          <span class="watchlist-icon">ğŸ“‹</span>
        </button>
        <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}">
          <span class="favorite-icon">ğŸ¤</span>
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- 2. Unified Recommendations Section (Grid 10 items) -->
{% if not genre_filter %}
<section class="personalized-section">
  <div class="section-header">
    <h3 id="recommendationTitle">ğŸ¯ Gá»£i Ã½ cÃ¡ nhÃ¢n cho báº¡n</h3>
    <div class="section-actions" id="sectionActions">
      <button class="refresh-recommendations-btn" onclick="refreshRecommendations()" id="refreshBtn">
        <span class="refresh-icon">ğŸ”„</span> <span class="refresh-text">LÃ m má»›i gá»£i Ã½</span>
      </button>
    </div>
  </div>
  <div class="movies-grid-10" id="personalizedCards">
    <!-- Recommendations will be loaded here via JS -->
  </div>
  <div class="personalized-loading" id="personalizedLoading" style="text-align: center; padding: 40px; display: none;">
    <div class="loading-spinner">â³</div>
    <p>Äang táº¡o gá»£i Ã½ cÃ¡ nhÃ¢n hÃ³a...</p>
  </div>
  <div class="personalized-empty" id="personalizedEmpty" style="text-align: center; padding: 40px; display: none;">
    <div class="empty-icon">ğŸ¬</div>
    <h4>ChÆ°a cÃ³ gá»£i Ã½ cÃ¡ nhÃ¢n</h4>
    <p>HÃ£y Ä‘Ã¡nh giÃ¡ má»™t sá»‘ phim Ä‘á»ƒ nháº­n gá»£i Ã½ cÃ¡ nhÃ¢n dá»±a trÃªn sá»Ÿ thÃ­ch cá»§a báº¡n!</p>
    <button class="btn btn-primary" onclick="generateRecommendations()">Táº¡o gá»£i Ã½ ngay</button>
  </div>
</section>
{% endif %}

<!-- 3. Phim xem gáº§n Ä‘Ã¢y (Grid 10 items) -->
{% if not genre_filter and recent_watched %}
<section>
  <div class="section-header">
    <h3>ğŸ“º Xem gáº§n Ä‘Ã¢y</h3>
    <p class="section-subtitle">Tiáº¿p tá»¥c xem phim cá»§a báº¡n</p>
  </div>
    <div class="movies-grid-10" id="recentWatched">
    {% for m in recent_watched[:12] %}
    <div class="card" data-preview-id="{{ m.id }}">
      <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ m.poster }}')">
          {% if m.isCompleted %}
          <div class="completed-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">âœ… HoÃ n thÃ nh</div>
          {% elif m.progressPercent > 0 %}
          <div class="progress-badge" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">{{ "%.0f"|format(m.progressPercent) }}%</div>
          {% endif %}
        </div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
          <div class="card-meta">
            {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
            {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
          </div>
          {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
          <div class="watch-info" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div><strong>ğŸ“Š ÄÃ£ xem:</strong> <span style="color: #4CAF50; font-weight: bold;">{{ m.watchCount }} láº§n</span></div>
              {% if m.progressPercent > 0 and not m.isCompleted %}<span style="color: #FF9800;">â³ {{ "%.0f"|format(m.progressPercent) }}%</span>{% endif %}
            </div>
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}"><span class="watchlist-icon">ğŸ“‹</span></button>
        <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}"><span class="favorite-icon">ğŸ¤</span></button>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- 4. Phim trending (Grid 10 items) -->
{% if not genre_filter and trending_movies %}
<section>
  <div class="section-header">
    <h3>ğŸ”¥ Phim Ä‘ang thá»‹nh hÃ nh</h3>
    <p class="section-subtitle">Nhá»¯ng bá»™ phim Ä‘Æ°á»£c Ä‘Ã¡nh giÃ¡ nhiá»u nháº¥t</p>
  </div>
  <div class="movies-grid-10" id="trendingMovies">
    {% for m in trending_movies[:12] %}
    <div class="card" data-preview-id="{{ m.id }}">
      <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
          <div class="card-meta">
            {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
            {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
          </div>
          {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
          <div class="movie-rating" data-movie-id="{{ m.id }}">
            <span class="rating-stars">
              {% if m.avgRating and m.avgRating > 0 %}â­ {{ "%.1f"|format(m.avgRating) }}{% else %}â­ 0.0{% endif %}
            </span>
            {% if m.viewCount and m.viewCount > 0 %}
            <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">ğŸ‘ï¸ {{ m.viewCount }}</span>
            {% endif %}
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}"><span class="watchlist-icon">ğŸ“‹</span></button>
        <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}"><span class="favorite-icon">ğŸ¤</span></button>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- Filter Section (chá»‰ hiá»ƒn thá»‹ khi cÃ³ genre filter hoáº·c search) -->
{% if genre_filter or search_query %}
<div class="filter-section" style="background: #0b1020; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
  <form method="GET" action="{{ url_for('main.home') }}" id="filterForm">
    {% if genre_filter %}
    <input type="hidden" name="genre" value="{{ genre_filter }}">
    {% endif %}
    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
      <div style="flex: 1; min-width: 250px;">
        <label for="q" style="color: #e7e9ee; font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 8px;">ğŸ” TÃ¬m kiáº¿m</label>
        <div style="position: relative;">
          <input 
            type="text" 
            name="q" 
            id="q" 
            value="{{ search_query }}" 
            placeholder="TÃ¬m kiáº¿m phim..." 
            style="width: 100%; background: #141a28; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 12px; color: #e7e9ee; font-size: 0.9rem;"
            autocomplete="off"
            onkeypress="if(event.key === 'Enter') { event.preventDefault(); document.getElementById('filterForm').submit(); }"
          />
          <div class="search-suggestions" id="filterSearchSuggestions" style="display: none;">
            <div class="suggestions-list" id="filterSuggestionsList"></div>
          </div>
        </div>
      </div>
      <div style="min-width: 150px;">
        <label for="sort" style="color: #e7e9ee; font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 8px;">Sáº¯p xáº¿p theo</label>
        <select name="sort" id="sort" style="width: 100%; background: #141a28; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 12px; color: #e7e9ee; font-size: 0.9rem; cursor: pointer;" onchange="document.getElementById('filterForm').submit()">
          <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Má»›i nháº¥t</option>
          <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>CÅ© nháº¥t</option>
          <option value="views" {% if sort_by == 'views' %}selected{% endif %}>LÆ°á»£t xem nhiá»u nháº¥t</option>
          <option value="ratings" {% if sort_by == 'ratings' %}selected{% endif %}>ÄÃ¡nh giÃ¡ cao nháº¥t</option>
          <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>TÃªn A-Z</option>
          <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>TÃªn Z-A</option>
        </select>
      </div>
      {% if year_list %}
      <div style="min-width: 150px;">
        <label for="year" style="color: #e7e9ee; font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 8px;">NÄƒm phÃ¡t hÃ nh</label>
        <select name="year" id="year" style="width: 100%; background: #141a28; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 12px; color: #e7e9ee; font-size: 0.9rem; cursor: pointer;" onchange="document.getElementById('filterForm').submit()">
          <option value="">Táº¥t cáº£ nÄƒm</option>
          {% for year in year_list %}
          <option value="{{ year }}" {% if year_filter|string == year|string %}selected{% endif %}>{{ year }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div style="display: flex; gap: 10px; align-items: flex-end;">
        <button type="submit" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">TÃ¬m kiáº¿m</button>
        <a href="{{ url_for('main.home', genre=genre_filter if genre_filter else '') }}" style="padding: 10px 20px; background: #141a28; color: #e7e9ee; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s ease;">Äáº·t láº¡i</a>
      </div>
    </div>
  </form>
</div>
{% endif %}

<!-- 5. Táº¥t cáº£ phim (Grid 10 items preview) -->
{% if all_movies %}
<section class="all-movies movies-section">
  <div class="section-header">
    {% if search_query %}
      <h3>ğŸ” Káº¿t quáº£ tÃ¬m kiáº¿m cho "{{ search_query }}"</h3>
    {% elif genre_filter %}
      <h3>ğŸ¬ Phim {{ genre_filter }}</h3>
    {% else %}
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h3>ğŸ¬ Táº¥t cáº£ phim</h3>
        <a href="{{ url_for('main.all_movies') }}" class="btn-view-all">Xem táº¥t cáº£ â†’</a>
      </div>
    {% endif %}
  </div>
  
  <div class="movies-grid-10" id="homeMoviesGrid">
    {% set has_pagination = pagination and pagination.pages %}
    {% if all_movies %}
      {% if has_pagination %}
        {% set display_movies = all_movies %}
      {% else %}
        {% set display_movies = all_movies[:12] %}
      {% endif %}
    {% else %}
      {% set display_movies = [] %}
    {% endif %}
    {% for movie in display_movies %}
    <div class="card" data-preview-id="{{ movie.id }}">
      <a href="{{ url_for('main.detail', movie_id=movie.id) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ movie.poster }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ movie.title }}</div>
          <div class="card-meta">
            {% if movie.year %}<span class="year">{{ movie.year }}</span>{% endif %}
            {% if movie.country %}<span class="country">{{ movie.country }}</span>{% endif %}
          </div>
          {% if movie.genres %}<div class="card-genres">{{ movie.genres }}</div>{% endif %}
          <div class="movie-rating" data-movie-id="{{ movie.id }}">
            <span class="rating-stars">
              {% if movie.avgRating and movie.avgRating > 0 %}â­ {{ "%.1f"|format(movie.avgRating) }}{% else %}â­ 0.0{% endif %}
            </span>
            {% if movie.viewCount and movie.viewCount > 0 %}
            <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">ğŸ‘ï¸ {{ movie.viewCount }}</span>
            {% endif %}
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist({{ movie.id }}, event)" data-movie-id="{{ movie.id }}"><span class="watchlist-icon">ğŸ“‹</span></button>
        <button class="favorite-btn" onclick="toggleFavorite({{ movie.id }}, event)" data-movie-id="{{ movie.id }}"><span class="favorite-icon">ğŸ¤</span></button>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if pagination and pagination.pages > 1 %}
  <div class="pagination" id="homePaginationContainer">
    <div class="pagination-controls" id="homePaginationControls">
      <!-- Pagination buttons will be generated by JavaScript -->
    </div>
  </div>
  {% endif %}
</section>
{% endif %}

<script>
window.CineBox = window.CineBox || {};
let currentSlideIndex = 0;
const slides = document.querySelectorAll('.hero-slide');
const totalSlides = slides.length;

function updateCarousel() {
  if (totalSlides === 0) return;
  
  slides.forEach((slide, index) => {
    slide.className = 'hero-slide'; // Reset classes
    slide.style.opacity = ''; // Reset styles
    slide.style.zIndex = '';
    slide.style.transform = '';
    
    if (index === currentSlideIndex) {
      slide.classList.add('active');
    } else if (index === (currentSlideIndex - 1 + totalSlides) % totalSlides) {
      slide.classList.add('prev');
    } else if (index === (currentSlideIndex + 1) % totalSlides) {
      slide.classList.add('next');
    } else {
      // Hide others nicely
      slide.style.opacity = '0';
      slide.style.zIndex = '0';
      slide.style.transform = 'scale(0.5)';
    }
  });
}

function changeSlide(direction) {
  if (totalSlides === 0) return;
  currentSlideIndex = (currentSlideIndex + direction + totalSlides) % totalSlides;
  updateCarousel();
}

function currentSlide(index) {
  if (totalSlides === 0) return;
  currentSlideIndex = index;
  updateCarousel();
}

// Auto slide every 5 seconds
setInterval(() => {
  changeSlide(1);
}, 5000);

// Initial update
document.addEventListener('DOMContentLoaded', () => {
  // Force update carousel on load
  setTimeout(updateCarousel, 100);
  
  // JS Logic for personalized recommendations update to use Grid 10
  window.updateRecommendationsDisplay = function(recommendations) {
    const container = document.getElementById('personalizedCards');
    const loading = document.getElementById('personalizedLoading');
    const empty = document.getElementById('personalizedEmpty');
    
    if (!container) return;
    
    if (loading) loading.style.display = 'none';
    if (empty) empty.style.display = 'none';
    
    // Validate and filter recommendations
    if (!recommendations || !Array.isArray(recommendations)) {
      console.error('Invalid recommendations data:', recommendations);
      if (empty) empty.style.display = 'block';
      return;
    }
    
    // Take only first 12
    const itemsToShow = recommendations.slice(0, 12);
    
    if (itemsToShow.length === 0) {
      if (empty) empty.style.display = 'block';
      return;
    }
    
    // Helper function to escape HTML
    const escapeHtml = (text) => {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };
    
    // Helper function to format genres
    const formatGenres = (genres) => {
      if (!genres) return '';
      if (Array.isArray(genres)) {
        return genres.join(', ');
      }
      if (typeof genres === 'string') {
        return genres;
      }
      return '';
    };
    
    container.innerHTML = itemsToShow.map(rec => {
      const movieId = rec.movieId || rec.id;
      const title = escapeHtml(rec.title || 'Untitled');
      const poster = rec.poster || rec.posterUrl || '/static/img/no-poster.jpg';
      const year = rec.releaseYear || rec.year || '';
      const country = escapeHtml(rec.country || '');
      const genres = formatGenres(rec.genres);
      const avgRating = (rec.avgRating ?? rec.avg_rating ?? 0).toFixed(1);
      const ratingCount = rec.ratingCount ?? rec.total_ratings ?? 0;
      
      return `
      <div class="card" data-preview-id="${movieId}">
        <a href="/movie/${movieId}" class="card-link">
          <div class="poster" style="background-image:url('${poster}')"></div>
          <div class="card-content">
            <div class="card-title">${title}</div>
            <div class="card-meta">
              ${year ? `<span class="year">${year}</span>` : ''}
              ${country ? `<span class="country">${country}</span>` : ''}
            </div>
            ${genres ? `<div class="card-genres">${escapeHtml(genres)}</div>` : ''}
            <div class="movie-rating" data-movie-id="${movieId}">
              <span class="rating-stars">â­ ${avgRating}</span>
              <span class="rating-count">(${ratingCount})</span>
            </div>
          </div>
        </a>
        <div class="action-buttons">
          <button class="watchlist-btn" onclick="toggleWatchlist(${movieId}, event)" data-movie-id="${movieId}">
            <span class="watchlist-icon">ğŸ“‹</span>
          </button>
          <button class="favorite-btn" onclick="toggleFavorite(${movieId}, event)" data-movie-id="${movieId}">
            <span class="favorite-icon">ğŸ¤</span>
          </button>
        </div>
      </div>
    `;
    }).join('');
    
    // Cáº­p nháº­t tráº¡ng thÃ¡i favorite/watchlist cho cÃ¡c phim má»›i
    setTimeout(() => {
      checkAllFavoriteStatus();
      checkAllWatchlistStatus();
    }, 100);
    if (window.CineBox && typeof window.CineBox.refreshPreviewTargets === 'function') {
      window.CineBox.refreshPreviewTargets();
    }
  };

  initFilterSearchSuggestions();

  function initFilterSearchSuggestions() {
    const filterSearchInput = document.getElementById('q');
    const suggestionsContainer = document.getElementById('filterSearchSuggestions');
    const suggestionsList = document.getElementById('filterSuggestionsList');
    const filterForm = document.getElementById('filterForm');

    if (!filterSearchInput || !suggestionsContainer || !suggestionsList) return;

    let filterSearchTimeout;

    const hideSuggestions = () => {
      suggestionsContainer.style.display = 'none';
    };

    const fetchFilterSuggestions = (query) => {
      fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}&limit=8`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const hasData = window.CineBox.renderSuggestions(
              data.groups || [],
              suggestionsList,
              (item) => {
                filterSearchInput.value = item.title;
                hideSuggestions();
                if (filterForm) {
                  filterForm.submit();
                }
              }
            );
            suggestionsContainer.style.display = hasData ? 'block' : 'none';
          } else {
            hideSuggestions();
          }
        })
        .catch(() => hideSuggestions());
    };

    filterSearchInput.addEventListener('input', () => {
      const query = filterSearchInput.value.trim();
      clearTimeout(filterSearchTimeout);

      if (query.length < 2) {
        hideSuggestions();
        return;
      }

      filterSearchTimeout = setTimeout(() => fetchFilterSuggestions(query), 250);
    });

    filterSearchInput.addEventListener('focus', () => {
      if (filterSearchInput.value.trim().length >= 2 && suggestionsList.childElementCount > 0) {
        suggestionsContainer.style.display = 'block';
      }
    });

    document.addEventListener('click', (event) => {
      if (!suggestionsContainer.contains(event.target) && event.target !== filterSearchInput) {
        hideSuggestions();
      }
    });
  }
});

// Include other existing JS functions (toggleFavorite, toggleWatchlist, etc.)
</script>

<!-- Re-include necessary scripts from original file -->
<script>
function toggleFavorite(movieId, event) {
  if (event) { event.preventDefault(); event.stopPropagation(); }
  fetch(`/toggle-favorite/${movieId}`, { method: 'POST' })
  .then(r => r.json())
  .then(d => {
    if(d.success) {
      const btns = document.querySelectorAll(`.favorite-btn[data-movie-id="${movieId}"]`);
      btns.forEach(btn => {
        const icon = btn.querySelector('.favorite-icon');
        if(d.is_favorite) {
          btn.classList.add('favorited');
          icon.textContent = 'â¤ï¸';
        } else {
          btn.classList.remove('favorited');
          icon.textContent = 'ğŸ¤';
        }
      });
      showToast(d.message, 'success');
    }
  });
}

function toggleWatchlist(movieId, event) {
  if (event) { event.preventDefault(); event.stopPropagation(); }
  fetch(`/toggle-watchlist/${movieId}`, { method: 'POST' })
  .then(r => r.json())
  .then(d => {
    if(d.success) {
      const btns = document.querySelectorAll(`.watchlist-btn[data-movie-id="${movieId}"]`);
      btns.forEach(btn => {
        const icon = btn.querySelector('.watchlist-icon');
        if(d.is_watchlist) {
          btn.classList.add('watchlisted');
          icon.textContent = 'âœ…';
        } else {
          btn.classList.remove('watchlisted');
          icon.textContent = 'ğŸ“‹';
        }
      });
      showToast(d.message, 'success');
    }
  });
}

function showToast(msg, type) {
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:#333;color:#fff;padding:15px;border-radius:5px;z-index:9999;';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

// Load unified recommendations
function loadUnifiedRecommendations() {
  const loading = document.getElementById('personalizedLoading');
  const container = document.getElementById('personalizedCards');
  const empty = document.getElementById('personalizedEmpty');
  
  if (loading) loading.style.display = 'block';
  if (container) container.style.display = 'none';
  if (empty) empty.style.display = 'none';
  
  fetch('/api/user_interaction_status')
    .then(r => r.json())
    .then(d => {
      // Gá»i API gá»£i Ã½ dá»±a trÃªn tráº¡ng thÃ¡i user
      if(d.success && (d.rating_count + d.view_count) < 5) {
        setupColdStartMode();
        fetch('/api/cold_start_recommendations?limit=12')
          .then(r => r.json())
          .then(data => {
            if (loading) loading.style.display = 'none';
            if (container) container.style.display = 'grid';
            if(data.success && data.recommendations) {
              updateRecommendationsDisplay(data.recommendations);
            } else {
              if (empty) empty.style.display = 'block';
            }
          })
          .catch(e => {
            console.error('Error loading cold start recommendations:', e);
            if (loading) loading.style.display = 'none';
            if (empty) empty.style.display = 'block';
          });
      } else {
        setupPersonalizedMode();
        fetch('/api/personalized_recommendations?limit=12')
          .then(r => r.json())
          .then(data => {
            if (loading) loading.style.display = 'none';
            if (container) container.style.display = 'grid';
            if(data.success && data.recommendations) {
              updateRecommendationsDisplay(data.recommendations);
            } else {
              if (empty) empty.style.display = 'block';
            }
          })
          .catch(e => {
            console.error('Error loading personalized recommendations:', e);
            if (loading) loading.style.display = 'none';
            if (empty) empty.style.display = 'block';
          });
      }
    })
    .catch(e => {
      console.error('Error checking user status:', e);
      // Fallback náº¿u lá»—i: load recommendations máº·c Ä‘á»‹nh
      setupPersonalizedMode();
      fetch('/api/personalized_recommendations?limit=12')
        .then(r => r.json())
        .then(data => {
          if (loading) loading.style.display = 'none';
          if (container) container.style.display = 'grid';
          if(data.success && data.recommendations) {
            updateRecommendationsDisplay(data.recommendations);
          } else {
            if (empty) empty.style.display = 'block';
          }
        })
        .catch(err => {
          console.error('Error loading fallback recommendations:', err);
          if (loading) loading.style.display = 'none';
          if (empty) empty.style.display = 'block';
        });
    });
}

function setupColdStartMode() {
  const t = document.getElementById('recommendationTitle');
  if(t) t.textContent = 'ğŸŒŸ Gá»£i Ã½ dÃ nh cho báº¡n (Má»›i)';
}

function setupPersonalizedMode() {
  const t = document.getElementById('recommendationTitle');
  if(t) t.textContent = 'ğŸ¯ Gá»£i Ã½ cÃ¡ nhÃ¢n cho báº¡n';
}

function refreshRecommendations() {
  const btn = document.getElementById('refreshBtn');
  if(btn) btn.classList.add('loading'); // Add loading visual if CSS supports
  
  // Force refresh báº±ng cÃ¡ch gá»i láº¡i loadUnifiedRecommendations
  loadUnifiedRecommendations();
  
  setTimeout(() => {
     if(btn) btn.classList.remove('loading');
  }, 1000);
}

function generateRecommendations() {
  refreshRecommendations();
}

function updateFavoriteButton(movieId, isFavorite) {
  const favoriteBtns = document.querySelectorAll(`.favorite-btn[data-movie-id="${movieId}"]`);
  favoriteBtns.forEach(btn => {
    const favoriteIcon = btn.querySelector('.favorite-icon');
    if (favoriteIcon) {
      if (isFavorite) {
        favoriteIcon.textContent = 'â¤ï¸';
        btn.classList.add('favorited');
      } else {
        favoriteIcon.textContent = 'ğŸ¤';
        btn.classList.remove('favorited');
      }
    }
  });
}

function updateWatchlistButton(movieId, isWatchlist) {
  const watchlistBtns = document.querySelectorAll(`.watchlist-btn[data-movie-id="${movieId}"]`);
  watchlistBtns.forEach(btn => {
    const watchlistIcon = btn.querySelector('.watchlist-icon');
    if (watchlistIcon) {
      if (isWatchlist) {
        watchlistIcon.textContent = 'âœ…';
        btn.classList.add('watchlisted');
      } else {
        watchlistIcon.textContent = 'ğŸ“‹';
        btn.classList.remove('watchlisted');
      }
    }
  });
}

function checkFavoriteStatus(movieId) {
  fetch(`/check-favorite/${movieId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateFavoriteButton(movieId, data.is_favorite);
    }
  })
  .catch(error => {
    console.error('Error checking favorite status:', error);
  });
}

function checkWatchlistStatus(movieId) {
  fetch(`/check-watchlist/${movieId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      updateWatchlistButton(movieId, data.is_watchlist);
    }
  })
  .catch(error => {
    console.error('Error checking watchlist status:', error);
  });
}

function checkAllFavoriteStatus() {
  const favoriteBtns = document.querySelectorAll('.favorite-btn');
  favoriteBtns.forEach(btn => {
    const movieId = btn.getAttribute('data-movie-id');
    if (movieId) {
      checkFavoriteStatus(parseInt(movieId));
    }
  });
}

function checkAllWatchlistStatus() {
  const watchlistBtns = document.querySelectorAll('.watchlist-btn');
  watchlistBtns.forEach(btn => {
    const movieId = btn.getAttribute('data-movie-id');
    if (movieId) {
      checkWatchlistStatus(parseInt(movieId));
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  loadUnifiedRecommendations();
  
  // Initialize home page pagination
  {% if pagination and pagination.pages > 1 %}
  initHomePagination();
  {% endif %}
});

// Home page pagination
let homeCurrentPage = {{ pagination.page if pagination else 1 }};
let homeTotalPages = {{ pagination.pages if pagination else 1 }};
let homeCurrentGenre = '{{ genre_filter }}';
let homeSearchQuery = '{{ search_query }}';
let homeIsLoading = false;

// Generate pagination numbers with smart logic (same as all_movies)
function generateHomePaginationNumbers(current, total) {
  const numbers = [];
  const showAdjacent = 2;
  
  if (total > 0) {
    numbers.push(1);
  }
  
  let start = Math.max(2, current - showAdjacent);
  let end = Math.min(total - 1, current + showAdjacent);
  
  if (current <= showAdjacent + 2) {
    end = Math.min(total - 1, showAdjacent * 2 + 2);
  }
  
  if (current >= total - showAdjacent - 1) {
    start = Math.max(2, total - showAdjacent * 2 - 1);
  }
  
  if (start > 2) {
    numbers.push('ellipsis-start');
  }
  
  for (let i = start; i <= end; i++) {
    if (i !== 1 && i !== total) {
      numbers.push(i);
    }
  }
  
  if (end < total - 1) {
    numbers.push('ellipsis-end');
  }
  
  if (total > 1) {
    numbers.push(total);
  }
  
  return numbers;
}

// Render home pagination
function renderHomePagination(page, total) {
  const container = document.getElementById('homePaginationControls');
  if (!container) return;
  
  container.innerHTML = '';
  
  // Previous button
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn-pagination btn-pagination-icon' + (page <= 1 ? ' disabled' : '');
  prevBtn.innerHTML = 'â†';
  prevBtn.disabled = page <= 1;
  prevBtn.onclick = () => !homeIsLoading && page > 1 && loadHomePage(page - 1);
  container.appendChild(prevBtn);
  
  // Page numbers
  const pageNumbers = generateHomePaginationNumbers(page, total);
  pageNumbers.forEach(num => {
    if (num === 'ellipsis-start' || num === 'ellipsis-end') {
      const ellipsis = document.createElement('span');
      ellipsis.className = 'pagination-ellipsis';
      ellipsis.textContent = '...';
      container.appendChild(ellipsis);
    } else {
      const pageBtn = document.createElement('button');
      pageBtn.className = 'btn-pagination' + (num === page ? ' active' : '');
      pageBtn.textContent = num;
      pageBtn.onclick = () => !homeIsLoading && num !== page && loadHomePage(num);
      container.appendChild(pageBtn);
    }
  });
  
  // Next button
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn-pagination btn-pagination-icon' + (page >= total ? ' disabled' : '');
  nextBtn.innerHTML = 'â†’';
  nextBtn.disabled = page >= total;
  nextBtn.onclick = () => !homeIsLoading && page < total && loadHomePage(page + 1);
  container.appendChild(nextBtn);
  
}

// Load home page via normal navigation (since home has complex logic)
function loadHomePage(page) {
  if (homeIsLoading) return;
  
  homeIsLoading = true;
  homeCurrentPage = page;
  
  // Get movies grid position to maintain scroll
  const grid = document.getElementById('homeMoviesGrid');
  const gridPosition = grid ? grid.getBoundingClientRect().top + window.pageYOffset : 0;
  
  // Build URL
  const params = new URLSearchParams({ page: page });
  if (homeCurrentGenre) params.append('genre', homeCurrentGenre);
  if (homeSearchQuery) params.append('q', homeSearchQuery);
  
  // Store scroll position in sessionStorage
  sessionStorage.setItem('homeScrollPosition', gridPosition.toString());
  
  // Navigate to new page (home page logic is complex, so we use normal navigation)
  window.location.href = `/?${params.toString()}`;
}

// Initialize home pagination
function initHomePagination() {
  {% if pagination and pagination.pages > 1 %}
  renderHomePagination({{ pagination.page }}, {{ pagination.pages }});
  {% endif %}
  
  // Restore scroll position after page load
  const savedPosition = sessionStorage.getItem('homeScrollPosition');
  if (savedPosition) {
    const grid = document.getElementById('homeMoviesGrid');
    if (grid) {
      setTimeout(() => {
        window.scrollTo({
          top: parseInt(savedPosition) - 20,
          behavior: 'instant'
        });
        sessionStorage.removeItem('homeScrollPosition');
      }, 100);
    }
  }
}
</script>
{% endblock %}
