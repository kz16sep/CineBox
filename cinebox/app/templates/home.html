{% extends 'base.html' %}
{% block title %}Trang ch·ªß ¬∑ CineBox{% endblock %}
{% block content %}
<section class="hero">
  <div class="hero-card">
    <div class="hero-text">
      <span class="badge">NEW</span>
      <h2>{{ latest_movies[0].title }}</h2>
      <p>{{ latest_movies[0].description }}</p>
      <div class="actions">
        <a class="btn btn-primary" href="{{ url_for('main.watch', movie_id=latest_movies[0].id) }}">Xem ngay</a>
        <a class="btn btn-secondary" href="{{ url_for('main.detail', movie_id=latest_movies[0].id) }}">Th√™m v√†o danh s√°ch</a>
      </div>
    </div>
  </div>
</section>

<!-- Genre Filter Menu -->
<section class="genre-filter">
  <div class="genre-filter-container">
    <h3>üé¨ L·ªçc theo th·ªÉ lo·∫°i</h3>
    <div class="genre-buttons">
      <a href="{{ url_for('main.home') }}" 
         class="genre-btn {{ 'active' if not genre_filter else '' }}"
         data-genre="all"
         onclick="window.location.href='{{ url_for('main.home') }}'; return false;">
        üè† Trang ch·ªß
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='action') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Action' else '' }}"
         data-genre="action">
        üé¨ Action
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='adventure') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Adventure' else '' }}"
         data-genre="adventure">
        üó∫Ô∏è Adventure
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='comedy') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Comedy' else '' }}"
         data-genre="comedy">
        üòÇ Comedy
      </a>
      <a href="{{ url_for('main.genre_page', genre_slug='horror') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Horror' else '' }}"
         data-genre="horror">
        üëª Horror
      </a>
    </div>
  </div>
</section>

<!-- 1. Phim m·ªõi nh·∫•t (12 phim, kh√¥ng ph√¢n trang) -->
<section>
  <h3>üÜï {% if genre_filter %}{{ genre_filter }} Movies{% else %}Phim m·ªõi nh·∫•t{% endif %}</h3>
  <div class="cards">
    {% for m in latest_movies %}
    <a class="card" href="{{ url_for('main.detail', movie_id=m.id) }}">
      <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
      <div class="card-title">{{ m.title }}</div>
      <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
    </a>
    {% endfor %}
  </div>
</section>

<!-- Pagination cho trang genre -->
{% if genre_filter and pagination %}
<div class="pagination">
  <div class="pagination-info">
    <span>Trang {{ pagination.page }} / {{ pagination.pages }}</span>
  </div>
  <div class="pagination-controls">
    {% if pagination.has_prev %}
      <a href="{{ url_for('main.home', genre=genre_filter, page=pagination.prev_num) }}" class="btn-pagination">‚Äπ Tr∆∞·ªõc</a>
    {% endif %}
    
    <div class="page-numbers">
      {% for page_num in range(1, pagination.pages + 1) %}
        {% if page_num == pagination.page %}
          <span class="page-number current">{{ page_num }}</span>
        {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
          <a href="{{ url_for('main.home', genre=genre_filter, page=page_num) }}" class="page-number">{{ page_num }}</a>
        {% elif page_num == 4 or page_num == pagination.pages - 3 %}
          <span class="page-ellipsis">...</span>
        {% endif %}
      {% endfor %}
    </div>
    
    {% if pagination.has_next %}
      <a href="{{ url_for('main.home', genre=genre_filter, page=pagination.next_num) }}" class="btn-pagination">Ti·∫øp ‚Ä∫</a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- 2. Phim ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t cho b·∫°n (ch·ªâ hi·ªÉn th·ªã khi kh√¥ng c√≥ genre filter) -->
{% if not genre_filter %}
<section>
  <h3>Phim ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t cho b·∫°n</h3>
  <div class="cards">
    {% for m in recommended %}
    <a class="card" href="{{ url_for('main.detail', movie_id=m.id) }}">
      <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
      <div class="card-title">{{ m.title }}</div>
      <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
    </a>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- 3. T·∫•t c·∫£ phim (c√≥ ph√¢n trang) - ch·ªâ hi·ªÉn th·ªã khi kh√¥ng c√≥ genre filter -->
{% if all_movies and not genre_filter %}
<section class="all-movies movies-section">
  <div class="section-header">
    {% if search_query %}
      <h3>üîç K·∫øt qu·∫£ t√¨m ki·∫øm cho "{{ search_query }}"</h3>
    {% else %}
      <h3>üé¨ T·∫•t c·∫£ phim</h3>
    {% endif %}
  </div>
  
  <div class="cards movies-grid">
    {% for m in all_movies %}
    <a class="card" href="{{ url_for('main.detail', movie_id=m.id) }}">
      <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
      <div class="card-content">
        <div class="card-title">{{ m.title }}{% if m.year %} ({{ m.year }}){% endif %}</div>
        <div class="card-meta">
          <span class="upload-time">Phim {{ m.id }}</span>
        </div>
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
      </div>
    </a>
    {% endfor %}
  </div>
  
  <!-- Pagination -->
  {% if pagination and pagination.pages > 1 %}
  <div class="pagination">
    <div class="pagination-info page-info">
      <span>Trang {{ pagination.page }} / {{ pagination.pages }}</span>
      <span>({{ pagination.total }} phim)</span>
    </div>
    
    <div class="pagination-controls">
      {% if pagination.has_prev %}
        <a href="{{ url_for('main.home', page=pagination.prev_num, q=search_query, genre=genre_filter) }}" class="btn btn-pagination">
          ‚Üê Trang tr∆∞·ªõc
        </a>
      {% endif %}
      
      <div class="page-numbers">
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
          <a href="{{ url_for('main.home', page=1, q=search_query, genre=genre_filter) }}" class="page-number">1</a>
          {% if start_page > 2 %}
            <span class="page-ellipsis">...</span>
          {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
          {% if page_num == pagination.page %}
            <span class="page-number current">{{ page_num }}</span>
          {% else %}
            <a href="{{ url_for('main.home', page=page_num, q=search_query, genre=genre_filter) }}" class="page-number">{{ page_num }}</a>
          {% endif %}
        {% endfor %}
        
        {% if end_page < pagination.pages %}
          {% if end_page < pagination.pages - 1 %}
            <span class="page-ellipsis">...</span>
          {% endif %}
          <a href="{{ url_for('main.home', page=pagination.pages, q=search_query, genre=genre_filter) }}" class="page-number">{{ pagination.pages }}</a>
        {% endif %}
      </div>
      
      {% if pagination.has_next %}
        <a href="{{ url_for('main.home', page=pagination.next_num, q=search_query, genre=genre_filter) }}" class="btn btn-pagination">
          Trang sau ‚Üí
        </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</section>
{% endif %}

<style>
/* Genre Filter Section */
.genre-filter {
  margin: 30px 0;
  padding: 20px 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
  border-radius: 15px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.genre-filter-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.genre-filter h3 {
  color: #fff;
  font-size: 1.3rem;
  margin: 0 0 20px 0;
  text-align: center;
  font-weight: 600;
}

.genre-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.genre-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  text-decoration: none;
  border-radius: 25px;
  font-weight: 500;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  backdrop-filter: blur(10px);
}

.genre-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  color: #fff;
  text-decoration: none;
}

.genre-btn.active {
  background: linear-gradient(135deg, #ff6b35, #f7931e);
  border-color: #ff6b35;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
  color: #fff;
  font-weight: 600;
}

.genre-btn.active:hover {
  background: linear-gradient(135deg, #ff7b45, #ffa31e);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
}

/* Responsive */
@media (max-width: 768px) {
  .genre-buttons {
    gap: 8px;
  }
  
  .genre-btn {
    padding: 10px 16px;
    font-size: 0.9rem;
  }
  
  .genre-filter h3 {
    font-size: 1.1rem;
  }
}

/* All Movies Section */
.all-movies {
  margin: 40px 0;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-header h3 {
  color: #fff;
  font-size: 1.5rem;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-info {
  color: #888;
  font-size: 0.9rem;
}

.movie-count {
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 12px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
}

.card-content {
  padding: 12px;
}

.card-meta {
  margin: 5px 0;
  font-size: 0.8rem;
}

.upload-time {
  color: #4CAF50;
  font-weight: bold;
  background: rgba(76, 175, 80, 0.1);
  padding: 2px 8px;
  border-radius: 8px;
}

/* Pagination Styles */
.pagination {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.pagination-info {
  color: #888;
  font-size: 0.9rem;
  display: flex;
  gap: 10px;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 15px;
}

.btn-pagination {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-pagination:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.4);
  transform: translateY(-1px);
}

.page-numbers {
  display: flex;
  gap: 5px;
  align-items: center;
}

.page-number {
  display: inline-block;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  min-width: 40px;
  text-align: center;
}

.page-number:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.page-number.current {
  background: #e50914;
  color: #fff;
  font-weight: bold;
}

.page-ellipsis {
  color: #888;
  padding: 8px 4px;
  font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .pagination-controls {
    flex-direction: column;
    gap: 10px;
  }
  
  .page-numbers {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .btn-pagination {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  .page-number {
    padding: 6px 10px;
    font-size: 0.8rem;
    min-width: 35px;
  }
}

/* AJAX Loading States */
.movies-grid {
  transition: opacity 0.3s ease;
}

.movies-grid.loading {
  opacity: 0.7;
}

.genre-btn {
  transition: all 0.3s ease;
}

.genre-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.page-number {
  transition: all 0.3s ease;
}

.page-number:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}
</style>

<script>
// AJAX Pagination, Genre Filter, and Search
document.addEventListener('DOMContentLoaded', function() {
    // Attach pagination listeners
    attachPaginationListeners();
    
    // Attach genre filter listeners
    attachGenreFilterListeners();
    
    // Attach search listeners
    attachSearchListeners();
});

function attachGenreFilterListeners() {
    const genreLinks = document.querySelectorAll('.genre-btn');
    
    genreLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const genre = this.getAttribute('data-genre');
            
            // N·∫øu l√† "T·∫•t c·∫£" th√¨ d√πng AJAX, c√°c th·ªÉ lo·∫°i kh√°c th√¨ chuy·ªÉn trang
            if (genre === 'all') {
                e.preventDefault();
                
                const url = this.href;
                
                // Show loading indicator
                showLoading();
                
                // Add loading class to movies grid
                const moviesGrid = document.querySelector('.movies-grid');
                if (moviesGrid) {
                    moviesGrid.classList.add('loading');
                }
                
                // Fetch new page content
                fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Parse the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update the movies grid
                    const newMoviesGrid = doc.querySelector('.movies-grid');
                    const currentMoviesGrid = document.querySelector('.movies-grid');
                    if (newMoviesGrid && currentMoviesGrid) {
                        currentMoviesGrid.innerHTML = newMoviesGrid.innerHTML;
                    }
                    
                    // Update pagination
                    const newPagination = doc.querySelector('.pagination-controls');
                    const currentPagination = document.querySelector('.pagination-controls');
                    if (newPagination && currentPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                        // Re-attach event listeners to new pagination links
                        attachPaginationListeners();
                    }
                    
                    // Update page info
                    const newPageInfo = doc.querySelector('.page-info');
                    const currentPageInfo = document.querySelector('.page-info');
                    if (newPageInfo && currentPageInfo) {
                        currentPageInfo.innerHTML = newPageInfo.innerHTML;
                    }
                    
                    // Update genre filter active state
                    const newGenreFilter = doc.querySelector('.genre-filter');
                    const currentGenreFilter = document.querySelector('.genre-filter');
                    if (newGenreFilter && currentGenreFilter) {
                        currentGenreFilter.innerHTML = newGenreFilter.innerHTML;
                        // Re-attach event listeners to new genre links
                        attachGenreFilterListeners();
                    }
                    
                    // Update section title
                    const newSectionTitle = doc.querySelector('.movies-section h3');
                    const currentSectionTitle = document.querySelector('.movies-section h3');
                    if (newSectionTitle && currentSectionTitle) {
                        currentSectionTitle.innerHTML = newSectionTitle.innerHTML;
                    }
                    
                    // Update section info
                    const newSectionInfo = doc.querySelector('.section-info');
                    const currentSectionInfo = document.querySelector('.section-info');
                    if (newSectionInfo && currentSectionInfo) {
                        currentSectionInfo.innerHTML = newSectionInfo.innerHTML;
                    }
                    
                    // Scroll to top of movies section
                    const moviesSection = document.querySelector('.movies-section');
                    if (moviesSection) {
                        moviesSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                    // Fallback to normal page reload
                    window.location.href = url;
                });
            } else {
                // C√°c th·ªÉ lo·∫°i kh√°c: chuy·ªÉn trang b√¨nh th∆∞·ªùng
                // Kh√¥ng preventDefault, ƒë·ªÉ link ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
            }
        });
    });
}

function attachPaginationListeners() {
    const paginationLinks = document.querySelectorAll('.pagination-controls a');
    
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const url = this.href;
            
            // Show loading indicator
            showLoading();
            
            // Add loading class to movies grid
            const moviesGrid = document.querySelector('.movies-grid');
            if (moviesGrid) {
                moviesGrid.classList.add('loading');
            }
            
            // Fetch new page content
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Parse the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update the movies grid
                    const newMoviesGrid = doc.querySelector('.movies-grid');
                    const currentMoviesGrid = document.querySelector('.movies-grid');
                    if (newMoviesGrid && currentMoviesGrid) {
                        currentMoviesGrid.innerHTML = newMoviesGrid.innerHTML;
                    }
                    
                    // Update pagination
                    const newPagination = doc.querySelector('.pagination-controls');
                    const currentPagination = document.querySelector('.pagination-controls');
                    if (newPagination && currentPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                        // Re-attach event listeners to new pagination links
                        attachPaginationListeners();
                    }
                    
                    // Update page info
                    const newPageInfo = doc.querySelector('.page-info');
                    const currentPageInfo = document.querySelector('.page-info');
                    if (newPageInfo && currentPageInfo) {
                        currentPageInfo.innerHTML = newPageInfo.innerHTML;
                    }
                    
                    // Scroll to top of movies section
                    const moviesSection = document.querySelector('.movies-section');
                    if (moviesSection) {
                        moviesSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                    // Fallback to normal page reload
                    window.location.href = url;
                });
        });
    });
}

function showLoading() {
    // Create loading overlay
    let loadingOverlay = document.getElementById('loading-overlay');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        
        const loadingSpinner = document.createElement('div');
        loadingSpinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;
        
        loadingOverlay.appendChild(loadingSpinner);
        document.body.appendChild(loadingOverlay);
        
        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

function attachSearchListeners() {
    const searchInput = document.getElementById('headerSearchInput');
    const searchForm = document.querySelector('.search');
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = searchInput.value.trim();
            if (query.length < 2) {
                return;
            }
            
            // Redirect to home page with search query
            const url = new URL(window.location.origin + '/');
            url.searchParams.set('q', query);
            window.location.href = url.toString();
        });
    }
}
</script>
{% endblock %}


