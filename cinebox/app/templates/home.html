{% extends 'base.html' %}
{% block title %}{% if genre_filter %}{{ genre_filter }} ¬∑ CineBox{% else %}Trang ch·ªß ¬∑ CineBox{% endif %}{% endblock %}
{% block content %}
<section class="hero">
  <div class="hero-carousel">
    {% if carousel_movies %}
      <!-- DEBUG: Carousel has {{ carousel_movies|length }} movies -->
      {% for movie in carousel_movies %}
      <div class="hero-slide {{ 'active' if loop.first else '' }}" data-slide="{{ loop.index0 }}">
        <div class="hero-backdrop" style="background-image: url('{{ movie.backdrop }}')"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-poster">
            <img src="{{ movie.poster }}" alt="{{ movie.title }}" class="poster-img" onerror="this.src='/static/img/dune2.jpg'">
          </div>
          <div class="hero-text">
            <span class="badge">{% if genre_filter %}{{ genre_filter }}{% else %}NEW{% endif %}</span>
            <h1>{{ movie.title }}</h1>
            <p class="hero-description">{{ movie.description }}</p>
            <div class="hero-actions">
              <a class="btn btn-primary" href="{{ url_for('main.watch', movie_id=movie.id) }}">
                <span class="btn-icon">‚ñ∂</span>
                Xem ngay
              </a>
              <a class="btn btn-secondary" href="{{ url_for('main.detail', movie_id=movie.id) }}">
                <span class="btn-icon">+</span>
                Th√™m v√†o danh s√°ch
              </a>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <!-- Fallback khi kh√¥ng c√≥ phim -->
      <div class="hero-slide active">
        <div class="hero-backdrop" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
          <div class="hero-poster">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='450'%3E%3Crect width='100%25' height='100%25' fill='%23333'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='20'%3ECineBox%3C/text%3E%3C/svg%3E" alt="CineBox" class="poster-img">
          </div>
          <div class="hero-text">
            <span class="badge">{% if genre_filter %}{{ genre_filter }}{% else %}NEW{% endif %}</span>
            <h1>Dune: Part Two (2024)</h1>
            <p class="hero-description">Paul Atreides unites with Chani and the Fremen while seeking revenge against the conspirators who destroyed his family.</p>
            <div class="hero-actions">
              <a class="btn btn-primary" href="#">
                <span class="btn-icon">‚ñ∂</span>
                Xem ngay
              </a>
              <a class="btn btn-secondary" href="#">
                <span class="btn-icon">+</span>
                Th√™m v√†o danh s√°ch
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  
  <!-- Carousel Controls -->
  {% if carousel_movies and carousel_movies|length > 1 %}
  <div class="carousel-controls">
    <button class="carousel-btn prev-btn" onclick="changeSlide(-1)">‚Äπ</button>
    <div class="carousel-dots">
      {% for movie in carousel_movies %}
      <button class="dot {{ 'active' if loop.first else '' }}" onclick="currentSlide({{ loop.index }})"></button>
      {% endfor %}
    </div>
    <button class="carousel-btn next-btn" onclick="changeSlide(1)">‚Ä∫</button>
  </div>
  {% endif %}
</section>

<!-- Genre Filter Menu -->
<section class="genre-filter">
  <div class="genre-filter-container">
    <h3>üé¨ Th·ªÉ lo·∫°i</h3>
    <div class="genre-buttons">
      <a href="{{ url_for('main.home') }}" 
         class="genre-btn {{ 'active' if not genre_filter else '' }}"
         data-genre="all"
         onclick="window.location.href='{{ url_for('main.home') }}'; return false;">
        üè† Trang ch·ªß
      </a>
      
      <!-- 4 th·ªÉ lo·∫°i ch√≠nh -->
      <a href="{{ url_for('main.home', genre='Action') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Action' else '' }}"
         data-genre="action">
        üé¨ Action
      </a>
      <a href="{{ url_for('main.home', genre='Adventure') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Adventure' else '' }}"
         data-genre="adventure">
        üó∫Ô∏è Adventure
      </a>
      <a href="{{ url_for('main.home', genre='Comedy') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Comedy' else '' }}"
         data-genre="comedy">
        üòÇ Comedy
      </a>
      <a href="{{ url_for('main.home', genre='Horror') }}" 
         class="genre-btn {{ 'active' if genre_filter == 'Horror' else '' }}"
         data-genre="horror">
        üëª Horror
      </a>
      
      <!-- Ch·ªâ hi·ªÉn th·ªã th·ªÉ lo·∫°i ƒë∆∞·ª£c ch·ªçn (n·∫øu kh√¥ng ph·∫£i 4 th·ªÉ lo·∫°i ch√≠nh) -->
      {% if genre_filter and genre_filter not in ['Action', 'Adventure', 'Comedy', 'Horror'] %}
        <a href="{{ url_for('main.genre_page', genre_slug=genre_filter.lower().replace(' ', '-')) }}" 
           class="genre-btn active"
           data-genre="{{ genre_filter.lower().replace(' ', '-') }}">
          {{ genre_filter }}
        </a>
      {% endif %}
    </div>
  </div>
</section>

<!-- 1. Phim m·ªõi nh·∫•t (12 phim, kh√¥ng ph√¢n trang) - ch·ªâ hi·ªÉn th·ªã khi kh√¥ng c√≥ genre filter -->
{% if not genre_filter %}
<section>
  <h3>üÜï Phim m·ªõi nh·∫•t</h3>
  <div class="horizontal-scroll-wrapper">
    <button class="scroll-btn scroll-btn-left" onclick="scrollHorizontal('latestMovies', 'left')" aria-label="Cu·ªôn tr√°i">‚Äπ</button>
    <div class="horizontal-scroll-cards" id="latestMovies">
      {% for m in latest_movies %}
      <div class="card">
        <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
          <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
          <div class="card-content">
            <div class="card-title">{{ m.title }}</div>
            <div class="card-meta">
              {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
              {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
            </div>
            {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
            <div class="movie-rating" data-movie-id="{{ m.id }}">
              <span class="rating-stars">
                {% if m.avgRating and m.avgRating > 0 %}
                  ‚≠ê {{ "%.1f"|format(m.avgRating) }}
                {% else %}
                  ‚≠ê 0.0
                {% endif %}
              </span>
              {% if m.viewCount and m.viewCount > 0 %}
              <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">
                üëÅÔ∏è {{ m.viewCount }}
              </span>
              {% endif %}
            </div>
          </div>
        </a>
        <div class="action-buttons">
          <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="watchlist-icon">üìã</span>
          </button>
          <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="favorite-icon">ü§ç</span>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button class="scroll-btn scroll-btn-right" onclick="scrollHorizontal('latestMovies', 'right')" aria-label="Cu·ªôn ph·∫£i">‚Ä∫</button>
  </div>
</section>
{% endif %}

<!-- ƒê√£ x√≥a Cold Start section ri√™ng bi·ªát - merge v√†o Personalized section -->

<!-- 3. Unified Recommendations Section (Cold Start + Personalized) -->
{% if not genre_filter %}
<section class="personalized-section">
  <div class="section-header">
    <h3 id="recommendationTitle">üéØ G·ª£i √Ω c√° nh√¢n cho b·∫°n</h3>
    <div class="section-subtitle" id="recommendationSubtitle" style="display: none;">
      <span class="badge" id="recommendationBadge">M·ªõi</span>
      <span class="interaction-count" id="interactionCount">ƒêang ki·ªÉm tra...</span>
    </div>
    <div class="section-actions" id="sectionActions">
      <button class="refresh-recommendations-btn" onclick="refreshRecommendations()" id="refreshBtn">
        <span class="refresh-icon">üîÑ</span>
        <span class="refresh-text">L√†m m·ªõi g·ª£i √Ω</span>
      </button>
    </div>
    <!-- ‚úÖ ·∫®n model status bar -->
    <div class="model-status" id="modelStatus" style="display: none;">
      <span id="modelInfo">ƒêang t·∫£i th√¥ng tin model...</span>
      <span id="hybridStatus" style="margin-left: 10px; padding: 2px 8px; border-radius: 4px; background: rgba(76, 175, 80, 0.1); color: #4CAF50; font-weight: bold; display: none;">
        üîÄ Hybrid Active
      </span>
    </div>
  </div>
  <div class="personalized-cards-wrapper">
    <button class="scroll-btn scroll-btn-left" id="personalizedScrollLeft" onclick="scrollPersonalizedCards('left')" aria-label="Cu·ªôn tr√°i">
      ‚Äπ
    </button>
    <div class="personalized-cards" id="personalizedCards">
      <!-- Recommendations s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript v·ªõi cache -->
    </div>
    <div class="personalized-loading" id="personalizedLoading" style="text-align: center; padding: 40px; display: none;">
      <div class="loading-spinner">‚è≥</div>
      <p>ƒêang t·∫°o g·ª£i √Ω c√° nh√¢n h√≥a...</p>
    </div>
    <div class="personalized-empty" id="personalizedEmpty" style="text-align: center; padding: 40px; display: none;">
      <div class="empty-icon">üé¨</div>
      <h4>Ch∆∞a c√≥ g·ª£i √Ω c√° nh√¢n</h4>
      <p>H√£y ƒë√°nh gi√° m·ªôt s·ªë phim ƒë·ªÉ nh·∫≠n g·ª£i √Ω c√° nh√¢n d·ª±a tr√™n s·ªü th√≠ch c·ªßa b·∫°n!</p>
      <button class="btn btn-primary" onclick="generateRecommendations()">
        T·∫°o g·ª£i √Ω ngay
      </button>
    </div>
    <button class="scroll-btn scroll-btn-right" id="personalizedScrollRight" onclick="scrollPersonalizedCards('right')" aria-label="Cu·ªôn ph·∫£i">
      ‚Ä∫
    </button>
  </div>
</section>
{% endif %}

<!-- 2.5. Phim xem g·∫ßn ƒë√¢y -->
{% if not genre_filter and recent_watched %}
<section>
  <div class="section-header">
    <h3>üì∫ Xem g·∫ßn ƒë√¢y</h3>
    <p class="section-subtitle">Ti·∫øp t·ª•c xem phim c·ªßa b·∫°n</p>
  </div>
  <div class="horizontal-scroll-wrapper">
    <button class="scroll-btn scroll-btn-left" onclick="scrollHorizontal('recentWatched', 'left')" aria-label="Cu·ªôn tr√°i">‚Äπ</button>
    <div class="horizontal-scroll-cards" id="recentWatched">
      {% for m in recent_watched %}
      <div class="card">
        <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
          <div class="poster" style="background-image:url('{{ m.poster }}')">
            <!-- Badge hi·ªÉn th·ªã tr·∫°ng th√°i ho√†n th√†nh -->
            {% if m.isCompleted %}
            <div class="completed-badge" style="position: absolute; top: 8px; right: 8px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
              ‚úÖ Ho√†n th√†nh
            </div>
            {% elif m.progressPercent > 0 %}
            <div class="progress-badge" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
              {{ "%.0f"|format(m.progressPercent) }}%
            </div>
            {% endif %}
          </div>
          <div class="card-content">
            <div class="card-title">{{ m.title }}</div>
            <div class="card-meta">
              {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
              {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
            </div>
            {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
            <div class="watch-info" style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; font-size: 0.75rem;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <strong>üìä ƒê√£ xem:</strong> 
                  <span style="color: #4CAF50; font-weight: bold;">{{ m.watchCount }} l·∫ßn</span>
                </div>
                {% if m.progressPercent > 0 and not m.isCompleted %}
                <span style="color: #FF9800;">‚è≥ {{ "%.0f"|format(m.progressPercent) }}%</span>
                {% endif %}
              </div>
              {% if m.lastWatchedAt %}
              <div style="margin-top: 4px; color: #999; font-size: 0.7rem;">
                üïí Xem l·∫ßn cu·ªëi: {{ m.lastWatchedAt.strftime('%d/%m/%Y %H:%M') if m.lastWatchedAt else 'N/A' }}
              </div>
              {% endif %}
            </div>
          </div>
        </a>
        <div class="action-buttons">
          <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="watchlist-icon">üìã</span>
          </button>
          <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="favorite-icon">ü§ç</span>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button class="scroll-btn scroll-btn-right" onclick="scrollHorizontal('recentWatched', 'right')" aria-label="Cu·ªôn ph·∫£i">‚Ä∫</button>
  </div>
</section>
{% endif %}

<!-- 3. Phim trending (ƒë∆∞·ª£c ƒë√°nh gi√° nhi·ªÅu nh·∫•t) -->
{% if not genre_filter and trending_movies %}
<section>
  <div class="section-header">
    <h3>üî• Phim ƒëang th·ªãnh h√†nh</h3>
    <p class="section-subtitle">Nh·ªØng b·ªô phim ƒë∆∞·ª£c ƒë√°nh gi√° nhi·ªÅu nh·∫•t</p>
  </div>
  <div class="horizontal-scroll-wrapper">
    <button class="scroll-btn scroll-btn-left" onclick="scrollHorizontal('trendingMovies', 'left')" aria-label="Cu·ªôn tr√°i">‚Äπ</button>
    <div class="horizontal-scroll-cards" id="trendingMovies">
      {% for m in trending_movies %}
      <div class="card">
        <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
          <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
          <div class="card-content">
            <div class="card-title">{{ m.title }}</div>
            <div class="card-meta">
              {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
              {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
            </div>
            {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
            <div class="movie-rating" data-movie-id="{{ m.id }}">
              <span class="rating-stars">
                {% if m.avgRating and m.avgRating > 0 %}
                  ‚≠ê {{ "%.1f"|format(m.avgRating) }}
                {% else %}
                  ‚≠ê 0.0
                {% endif %}
              </span>
              {% if m.viewCount and m.viewCount > 0 %}
              <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">
                üëÅÔ∏è {{ m.viewCount }}
              </span>
              {% endif %}
            </div>
          </div>
        </a>
        <div class="action-buttons">
          <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="watchlist-icon">üìã</span>
          </button>
          <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}">
            <span class="favorite-icon">ü§ç</span>
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
    <button class="scroll-btn scroll-btn-right" onclick="scrollHorizontal('trendingMovies', 'right')" aria-label="Cu·ªôn ph·∫£i">‚Ä∫</button>
  </div>
</section>
{% endif %}

<!-- 3. T·∫•t c·∫£ phim (c√≥ ph√¢n trang) -->
{% if all_movies %}
<section class="all-movies movies-section">
  <div class="section-header">
    {% if search_query %}
      <h3>üîç K·∫øt qu·∫£ t√¨m ki·∫øm cho "{{ search_query }}"</h3>
    {% elif genre_filter %}
      <h3>üé¨ Phim {{ genre_filter }}</h3>
    {% else %}
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h3>üé¨ T·∫•t c·∫£ phim</h3>
        <a href="{{ url_for('main.all_movies') }}" class="btn-view-all">
          Xem t·∫•t c·∫£ ‚Üí
        </a>
      </div>
    {% endif %}
  </div>
  
  <!-- Filter Section (ch·ªâ hi·ªÉn th·ªã khi c√≥ genre filter ho·∫∑c search) -->
  {% if genre_filter or search_query %}
  <div class="filter-section" style="background: #0b1020; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
    <form method="GET" action="{{ url_for('main.home') }}" id="filterForm">
      <input type="hidden" name="genre" value="{{ genre_filter }}">
      <input type="hidden" name="q" value="{{ search_query }}">
      <div class="filter-row" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <div class="filter-group" style="display: flex; flex-direction: column; gap: 8px; min-width: 150px;">
          <label for="sort" style="color: #e7e9ee; font-size: 0.85rem; font-weight: 500;">S·∫Øp x·∫øp theo</label>
          <select name="sort" id="sort" class="filter-select" onchange="document.getElementById('filterForm').submit()" style="background: #141a28; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 12px; color: #e7e9ee; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease;">
            <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>M·ªõi nh·∫•t</option>
            <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>C≈© nh·∫•t</option>
            <option value="views" {% if sort_by == 'views' %}selected{% endif %}>L∆∞·ª£t xem nhi·ªÅu nh·∫•t</option>
            <option value="ratings" {% if sort_by == 'ratings' %}selected{% endif %}>ƒê√°nh gi√° cao nh·∫•t</option>
            <option value="title_asc" {% if sort_by == 'title_asc' %}selected{% endif %}>T√™n A-Z</option>
            <option value="title_desc" {% if sort_by == 'title_desc' %}selected{% endif %}>T√™n Z-A</option>
          </select>
        </div>
        
        {% if year_list %}
        <div class="filter-group" style="display: flex; flex-direction: column; gap: 8px; min-width: 150px;">
          <label for="year" style="color: #e7e9ee; font-size: 0.85rem; font-weight: 500;">NƒÉm ph√°t h√†nh</label>
          <select name="year" id="year" class="filter-select" onchange="document.getElementById('filterForm').submit()" style="background: #141a28; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; padding: 10px 12px; color: #e7e9ee; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease;">
            <option value="">T·∫•t c·∫£ nƒÉm</option>
            {% for year in year_list %}
            <option value="{{ year }}" {% if year_filter|string == year|string %}selected{% endif %}>{{ year }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}
        
        <div class="filter-actions" style="display: flex; gap: 10px; margin-left: auto;">
          <button type="button" class="btn-filter btn-filter-reset" onclick="resetFilters()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background: #141a28; color: #e7e9ee; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
            üîÑ ƒê·∫∑t l·∫°i
          </button>
        </div>
      </div>
    </form>
  </div>
  {% endif %}
  
  <div class="cards movies-grid">
    {% for m in all_movies %}
    <div class="card">
      <a href="{{ url_for('main.detail', movie_id=m.id) }}" class="card-link">
        <div class="poster" style="background-image:url('{{ m.poster }}')"></div>
        <div class="card-content">
          <div class="card-title">{{ m.title }}</div>
          <div class="card-meta">
            {% if m.releaseYear %}<span class="year">{{ m.releaseYear }}</span>{% endif %}
            {% if m.country %}<span class="country">{{ m.country }}</span>{% endif %}
          </div>
          {% if m.genres %}<div class="card-genres">{{ m.genres }}</div>{% endif %}
          <div class="movie-rating" data-movie-id="{{ m.id }}">
            <span class="rating-stars">
              {% if m.avgRating and m.avgRating > 0 %}
                ‚≠ê {{ "%.1f"|format(m.avgRating) }}
              {% else %}
                ‚≠ê 0.0
              {% endif %}
            </span>
            <span class="rating-count">
              {% if m.ratingCount and m.ratingCount > 0 %}
                ({{ m.ratingCount }})
              {% else %}
                (0)
              {% endif %}
            </span>
            {% if m.viewCount and m.viewCount > 0 %}
            <span class="view-count" style="margin-left: 8px; color: #888; font-size: 0.9em;">
              üëÅÔ∏è {{ m.viewCount }}
            </span>
            {% endif %}
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist({{ m.id }}, event)" data-movie-id="{{ m.id }}">
          <span class="watchlist-icon">üìã</span>
        </button>
        <button class="favorite-btn" onclick="toggleFavorite({{ m.id }}, event)" data-movie-id="{{ m.id }}">
          <span class="favorite-icon">ü§ç</span>
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Pagination -->
  {% from 'macros/pagination_simple.html' import render_smart_pagination %}
  {{ render_smart_pagination(pagination, 'main.home', q=search_query, genre=genre_filter, sort=sort_by, year=year_filter) }}
</section>
{% endif %}

<style>
/* CSS Variables */
:root {
  --primary: #3b82f6;
  --primary-2: #8b5cf6;
  --panel: rgba(255, 255, 255, 0.05);
  --text-primary: #fff;
  --text-secondary: #ccc;
  --text-muted: #888;
  --border: rgba(255, 255, 255, 0.1);
  --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Base Container Responsive */
@media (max-width: 768px) {
  .container {
    padding: 0 15px;
  }
}

@media (max-width: 480px) {
  .container {
    padding: 0 10px;
  }
}

/* Refresh Recommendations Button */
.section-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.refresh-recommendations-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 25px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  position: relative;
  overflow: hidden;
}

.refresh-recommendations-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

.refresh-recommendations-btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.refresh-recommendations-btn.loading {
  pointer-events: none;
  opacity: 0.7;
}

.refresh-recommendations-btn.loading .refresh-icon {
  animation: spin 1s linear infinite;
}

.refresh-icon {
  font-size: 1.1rem;
  transition: transform 0.3s ease;
}

.refresh-text {
  font-size: 0.9rem;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Section Header Responsive */
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 15px;
}

@media (max-width: 768px) {
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .section-actions {
    width: 100%;
    justify-content: flex-end;
  }
  
  .refresh-recommendations-btn {
    padding: 8px 14px;
    font-size: 0.85rem;
  }
}

@media (max-width: 480px) {
  .refresh-recommendations-btn {
    width: 100%;
    justify-content: center;
    padding: 10px 16px;
  }
}

/* Hybrid Badge Styling */
.hybrid-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.rec-reason {
  margin-top: 4px;
  color: #888;
  font-size: 0.8rem;
  line-height: 1.2;
}

/* Loading States */
.personalized-loading, .personalized-empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
}

.loading-spinner {
  font-size: 2rem;
  animation: spin 1s linear infinite;
  margin-bottom: 10px;
}

.error-state {
  grid-column: 1 / -1;
}

.error-icon {
  font-size: 3rem;
  margin-bottom: 15px;
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 15px;
}

/* Hero Section */
.hero {
  position: relative;
  min-height: 65vh;
  margin-bottom: 30px;
  border-radius: 15px;
  overflow: hidden;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  width: 100%;
  max-width: 100%;
}

.hero-carousel {
  position: relative;
  width: 100%;
  height: 100%;
  min-height: 65vh;
  overflow: hidden;
}

.hero-slide {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  transition: opacity 1s ease-in-out;
}

.hero-slide.active {
  opacity: 1;
}

.hero-backdrop {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  filter: blur(3px);
  transform: scale(1.1);
}

.hero-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.4));
  z-index: 1;
}

.hero-content {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  min-height: 65vh;
  padding: 30px;
  max-width: 1000px;
  margin: 0 auto;
  gap: 30px;
}

.hero-poster {
  flex-shrink: 0;
  width: 220px;
  height: 330px;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.1);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
}

.hero-poster::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, rgba(255, 107, 107, 0.1), rgba(255, 255, 255, 0.05));
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1;
}

.hero-poster:hover {
  transform: scale(1.08) translateY(-5px);
  box-shadow: 0 30px 70px rgba(0, 0, 0, 0.8), 0 0 0 2px rgba(255, 107, 107, 0.3);
}

.hero-poster:hover::before {
  opacity: 1;
}

.poster-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 2;
}

.hero-poster:hover .poster-img {
  transform: scale(1.05);
}

.hero-text {
  flex: 1;
  color: white;
}

.badge {
  display: inline-block;
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  padding: 10px 20px;
  border-radius: 30px;
  font-size: 0.95rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 25px;
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
  position: relative;
  overflow: hidden;
}

.badge::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s ease;
}

.badge:hover::before {
  left: 100%;
}

.hero-text h1 {
  font-size: 2.8rem;
  font-weight: 800;
  margin: 0 0 15px 0;
  line-height: 1.1;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  background: linear-gradient(135deg, #fff, #e0e0e0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero-description {
  font-size: 1.1rem;
  line-height: 1.5;
  margin: 0 0 25px 0;
  color: rgba(255, 255, 255, 0.9);
  max-width: 500px;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.hero-actions {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 60px; /* Add space to prevent overlap with carousel controls */
}

.hero-actions .btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 18px 35px;
  font-size: 1.15rem;
  font-weight: 700;
  border-radius: 50px;
  text-decoration: none;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  position: relative;
  overflow: hidden;
}

.hero-actions .btn-primary {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  color: white;
  border: none;
}

.hero-actions .btn-primary:hover {
  transform: translateY(-5px) scale(1.05);
  box-shadow: 0 15px 40px rgba(255, 107, 107, 0.5);
  background: linear-gradient(135deg, #ff7b7b, #ff6b24);
}

.hero-actions .btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  backdrop-filter: blur(10px);
}

.hero-actions .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.6);
  transform: translateY(-5px) scale(1.05);
  box-shadow: 0 15px 40px rgba(255, 255, 255, 0.2);
}

.btn-icon {
  font-size: 1.2rem;
}

/* Carousel Controls */
.carousel-controls {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 40px;
  z-index: 10;
}

.carousel-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 1.5rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
}

.carousel-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
  transform: scale(1.1);
}

.carousel-dots {
  display: flex;
  gap: 8px;
}

.dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: none;
  background: rgba(255, 255, 255, 0.4);
  cursor: pointer;
  transition: all 0.3s ease;
}

.dot.active {
  background: #ff6b6b;
  transform: scale(1.2);
}

.dot:hover {
  background: rgba(255, 255, 255, 0.7);
}

/* Responsive Design */
@media (max-width: 1024px) {
  .hero {
    min-height: 60vh;
  }
  
  .hero-content {
    min-height: 60vh;
    padding: 25px;
    gap: 25px;
  }
  
  .hero-poster {
    width: 200px;
    height: 300px;
  }
}

@media (max-width: 768px) {
  .hero {
    min-height: 50vh;
    margin-bottom: 20px;
  }
  
  .hero-content {
    flex-direction: column;
    text-align: center;
    padding: 20px;
    gap: 20px;
    min-height: 50vh;
  }
  
  .hero-poster {
    width: 180px;
    height: 270px;
  }
  
  .hero-text h1 {
    font-size: 2.5rem;
  }
  
  .hero-description {
    font-size: 1rem;
    margin-bottom: 20px;
  }
  
  .hero-actions {
    justify-content: center;
    margin-bottom: 40px;
  }
  
  .hero-actions .btn {
    padding: 15px 25px;
    font-size: 1rem;
  }
  
  .carousel-controls {
    bottom: 10px;
    gap: 30px;
  }
  
  .carousel-btn {
    width: 35px;
    height: 35px;
    font-size: 1.2rem;
  }
  
  .dot {
    width: 10px;
    height: 10px;
  }
}

@media (max-width: 480px) {
  .hero {
    min-height: 45vh;
    border-radius: 10px;
  }
  
  .hero-content {
    padding: 15px;
    gap: 15px;
    min-height: 45vh;
  }
  
  .hero-poster {
    width: 150px;
    height: 225px;
  }
  
  .hero-text h1 {
    font-size: 2rem;
    margin-bottom: 10px;
  }
  
  .hero-description {
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.4;
  }
  
  .hero-actions {
    flex-direction: column;
    gap: 10px;
    margin-bottom: 30px;
  }
  
  .hero-actions .btn {
    padding: 12px 20px;
    font-size: 0.9rem;
    width: 100%;
    max-width: 250px;
  }
  
  .carousel-controls {
    bottom: 5px;
    gap: 20px;
  }
  
  .carousel-btn {
    width: 30px;
    height: 30px;
    font-size: 1rem;
  }
  
  .dot {
    width: 8px;
    height: 8px;
  }
}

@media (max-width: 360px) {
  .hero {
    min-height: 40vh;
  }
  
  .hero-content {
    padding: 10px;
    min-height: 40vh;
  }
  
  .hero-poster {
    width: 120px;
    height: 180px;
  }
  
  .hero-text h1 {
    font-size: 1.8rem;
  }
  
  .hero-description {
    font-size: 0.85rem;
  }
  
  .hero-actions .btn {
    padding: 10px 15px;
    font-size: 0.85rem;
  }
}

/* Genre Filter Section */
.genre-filter {
  margin: 20px 0 40px 0;
  padding: 20px 0;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
  border-radius: 15px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.genre-filter-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.genre-filter h3 {
  color: #fff;
  font-size: 1.3rem;
  margin: 0 0 20px 0;
  text-align: center;
  font-weight: 600;
}

.genre-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.genre-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  text-decoration: none;
  border-radius: 25px;
  font-weight: 500;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  backdrop-filter: blur(10px);
}

.genre-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  color: #fff;
  text-decoration: none;
}

.genre-btn.active {
  background: linear-gradient(135deg, #ff6b35, #f7931e);
  border-color: #ff6b35;
  box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
  color: #fff;
  font-weight: 600;
}

.genre-btn.active:hover {
  background: linear-gradient(135deg, #ff7b45, #ffa31e);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
}

/* Responsive */
@media (max-width: 768px) {
  .genre-buttons {
    gap: 8px;
  }
  
  .genre-btn {
    padding: 10px 16px;
    font-size: 0.9rem;
  }
  
  .genre-filter h3 {
    font-size: 1.1rem;
  }
}

/* All Movies Section */
.all-movies {
  margin: 40px 0;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-header h3 {
  color: #fff;
  font-size: 1.5rem;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.section-subtitle {
  color: #888;
  font-size: 0.9rem;
  margin: 5px 0 0 0;
}

.card-content {
  padding: 15px;
}

.card-meta {
  display: flex;
  gap: 10px;
  margin: 8px 0;
  font-size: 0.85rem;
  color: #888;
}

.card-meta .year {
  background: #333;
  padding: 2px 6px;
  border-radius: 4px;
  color: #fff;
}

.card-meta .country {
  color: #888;
}

.card-genres {
  font-size: 0.8rem;
  color: #aaa;
  margin: 8px 0;
  line-height: 1.3;
}

.recommendation-info {
  display: flex;
  gap: 15px;
  margin: 10px 0;
  font-size: 0.85rem;
}

.recommendation-status {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-right: 15px;
}

.status-indicator {
  font-size: 0.9rem;
  padding: 4px 8px;
  border-radius: 12px;
  background: #2c3e50;
  color: white;
  font-weight: 500;
}

.status-text {
  font-size: 0.8rem;
  color: #666;
  font-style: italic;
}

.rec-score {
  color: #4CAF50;
  font-weight: 600;
}

.rec-rank {
  color: #2196F3;
  font-weight: 600;
}

.trending-info {
  display: flex;
  gap: 15px;
  margin: 10px 0;
  font-size: 0.85rem;
}

.rating-count {
  color: #888;
}

.avg-rating {
  color: #FFD700;
  font-weight: 600;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  margin: 20px 0;
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 15px;
}

.empty-state h4 {
  color: #fff;
  margin: 0 0 10px 0;
  font-size: 1.2rem;
}

.empty-state p {
  color: #888;
  margin: 0 0 20px 0;
  line-height: 1.5;
}

.section-info {
  color: #888;
  font-size: 0.9rem;
}

.movie-count {
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 12px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
}

.card-content {
  padding: 12px;
}

.card-meta {
  margin: 5px 0;
  font-size: 0.8rem;
}

.upload-time {
  color: #4CAF50;
  font-weight: bold;
  background: rgba(76, 175, 80, 0.1);
  padding: 2px 8px;
  border-radius: 8px;
}

.movie-rating {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 5px;
  font-size: 0.9rem;
}

.rating-stars {
  color: #ffc107;
  font-weight: bold;
}

.rating-count {
  color: #ccc;
  font-size: 0.8rem;
}

/* View All Button */
.btn-view-all {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: linear-gradient(135deg, var(--primary), var(--primary-2));
  color: #fff;
  text-decoration: none;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.btn-view-all:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
  background: linear-gradient(135deg, var(--primary-2), var(--primary));
}

/* Pagination Styles */
.pagination {
  margin-top: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.pagination-info {
  color: #888;
  font-size: 0.9rem;
  display: flex;
  gap: 10px;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 15px;
}

.btn-pagination {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  padding: 8px 16px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-pagination:hover:not(.disabled) {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.4);
  transform: translateY(-1px);
}

.btn-pagination.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.page-numbers {
  display: flex;
  gap: 5px;
  align-items: center;
}

.page-number {
  display: inline-block;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  text-decoration: none;
  border-radius: 6px;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  min-width: 40px;
  text-align: center;
}

.page-number:hover:not(.current) {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-1px);
}

.page-number.current {
  background: #e50914;
  color: #fff;
  font-weight: bold;
}

.page-ellipsis {
  color: #888;
  padding: 8px 4px;
  font-size: 0.9rem;
}

/* Responsive */
@media (max-width: 768px) {
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .pagination {
    margin: 20px 0;
  }
  
  .pagination-info {
    margin-bottom: 15px;
    text-align: center;
  }
  
  .pagination-controls {
    flex-direction: column;
    gap: 15px;
  }
  
  .page-numbers {
    flex-wrap: wrap;
    justify-content: center;
    gap: 3px;
  }
  
  .btn-pagination {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
  
  .page-number {
    padding: 8px 10px;
    font-size: 0.85rem;
    min-width: 35px;
  }
}

@media (max-width: 480px) {
  .pagination {
    margin: 15px 0;
  }
  
  .pagination-info {
    font-size: 0.9rem;
  }
  
  .pagination-controls {
    gap: 10px;
  }
  
  .btn-pagination {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
  
  .page-number {
    padding: 6px 8px;
    font-size: 0.8rem;
    min-width: 30px;
  }
  
  .page-ellipsis {
    font-size: 0.8rem;
    padding: 6px 2px;
  }
}

/* AJAX Loading States */
.movies-grid {
  transition: opacity 0.3s ease;
}

.movies-grid.loading {
  opacity: 0.7;
}

.genre-btn {
  transition: all 0.3s ease;
}

.genre-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.page-number {
  transition: all 0.3s ease;
}

.page-number:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
}

/* Card Styles */
.card {
  position: relative;
  background: var(--panel);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid var(--border);
  backdrop-filter: blur(10px);
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border-color: var(--primary);
}

.action-buttons {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 8px;
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.card:hover .action-buttons {
  opacity: 1;
}

.favorite-btn, .watchlist-btn {
  background: rgba(0, 0, 0, 0.8);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow);
}

.favorite-btn:hover, .watchlist-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  transform: scale(1.1);
}

.favorite-btn.favorited {
  background: linear-gradient(135deg, #ff6b6b, #ee5a24);
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}

.favorite-btn.favorited:hover {
  background: linear-gradient(135deg, #ff7b7b, #ff6b24);
  transform: scale(1.15);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
}

.watchlist-btn.watchlisted {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
}

.watchlist-btn.watchlisted:hover {
  background: linear-gradient(135deg, #5cbf60, #4CAF50);
  transform: scale(1.15);
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
}

.favorite-icon, .watchlist-icon {
  font-size: 18px;
  transition: all 0.3s ease;
}

.card-link {
  text-decoration: none;
  color: inherit;
  display: block;
  width: 100%;
  height: 100%;
}

.card-link:hover {
  text-decoration: none;
  color: inherit;
}

.poster {
  width: 100%;
  height: 280px;
  background-size: cover;
  background-position: center;
  border-radius: 8px;
  margin-bottom: 10px;
  transition: transform 0.3s ease;
}

.card:hover .poster {
  transform: scale(1.05);
}

.card-title {
  color: var(--text-primary);
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 0.9em;
  line-height: 1.3;
  padding: 0 10px;
}

.card-content {
  padding: 12px;
}

.card-meta {
  margin: 5px 0;
  font-size: 0.8rem;
  padding: 0 10px;
}

.upload-time {
  color: #4CAF50;
  font-weight: bold;
  background: rgba(76, 175, 80, 0.1);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.75rem;
}

/* Cards Grid Layout */
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.movies-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

/* Personalized Recommendations Horizontal Scroll */
.personalized-section {
  margin: 40px 0;
}

.personalized-cards-wrapper {
  position: relative;
  margin: 20px 0;
}

.personalized-cards {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding: 10px 0;
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  -ms-overflow-style: -ms-autohiding-scrollbar;
}

.personalized-cards::-webkit-scrollbar {
  height: 8px;
}

.personalized-cards::-webkit-scrollbar-track {
  background: transparent;
}

.personalized-cards::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
}

.personalized-cards::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

.personalized-cards .card {
  flex: 0 0 200px;
  min-width: 200px;
  max-width: 200px;
}

/* Horizontal Scroll Wrapper - D√πng cho t·∫•t c·∫£ c√°c ph·∫ßn */
.horizontal-scroll-wrapper {
  position: relative;
  margin: 20px 0;
}

.horizontal-scroll-cards {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-behavior: smooth;
  padding: 10px 0;
  scrollbar-width: thin;
  scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  -ms-overflow-style: -ms-autohiding-scrollbar;
}

.horizontal-scroll-cards::-webkit-scrollbar {
  height: 8px;
}

.horizontal-scroll-cards::-webkit-scrollbar-track {
  background: transparent;
}

.horizontal-scroll-cards::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
}

.horizontal-scroll-cards::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

.horizontal-scroll-cards .card {
  flex: 0 0 200px;
  min-width: 200px;
  max-width: 200px;
}

.scroll-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.scroll-btn:hover {
  background: rgba(0, 0, 0, 0.9);
  border-color: rgba(255, 255, 255, 0.6);
  transform: translateY(-50%) scale(1.1);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
}

.scroll-btn:active {
  transform: translateY(-50%) scale(0.95);
}

.scroll-btn-left {
  left: -25px;
}

.scroll-btn-right {
  right: -25px;
}

.scroll-btn.hidden {
  opacity: 0;
  pointer-events: none;
}

/* Responsive for personalized cards */
@media (max-width: 768px) {
  .personalized-cards .card {
    flex: 0 0 150px;
    min-width: 150px;
    max-width: 150px;
  }
  
  .scroll-btn {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }
  
  .scroll-btn-left {
    left: -20px;
  }
  
  .scroll-btn-right {
    right: -20px;
  }
}

@media (max-width: 480px) {
  .personalized-cards .card {
    flex: 0 0 120px;
    min-width: 120px;
    max-width: 120px;
  }
  
  .scroll-btn {
    width: 35px;
    height: 35px;
    font-size: 18px;
  }
  
  .scroll-btn-left {
    left: -15px;
  }
  
  .scroll-btn-right {
    right: -15px;
  }
}

/* Genre Filter Responsive */
@media (max-width: 768px) {
  .genre-filter {
    margin: 15px 0 30px 0;
    padding: 15px 0;
  }
  
  .genre-filter-container {
    padding: 0 15px;
  }
  
  .genre-filter h3 {
    font-size: 1.1rem;
    margin-bottom: 15px;
  }
  
  .genre-buttons {
    gap: 8px;
  }
  
  .genre-btn {
    padding: 8px 16px;
    font-size: 0.85rem;
  }
}

@media (max-width: 480px) {
  .genre-filter {
    margin: 10px 0 20px 0;
    padding: 10px 0;
  }
  
  .genre-filter-container {
    padding: 0 10px;
  }
  
  .genre-filter h3 {
    font-size: 1rem;
    margin-bottom: 10px;
  }
  
  .genre-buttons {
    gap: 6px;
  }
  
  .genre-btn {
    padding: 6px 12px;
    font-size: 0.8rem;
  }
}

/* Responsive Grid */
@media (max-width: 768px) {
  .cards, .movies-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
  }
}

@media (max-width: 480px) {
  .cards, .movies-grid {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }
}

/* Cold Start Section Styles */
.cold-start-section {
  background: linear-gradient(135deg, rgba(78, 205, 196, 0.1) 0%, rgba(255, 107, 107, 0.1) 100%);
  border: 1px solid rgba(78, 205, 196, 0.3);
  border-radius: 15px;
  padding: 30px;
  margin-bottom: 40px;
}

.section-subtitle {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-top: 10px;
}

.section-header .section-subtitle {
  margin-top: 5px;
  margin-bottom: 0;
}

.cold-start-badge {
  background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Badge trong section header */
.section-subtitle .badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.section-subtitle .cold-start-badge {
  background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
  color: white;
}

.interaction-count {
  color: #4ecdc4;
  font-size: 0.9rem;
  font-weight: 500;
}

.recommendation-info {
  margin: 10px 0;
  padding: 8px 12px;
  background: rgba(78, 205, 196, 0.1);
  border-radius: 8px;
  border-left: 3px solid #4ecdc4;
}

.rec-score {
  font-weight: bold;
  color: #4ecdc4;
  font-size: 0.9rem;
}

.rec-rank {
  font-weight: bold;
  color: #ff6b6b;
  font-size: 0.8rem;
}

.debug-info {
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px solid rgba(78, 205, 196, 0.3);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2px;
}

.debug-info div {
  font-size: 0.7rem;
  color: #666;
}

.rec-badge {
  display: inline-block;
  background: #4ecdc4;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-bottom: 5px;
}

.rec-reason {
  font-size: 0.8rem;
  color: #b0b0b0;
  font-style: italic;
}

.cold-start-loading {
  text-align: center;
  padding: 40px;
  color: #4ecdc4;
}

.loading-spinner {
  font-size: 2rem;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Responsive design for cold start */
@media (max-width: 768px) {
  .cold-start-section {
    padding: 20px;
    margin-bottom: 30px;
  }
  
  .section-subtitle {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .recommendation-info {
    padding: 6px 10px;
  }
}
</style>

<script>
// AJAX Pagination, Genre Filter, and Search
document.addEventListener('DOMContentLoaded', function() {
    // Attach pagination listeners
    attachPaginationListeners();
    
    // Attach genre filter listeners
    attachGenreFilterListeners();
    
    // Attach search listeners
    attachSearchListeners();
    
    // Check favorite and watchlist status for all movies on page load
    checkAllStatus();
    
    // Load ratings for all movies
    // loadAllRatings(); // disabled for consistent server-rendered ratings
});

function attachGenreFilterListeners() {
    const genreLinks = document.querySelectorAll('.genre-btn');
    
    genreLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const genre = this.getAttribute('data-genre');
            
            // N·∫øu l√† "T·∫•t c·∫£" th√¨ d√πng AJAX, c√°c th·ªÉ lo·∫°i kh√°c th√¨ chuy·ªÉn trang
            if (genre === 'all') {
                e.preventDefault();
                
                const url = this.href;
                
                // Show loading indicator
                showLoading();
                
                // Add loading class to movies grid
                const moviesGrid = document.querySelector('.movies-grid');
                if (moviesGrid) {
                    moviesGrid.classList.add('loading');
                }
                
                // Fetch new page content
                fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Parse the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update the movies grid
                    const newMoviesGrid = doc.querySelector('.movies-grid');
                    const currentMoviesGrid = document.querySelector('.movies-grid');
                    if (newMoviesGrid && currentMoviesGrid) {
                        currentMoviesGrid.innerHTML = newMoviesGrid.innerHTML;
                        // Check favorite and watchlist status for new movies
                        checkAllFavoriteStatus();
                        checkAllWatchlistStatus();
                        // loadAllRatings(); // disabled
                    }
                    
                    // Update pagination
                    const newPagination = doc.querySelector('.pagination-controls');
                    const currentPagination = document.querySelector('.pagination-controls');
                    if (newPagination && currentPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                        // Re-attach event listeners to new pagination links
                        attachPaginationListeners();
                    }
                    
                    // Update page info
                    const newPageInfo = doc.querySelector('.page-info');
                    const currentPageInfo = document.querySelector('.page-info');
                    if (newPageInfo && currentPageInfo) {
                        currentPageInfo.innerHTML = newPageInfo.innerHTML;
                    }
                    
                    // Update genre filter active state
                    const newGenreFilter = doc.querySelector('.genre-filter');
                    const currentGenreFilter = document.querySelector('.genre-filter');
                    if (newGenreFilter && currentGenreFilter) {
                        currentGenreFilter.innerHTML = newGenreFilter.innerHTML;
                        // Re-attach event listeners to new genre links
                        attachGenreFilterListeners();
                    }
                    
                    // Update section title
                    const newSectionTitle = doc.querySelector('.movies-section h3');
                    const currentSectionTitle = document.querySelector('.movies-section h3');
                    if (newSectionTitle && currentSectionTitle) {
                        currentSectionTitle.innerHTML = newSectionTitle.innerHTML;
                    }
                    
                    // Update section info
                    const newSectionInfo = doc.querySelector('.section-info');
                    const currentSectionInfo = document.querySelector('.section-info');
                    if (newSectionInfo && currentSectionInfo) {
                        currentSectionInfo.innerHTML = newSectionInfo.innerHTML;
                    }
                    
                    // Scroll to top of movies section
                    const moviesSection = document.querySelector('.movies-section');
                    if (moviesSection) {
                        moviesSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                    // Fallback to normal page reload
                    window.location.href = url;
                });
            } else {
                // C√°c th·ªÉ lo·∫°i kh√°c: chuy·ªÉn trang b√¨nh th∆∞·ªùng
                // Kh√¥ng preventDefault, ƒë·ªÉ link ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
            }
        });
    });
}

function attachPaginationListeners() {
    const paginationLinks = document.querySelectorAll('.pagination-controls a, .page-numbers a');
    
    paginationLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const url = this.href;
            
            // Show loading indicator
            showLoading();
            
            // Add loading class to movies grid
            const moviesGrid = document.querySelector('.movies-grid');
            if (moviesGrid) {
                moviesGrid.classList.add('loading');
            }
            
            // Fetch new page content
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Parse the response
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Update the movies grid
                    const newMoviesGrid = doc.querySelector('.movies-grid');
                    const currentMoviesGrid = document.querySelector('.movies-grid');
                    if (newMoviesGrid && currentMoviesGrid) {
                        currentMoviesGrid.innerHTML = newMoviesGrid.innerHTML;
                        // Check favorite and watchlist status for new movies
                        checkAllFavoriteStatus();
                        checkAllWatchlistStatus();
                        // loadAllRatings(); // disabled
                    }
                    
                    // Update pagination
                    const newPagination = doc.querySelector('.pagination');
                    const currentPagination = document.querySelector('.pagination');
                    if (newPagination && currentPagination) {
                        currentPagination.innerHTML = newPagination.innerHTML;
                        // Re-attach event listeners to new pagination links
                        attachPaginationListeners();
                    }
                    
                    // Update page info
                    const newPageInfo = doc.querySelector('.page-info');
                    const currentPageInfo = document.querySelector('.page-info');
                    if (newPageInfo && currentPageInfo) {
                        currentPageInfo.innerHTML = newPageInfo.innerHTML;
                    }
                    
                    // Scroll to top of movies section
                    const moviesSection = document.querySelector('.movies-section');
                    if (moviesSection) {
                        moviesSection.scrollIntoView({ behavior: 'smooth' });
                    }
                    
                    // Update URL without reload
                    window.history.pushState({}, '', url);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error loading page:', error);
                    
                    // Remove loading class
                    const moviesGrid = document.querySelector('.movies-grid');
                    if (moviesGrid) {
                        moviesGrid.classList.remove('loading');
                    }
                    
                    hideLoading();
                    // Fallback to normal page reload
                    window.location.href = url;
                });
        });
    });
}

function showLoading() {
    // Create loading overlay
    let loadingOverlay = document.getElementById('loading-overlay');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        
        const loadingSpinner = document.createElement('div');
        loadingSpinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        `;
        
        loadingOverlay.appendChild(loadingSpinner);
        document.body.appendChild(loadingOverlay);
        
        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    loadingOverlay.style.display = 'flex';
}

function hideLoading() {
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

function attachSearchListeners() {
    const searchInput = document.getElementById('headerSearchInput');
    const searchForm = document.querySelector('.search');
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = searchInput.value.trim();
            if (query.length < 2) {
                return;
            }
            
            // Redirect to search page with query
            const url = new URL(window.location.origin + '/search');
            url.searchParams.set('q', query);
            window.location.href = url.toString();
        });
    }
}

// Favorite functionality
function resetFilters() {
  const urlParams = new URLSearchParams(window.location.search);
  const genre = urlParams.get('genre');
  const q = urlParams.get('q');
  
  if (genre) {
    window.location.href = "{{ url_for('main.home') }}?genre=" + genre;
  } else if (q) {
    window.location.href = "{{ url_for('main.home') }}?q=" + q;
  } else {
    window.location.href = "{{ url_for('main.home') }}";
  }
}

function toggleFavorite(movieId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    fetch(`/toggle-favorite/${movieId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateFavoriteButton(movieId, data.is_favorite);
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i y√™u th√≠ch', 'error');
    });
}

// Watchlist functionality
function toggleWatchlist(movieId, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    fetch(`/toggle-watchlist/${movieId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateWatchlistButton(movieId, data.is_watchlist);
            showToast(data.message, 'success');
        } else {
            showToast(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('C√≥ l·ªói x·∫£y ra khi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i xem sau', 'error');
    });
}

function updateFavoriteButton(movieId, isFavorite) {
    const favoriteBtn = document.querySelector(`.favorite-btn[data-movie-id="${movieId}"]`);
    if (!favoriteBtn) {
        console.warn(`Favorite button not found for movie ${movieId}`);
        return;
    }
    
    const favoriteIcon = favoriteBtn.querySelector('.favorite-icon');
    if (!favoriteIcon) {
        console.warn(`Favorite icon not found for movie ${movieId}`);
        return;
    }
    
    if (isFavorite) {
        favoriteIcon.textContent = '‚ù§Ô∏è';
        favoriteBtn.classList.add('favorited');
    } else {
        favoriteIcon.textContent = 'ü§ç';
        favoriteBtn.classList.remove('favorited');
    }
}

function updateWatchlistButton(movieId, isWatchlist) {
    const watchlistBtn = document.querySelector(`.watchlist-btn[data-movie-id="${movieId}"]`);
    if (!watchlistBtn) {
        console.warn(`Watchlist button not found for movie ${movieId}`);
        return;
    }
    
    const watchlistIcon = watchlistBtn.querySelector('.watchlist-icon');
    if (!watchlistIcon) {
        console.warn(`Watchlist icon not found for movie ${movieId}`);
        return;
    }
    
    if (isWatchlist) {
        watchlistIcon.textContent = '‚úÖ';
        watchlistBtn.classList.add('watchlisted');
    } else {
        watchlistIcon.textContent = 'üìã';
        watchlistBtn.classList.remove('watchlisted');
    }
}

function checkFavoriteStatus(movieId) {
    fetch(`/check-favorite/${movieId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateFavoriteButton(movieId, data.is_favorite);
        }
    })
    .catch(error => {
        console.error('Error checking favorite status:', error);
    });
}

function checkWatchlistStatus(movieId) {
    fetch(`/check-watchlist/${movieId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateWatchlistButton(movieId, data.is_watchlist);
        }
    })
    .catch(error => {
        console.error('Error checking watchlist status:', error);
    });
}

function checkAllStatus() {
    // Thu th·∫≠p t·∫•t c·∫£ movie IDs
    const movieIds = [];
    const favoriteBtns = document.querySelectorAll('.favorite-btn');
    const watchlistBtns = document.querySelectorAll('.watchlist-btn');
    
    favoriteBtns.forEach(btn => {
        const movieId = btn.getAttribute('data-movie-id');
        if (movieId && !movieIds.includes(parseInt(movieId))) {
            movieIds.push(parseInt(movieId));
        }
    });
    
    watchlistBtns.forEach(btn => {
        const movieId = btn.getAttribute('data-movie-id');
        if (movieId && !movieIds.includes(parseInt(movieId))) {
            movieIds.push(parseInt(movieId));
        }
    });
    
    if (movieIds.length === 0) return;
    
    // G·ªçi batch API
    fetch('/batch-check-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            movie_ids: movieIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // C·∫≠p nh·∫≠t t·∫•t c·∫£ buttons
            Object.keys(data.data).forEach(movieId => {
                const status = data.data[movieId];
                updateFavoriteButton(parseInt(movieId), status.is_favorite);
                updateWatchlistButton(parseInt(movieId), status.is_watchlist);
            });
        }
    })
    .catch(error => {
        console.error('Error batch checking status:', error);
        // Fallback to individual checks
        checkAllFavoriteStatus();
        checkAllWatchlistStatus();
    });
}

function checkAllFavoriteStatus() {
    const favoriteBtns = document.querySelectorAll('.favorite-btn');
    favoriteBtns.forEach(btn => {
        const movieId = btn.getAttribute('data-movie-id');
        if (movieId) {
            checkFavoriteStatus(parseInt(movieId));
        }
    });
}

function checkAllWatchlistStatus() {
    const watchlistBtns = document.querySelectorAll('.watchlist-btn');
    watchlistBtns.forEach(btn => {
        const movieId = btn.getAttribute('data-movie-id');
        if (movieId) {
            checkWatchlistStatus(parseInt(movieId));
        }
    });
}

function showToast(message, type = 'success') {
    // Create toast if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2d3748;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease-in-out;
            max-width: 300px;
            border-left: 4px solid #48bb78;
        `;
        document.body.appendChild(toast);
    }
    
    // Update toast content and style
    toast.innerHTML = `<div class="toast-content">${message}</div>`;
    toast.className = `toast ${type}`;
    if (type === 'error') {
        toast.style.borderLeftColor = '#f56565';
    } else {
        toast.style.borderLeftColor = '#48bb78';
    }
    
    // Show toast
    toast.style.transform = 'translateX(0)';
    
    // Auto hide after 3 seconds
    setTimeout(() => {
        toast.style.transform = 'translateX(400px)';
    }, 3000);
}

// Carousel functionality
let currentSlideIndex = 0;
let slideInterval;
const slides = document.querySelectorAll('.hero-slide');
const dots = document.querySelectorAll('.dot');
const totalSlides = slides.length;

function showSlide(index) {
    // Remove active class from all slides and dots
    slides.forEach(slide => slide.classList.remove('active'));
    dots.forEach(dot => dot.classList.remove('active'));
    
    // Add active class to current slide and dot
    if (slides[index]) {
        slides[index].classList.add('active');
    }
    if (dots[index]) {
        dots[index].classList.add('active');
    }
    
    currentSlideIndex = index;
}

function nextSlide() {
    const nextIndex = (currentSlideIndex + 1) % totalSlides;
    showSlide(nextIndex);
}

function prevSlide() {
    const prevIndex = (currentSlideIndex - 1 + totalSlides) % totalSlides;
    showSlide(prevIndex);
}

function changeSlide(direction) {
    clearInterval(slideInterval);
    if (direction === 1) {
        nextSlide();
    } else {
        prevSlide();
    }
    // Reset timer - ƒë·∫øm l·∫°i t·ª´ ƒë·∫ßu
    setTimeout(startAutoSlide, 100);
}

function currentSlide(index) {
    clearInterval(slideInterval);
    showSlide(index - 1);
    // Reset timer - ƒë·∫øm l·∫°i t·ª´ ƒë·∫ßu
    setTimeout(startAutoSlide, 100);
}

function startAutoSlide() {
    slideInterval = setInterval(nextSlide, 7000); // 7 seconds
}

function stopAutoSlide() {
    clearInterval(slideInterval);
}

// Initialize carousel
document.addEventListener('DOMContentLoaded', function() {
    console.log('Carousel init: totalSlides =', totalSlides);
    console.log('Slides found:', slides.length);
    console.log('Dots found:', dots.length);
    
    if (totalSlides > 0) {
        console.log('Starting carousel...');
        showSlide(0);
        startAutoSlide();
        
        // Pause on hover
        const hero = document.querySelector('.hero');
        if (hero) {
            hero.addEventListener('mouseenter', stopAutoSlide);
            hero.addEventListener('mouseleave', startAutoSlide);
        }
    }
});

// Rating functions
function loadAllRatings() {
  const ratingElements = document.querySelectorAll('.movie-rating[data-movie-id]');
  ratingElements.forEach(element => {
    const movieId = element.dataset.movieId;
    loadMovieRating(movieId, element);
  });
}

function loadMovieRating(movieId, element) {
  fetch(`/get-rating/${movieId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const ratingStars = element.querySelector('.rating-stars');
      const ratingCount = element.querySelector('.rating-count');
      const normalizedAvg = (data.avgRating ?? data.avg_rating ?? 0);
      const normalizedCount = (data.ratingCount ?? data.total_ratings ?? 0);
      
      ratingStars.textContent = `‚≠ê ${normalizedAvg}`;
      ratingCount.textContent = `(${normalizedCount})`;
    }
  })
  .catch(error => {
    console.error('Error loading rating for movie', movieId, ':', error);
  });
}

// generateRecommendations removed per request

// Show notification function
function showNotification(message, type = 'info') {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.innerHTML = `
    <div class="notification-content">
      <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span class="notification-message">${message}</span>
    </div>
  `;
  
  // Add styles
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
  `;
  
  // Add animation styles
  if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .notification-content {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .notification-icon {
        font-size: 18px;
      }
      .notification-message {
        font-size: 14px;
        font-weight: 500;
      }
    `;
    document.head.appendChild(style);
  }
  
  // Add to page
  document.body.appendChild(notification);
  
  // Remove after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Enhanced showToast function (alias for showNotification)
function showToast(message, type = 'success') {
  showNotification(message, type);
}

// Personalized Recommendations Functions v·ªõi Cache
const RECOMMENDATIONS_CACHE_KEY = 'cinebox_recommendations';
const CACHE_EXPIRY_KEY = 'cinebox_recommendations_expiry';
const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 gi·ªù

function loadPersonalizedRecommendations(forceRefresh = false) {
  // Ki·ªÉm tra cache tr∆∞·ªõc
  if (!forceRefresh) {
    const cachedData = getCachedRecommendations();
    if (cachedData) {
      console.log('üì¶ S·ª≠ d·ª•ng d·ªØ li·ªáu cache');
      updateRecommendationsDisplay(cachedData.recommendations);
      return;
    }
  }

  // Hi·ªÉn th·ªã loading
  showRecommendationsLoading();
  
  console.log('üåê G·ªçi API ƒë·ªÉ l·∫•y g·ª£i √Ω m·ªõi');
  fetch('/api/personalized_recommendations')
    .then(response => response.json())
    .then(data => {
      hideRecommendationsLoading();
      
      if (data.success && data.recommendations && data.recommendations.length > 0) {
        // L∆∞u v√†o cache
        setCachedRecommendations(data);
        updateRecommendationsDisplay(data.recommendations);
      } else {
        // N·∫øu kh√¥ng c√≥ g·ª£i √Ω t·ª´ model, th·ª≠ cold start
        console.log('üîÑ Kh√¥ng c√≥ g·ª£i √Ω t·ª´ model, th·ª≠ cold start...');
        loadColdStartFallback();
      }
    })
    .catch(error => {
      console.error('Error loading personalized recommendations:', error);
      hideRecommendationsLoading();
      showRecommendationsError();
    });
}

function getCachedRecommendations() {
  try {
    const cached = localStorage.getItem(RECOMMENDATIONS_CACHE_KEY);
    const expiry = localStorage.getItem(CACHE_EXPIRY_KEY);
    
    if (cached && expiry) {
      const expiryTime = parseInt(expiry);
      if (Date.now() < expiryTime) {
        return JSON.parse(cached);
      } else {
        // Cache ƒë√£ h·∫øt h·∫°n
        clearRecommendationsCache();
      }
    }
  } catch (error) {
    console.error('Error reading cache:', error);
    clearRecommendationsCache();
  }
  return null;
}

function setCachedRecommendations(data) {
  try {
    const cacheData = {
      recommendations: data.recommendations,
      cachedAt: Date.now(),
      source: data.source || 'api'
    };
    
    localStorage.setItem(RECOMMENDATIONS_CACHE_KEY, JSON.stringify(cacheData));
    localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now() + CACHE_DURATION).toString());
    
    console.log('üíæ ƒê√£ l∆∞u g·ª£i √Ω v√†o cache');
  } catch (error) {
    console.error('Error saving to cache:', error);
  }
}

function clearRecommendationsCache() {
  localStorage.removeItem(RECOMMENDATIONS_CACHE_KEY);
  localStorage.removeItem(CACHE_EXPIRY_KEY);
  console.log('üóëÔ∏è ƒê√£ x√≥a cache');
}

function refreshRecommendations() {
  const refreshBtn = document.getElementById('refreshBtn');
  if (refreshBtn) {
    refreshBtn.classList.add('loading');
    refreshBtn.disabled = true;
  }
  
  // X√≥a cache v√† load l·∫°i unified recommendations
  clearRecommendationsCache();
  loadUnifiedRecommendations(true);
  
  // Reset button sau 3 gi√¢y
  setTimeout(() => {
    if (refreshBtn) {
      refreshBtn.classList.remove('loading');
      refreshBtn.disabled = false;
    }
  }, 3000);
}

function generateRecommendations() {
  // Alias cho refreshRecommendations - d√πng cho n√∫t "T·∫°o g·ª£i √Ω ngay"
  clearRecommendationsCache();
  loadUnifiedRecommendations(true);
}

function loadColdStartFallback() {
  console.log('üåü ƒêang t·∫£i cold start recommendations...');
  
  fetch('/api/cold_start_recommendations')
    .then(response => response.json())
    .then(data => {
      hideRecommendationsLoading();
      
      if (data.success && data.recommendations && data.recommendations.length > 0) {
        console.log('‚úÖ T√¨m th·∫•y cold start recommendations:', data.recommendations.length);
        updateRecommendationsDisplay(data.recommendations);
        
        // L∆∞u v√†o cache v·ªõi flag cold start
        setCachedRecommendations({
          recommendations: data.recommendations,
          source: 'cold_start'
        });
      } else {
        console.log('‚ùå Kh√¥ng c√≥ cold start recommendations, hi·ªÉn th·ªã empty state');
        showRecommendationsEmpty();
      }
    })
    .catch(error => {
      console.error('‚ùå L·ªói khi t·∫£i cold start recommendations:', error);
      hideRecommendationsLoading();
      showRecommendationsEmpty();
    });
}

function showRecommendationsLoading() {
  const loading = document.getElementById('personalizedLoading');
  const cards = document.getElementById('personalizedCards');
  const empty = document.getElementById('personalizedEmpty');
  
  if (loading) loading.style.display = 'block';
  if (cards) cards.style.display = 'none';
  if (empty) empty.style.display = 'none';
}

function hideRecommendationsLoading() {
  const loading = document.getElementById('personalizedLoading');
  if (loading) loading.style.display = 'none';
}

function showRecommendationsEmpty() {
  const loading = document.getElementById('personalizedLoading');
  const cards = document.getElementById('personalizedCards');
  const empty = document.getElementById('personalizedEmpty');
  
  if (loading) loading.style.display = 'none';
  if (cards) cards.style.display = 'none';
  if (empty) empty.style.display = 'block';
}

function showRecommendationsError() {
  const container = document.getElementById('personalizedCards');
  if (container) {
    container.innerHTML = `
      <div class="error-state" style="text-align: center; padding: 40px; color: #e74c3c;">
        <div class="error-icon">‚ùå</div>
        <h4>C√≥ l·ªói x·∫£y ra</h4>
        <p>Kh√¥ng th·ªÉ t·∫£i g·ª£i √Ω. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
        <button class="btn btn-primary" onclick="refreshRecommendations()">
          Th·ª≠ l·∫°i
        </button>
      </div>
    `;
    container.style.display = 'block';
  }
}

function showUserRatingCount(userRatingCount) {
  const empty = document.getElementById('personalizedEmpty');
  if (!empty) return;
  
  empty.innerHTML = `
    <div class="empty-icon">üé¨</div>
    <h4>Ch∆∞a c√≥ g·ª£i √Ω c√° nh√¢n h√≥a</h4>
    <p>B·∫°n ƒë√£ ƒë√°nh gi√° <strong>${userRatingCount}</strong> phim</p>
    <p>H√£y ƒë√°nh gi√° th√™m phim ƒë·ªÉ c√≥ g·ª£i √Ω t·ªët h∆°n!</p>
    <button class="btn btn-primary" onclick="generateRecommendations()">
      T·∫°o g·ª£i √Ω ngay
    </button>
  `;
  empty.style.display = 'block';
}

function updateRecommendationsDisplay(recommendations) {
  const container = document.getElementById('personalizedCards');
  const loading = document.getElementById('personalizedLoading');
  const empty = document.getElementById('personalizedEmpty');
  
  if (!container) return;
  
  if (loading) loading.style.display = 'none';
  if (empty) empty.style.display = 'none';
  
  container.innerHTML = recommendations.map(rec => `
    <div class="card">
      <a href="/movie/${rec.movieId || rec.id}" class="card-link">
        <div class="poster" style="background-image:url('${rec.poster || rec.posterUrl || '/static/img/no-poster.jpg'}')"></div>
        <div class="card-content">
          <div class="card-title">${rec.title}</div>
          <div class="card-meta">
            ${rec.releaseYear ? `<span class="year">${rec.releaseYear}</span>` : ''}
            ${rec.country ? `<span class="country">${rec.country}</span>` : ''}
          </div>
          ${rec.genres ? `<div class="card-genres">${rec.genres}</div>` : ''}
          <div class="recommendation-info">
            <span class="rec-badge hybrid-badge">
              ${rec.hybrid_score ? `Hybrid: ${rec.hybrid_score.toFixed(2)}` : 
                (rec.recommendationScore ? `ƒêi·ªÉm: ${rec.recommendationScore.toFixed(2)}` : 'G·ª£i √Ω')}
            </span>
            ${rec.reason ? `<div class="rec-reason"><small>${rec.reason}</small></div>` : ''}
          </div>
          <div class="movie-rating" data-movie-id="${rec.movieId || rec.id}">
            <span class="rating-stars">‚≠ê ${(rec.avgRating ?? rec.avg_rating ?? 0).toFixed(1)}</span>
            <span class="rating-count">(${rec.ratingCount ?? rec.total_ratings ?? 0})</span>
          </div>
        </div>
      </a>
      <div class="action-buttons">
        <button class="watchlist-btn" onclick="toggleWatchlist(${rec.movieId || rec.id}, event)" data-movie-id="${rec.movieId || rec.id}">
          <span class="watchlist-icon">üìã</span>
        </button>
        <button class="favorite-btn" onclick="toggleFavorite(${rec.movieId || rec.id}, event)" data-movie-id="${rec.movieId || rec.id}">
          <span class="favorite-icon">ü§ç</span>
        </button>
      </div>
    </div>
  `).join('');
  
  container.style.display = 'flex';
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i favorite/watchlist cho c√°c phim m·ªõi
  setTimeout(() => {
    checkAllStatus();
  }, 100);
}

function showPreferenceAnalysis() {
  const analysisBtn = document.getElementById('analysisBtn');
  analysisBtn.disabled = true;
  analysisBtn.innerHTML = '<span class="btn-icon">‚è≥</span>ƒêang ph√¢n t√≠ch...';
  
  fetch('/api/user_preference_analysis')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayPreferenceAnalysis(data.analysis);
      } else {
        showToast(data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error analyzing preferences:', error);
      showToast('C√≥ l·ªói x·∫£y ra khi ph√¢n t√≠ch s·ªü th√≠ch', 'error');
    })
    .finally(() => {
      analysisBtn.disabled = false;
      analysisBtn.innerHTML = '<span class="btn-icon">üìä</span>Ph√¢n t√≠ch s·ªü th√≠ch';
    });
}

function displayPreferenceAnalysis(analysis) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      color: #333;
    ">
      <h2 style="margin-bottom: 20px; color: #2c3e50;">üìä Ph√¢n t√≠ch s·ªü th√≠ch c·ªßa b·∫°n</h2>
      
      <div style="margin-bottom: 20px;">
        <h3>üìà Th·ªëng k√™ t·ªïng quan</h3>
        <p><strong>T·ªïng s·ªë ƒë√°nh gi√°:</strong> ${analysis.total_ratings}</p>
        <p><strong>ƒêi·ªÉm trung b√¨nh:</strong> ${analysis.average_rating}/5.0</p>
        <p><strong>ƒê·ªô ƒëa d·∫°ng s·ªü th√≠ch:</strong> ${(analysis.diversity_score * 100).toFixed(0)}%</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3>üé≠ Th·ªÉ lo·∫°i y√™u th√≠ch</h3>
        ${analysis.preferred_genres.map(genre => 
          `<p><strong>${genre.genre}:</strong> ${genre.avg_rating}/5.0 (${genre.rating_count} phim)</p>`
        ).join('')}
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3>üìÖ NƒÉm ph√°t h√†nh y√™u th√≠ch</h3>
        ${analysis.preferred_years.map(year => 
          `<p><strong>${year.year}:</strong> ${year.avg_rating}/5.0 (${year.rating_count} phim)</p>`
        ).join('')}
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3>üåç Qu·ªëc gia y√™u th√≠ch</h3>
        ${analysis.preferred_countries.map(country => 
          `<p><strong>${country.country}:</strong> ${country.avg_rating}/5.0 (${country.rating_count} phim)</p>`
        ).join('')}
      </div>
      
      <button onclick="this.closest('div').parentNode.remove()" style="
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        float: right;
      ">ƒê√≥ng</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Load personalized recommendations on page load
document.addEventListener('DOMContentLoaded', function() {
  // Load unified recommendations after a short delay to ensure page is ready
  setTimeout(() => {
    loadUnifiedRecommendations(); // S·∫Ω t·ª± ƒë·ªông check cache v√† user interactions
    loadModelStatus();
  }, 500);
});

// Load model status
function loadModelStatus() {
    fetch('/api/model_status_public')
        .then(response => response.json())
        .then(data => {
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                if (data.success && data.modelInfo) {
                    const info = data.modelInfo;
                    const status = (info.status || '').toLowerCase();
                    
                    if (status === 'loaded') {
                        // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt model
                        const modelType = info.model_type || 'CF';
                        const nUsers = info.n_users || 0;
                        const nItems = info.n_items || 0;
                        const nFactors = info.n_factors || 20;
                        
                        // T·∫°o badge m√†u s·∫Øc cho model type
                        const isEnhanced = modelType.includes('Enhanced');
                        const badge = isEnhanced 
                            ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; margin-left: 5px;">ENHANCED</span>`
                            : `<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; margin-left: 5px;">BASIC</span>`;
                        
                        modelInfo.innerHTML = `‚úÖ Model${badge} | Users: ${nUsers} | Items: ${nItems} | Factors: ${nFactors}`;
                        modelInfo.style.color = '#4ecdc4';
                    } else if (status === 'not loaded') {
                        modelInfo.innerHTML = `‚ö†Ô∏è Model: Ch∆∞a t·∫£i`;
                        modelInfo.style.color = '#f39c12';
                    } else {
                        modelInfo.innerHTML = `‚ö†Ô∏è Model: ${info.status || 'Unknown'}`;
                        modelInfo.style.color = '#ff6b6b';
                    }
                } else {
                    modelInfo.innerHTML = `‚ùå Model: ${data.message || 'Not available'}`;
                    modelInfo.style.color = '#ff6b6b';
                }
            }
            
            // Load hybrid status
            loadHybridStatus();
        })
        .catch(error => {
            console.error('Error loading model status:', error);
            const modelInfo = document.getElementById('modelInfo');
            if (modelInfo) {
                modelInfo.innerHTML = '‚ùå L·ªói t·∫£i th√¥ng tin model';
                modelInfo.style.color = '#ff6b6b';
            }
            // Still try to load hybrid status
            loadHybridStatus();
        });
}

// Load hybrid recommendations status
function loadHybridStatus() {
    fetch('/api/hybrid_status')
        .then(response => response.json())
        .then(data => {
            const hybridStatus = document.getElementById('hybridStatus');
            if (!hybridStatus) return;
            
            if (data.success) {
                if (data.hybrid_active) {
                    // Hi·ªÉn th·ªã badge hybrid active
                    hybridStatus.style.display = 'inline-block';
                    hybridStatus.innerHTML = 'üîÄ Hybrid Active (' + data.recommendations.hybrid + ' recommendations)';
                    hybridStatus.style.background = 'rgba(76, 175, 80, 0.2)';
                    hybridStatus.style.color = '#4CAF50';
                    
                    // Log th√¥ng tin chi ti·∫øt
                    console.log('üîÄ Hybrid Recommendations Status:', {
                        active: data.hybrid_active,
                        total: data.recommendations.total,
                        hybrid: data.recommendations.hybrid,
                        cf: data.recommendations.cf,
                        cold_start: data.recommendations.cold_start,
                        last_generated: data.recommendations.last_generated,
                        expires_at: data.recommendations.expires_at,
                        score_stats: data.recommendations.score_stats,
                        user_info: data.user_info,
                        models: data.models,
                        health_check: data.health_check
                    });
                    
                    // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt trong console ƒë·ªÉ debug
                    if (data.health_check) {
                        console.log('üìä Hybrid Health Check:', {
                            'CF Model': data.health_check.cf_model_ok ? '‚úÖ OK' : '‚ùå Failed',
                            'CB Model': data.health_check.cb_model_ok ? '‚úÖ OK' : '‚ùå Failed',
                            'Hybrid Working': data.health_check.hybrid_working ? '‚úÖ Active' : '‚ùå Not Active',
                            'Overall Status': data.health_check.overall_status === 'healthy' ? '‚úÖ Healthy' : 
                                             (data.health_check.overall_status === 'partial' ? '‚ö†Ô∏è Partial' : '‚ùå Unhealthy')
                        });
                    }
                    
                    // Hi·ªÉn th·ªã th√¥ng tin user
                    if (data.user_info) {
                        console.log('üë§ User Info:', {
                            'Total Interactions': data.user_info.total_interactions,
                            'Cold Start Weight': data.user_info.cold_start_weight + '%',
                            'CF/CB Weight': data.user_info.cf_cb_weight + '%'
                        });
                    }
                    
                    // Hi·ªÉn th·ªã score stats
                    if (data.recommendations.score_stats) {
                        console.log('üìà Score Statistics:', {
                            'Average': data.recommendations.score_stats.avg,
                            'Min': data.recommendations.score_stats.min,
                            'Max': data.recommendations.score_stats.max
                        });
                    }
                    
                    // Hi·ªÉn th·ªã top hybrid recommendations
                    if (data.recommendations.hybrid_details && data.recommendations.hybrid_details.length > 0) {
                        console.log('üé¨ Top Hybrid Recommendations:', data.recommendations.hybrid_details);
                    }
                    
                    // Hi·ªÉn th·ªã CF/CB test results
                    if (data.models.cf_test_details && data.models.cf_test_details.length > 0) {
                        console.log('ü§ù CF Test Results:', data.models.cf_test_details);
                    }
                    if (data.models.cb_test_details && data.models.cb_test_details.length > 0) {
                        console.log('üìù CB Test Results:', data.models.cb_test_details);
                    }
                } else if (data.can_generate_hybrid) {
                    // C√≥ th·ªÉ generate hybrid nh∆∞ng ch∆∞a c√≥
                    hybridStatus.style.display = 'inline-block';
                    hybridStatus.innerHTML = '‚ö° Hybrid Ready (CF: ' + data.models.cf_test_count + ', CB: ' + data.models.cb_test_count + ')';
                    hybridStatus.style.background = 'rgba(255, 193, 7, 0.2)';
                    hybridStatus.style.color = '#FFC107';
                } else {
                    // Kh√¥ng th·ªÉ generate hybrid
                    hybridStatus.style.display = 'none';
                }
            } else {
                hybridStatus.style.display = 'none';
                console.warn('Hybrid status check failed:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading hybrid status:', error);
        });
}

// Initialize on page load
// ƒê√£ x√≥a DOMContentLoaded cho cold start - merge v√†o unified recommendations

// Unified function to load recommendations based on user experience
function loadUnifiedRecommendations(forceRefresh = false) {
  console.log('üéØ Loading unified recommendations...');
  
  // Check user interaction status first
  fetch('/api/user_interaction_status')
    .then(response => response.json())
    .then(data => {
      console.log('Interaction status response:', data);
      
      if (data.success) {
        const totalInteractions = data.rating_count + data.view_count;
        console.log(`Total interactions: ${totalInteractions}`);
        
        if (totalInteractions < 5) {
          // User m·ªõi - d√πng Cold Start
          setupColdStartMode(totalInteractions);
          loadColdStartRecommendations(forceRefresh);
        } else {
          // User c√≥ kinh nghi·ªám - d√πng Personalized
          setupPersonalizedMode(totalInteractions);
          loadPersonalizedRecommendations(forceRefresh);
        }
      } else {
        console.log('Failed to get interaction status, defaulting to personalized');
        setupPersonalizedMode(0);
        loadPersonalizedRecommendations(forceRefresh);
      }
    })
    .catch(error => {
      console.error('Error checking interaction status:', error);
      setupPersonalizedMode(0);
      loadPersonalizedRecommendations(forceRefresh);
    });
}

// Setup UI for Cold Start mode
function setupColdStartMode(totalInteractions) {
  console.log('üåü Setting up Cold Start mode');
  
  const title = document.getElementById('recommendationTitle');
  const subtitle = document.getElementById('recommendationSubtitle');
  const badge = document.getElementById('recommendationBadge');
  const interactionCount = document.getElementById('interactionCount');
  const refreshBtn = document.getElementById('refreshBtn');
  
  // Update title and show subtitle
  title.innerHTML = 'üåü G·ª£i √Ω d√†nh cho b·∫°n';
  subtitle.style.display = 'flex';
  badge.className = 'badge cold-start-badge';
  badge.textContent = 'M·ªõi';
  interactionCount.textContent = `B·∫°n ƒë√£ t∆∞∆°ng t√°c ${totalInteractions} l·∫ßn`;
  
  // Hide refresh button for cold start
  refreshBtn.style.display = 'none';
}

// Setup UI for Personalized mode  
function setupPersonalizedMode(totalInteractions) {
  console.log('üéØ Setting up Personalized mode');
  
  const title = document.getElementById('recommendationTitle');
  const subtitle = document.getElementById('recommendationSubtitle');
  const refreshBtn = document.getElementById('refreshBtn');
  
  // Update title and hide subtitle
  title.innerHTML = 'üéØ G·ª£i √Ω c√° nh√¢n cho b·∫°n';
  subtitle.style.display = 'none';
  
  // Show refresh button for personalized
  refreshBtn.style.display = 'flex';
}

// Load Cold Start recommendations
function loadColdStartRecommendations(forceRefresh = false) {
  console.log('üåü Loading cold start recommendations...');
  
  const container = document.getElementById('personalizedCards');
  if (!container) return;
  
  showRecommendationsLoading();
  
  fetch('/api/cold_start_recommendations')
    .then(response => response.json())
    .then(data => {
      hideRecommendationsLoading();
      
      if (data.success && data.recommendations && data.recommendations.length > 0) {
        console.log('‚úÖ Cold start recommendations loaded:', data.recommendations.length);
        updateRecommendationsDisplay(data.recommendations);
        checkAllStatus(); // Check favorite/watchlist status
      } else {
        showRecommendationsEmpty();
      }
    })
    .catch(error => {
      console.error('‚ùå Error loading cold start recommendations:', error);
      hideRecommendationsLoading();
      showRecommendationsError();
    });
}

// ƒê√£ x√≥a loadColdStartData() - merge v√†o loadColdStartRecommendations()

// ƒê√£ x√≥a displayColdStartRecommendations() - d√πng updateRecommendationsDisplay() chung

// Personalized Recommendations Horizontal Scroll Functions
function scrollPersonalizedCards(direction) {
  const container = document.getElementById('personalizedCards');
  if (!container) return;
  
  const scrollAmount = 600; // Scroll 600px m·ªói l·∫ßn
  const currentScroll = container.scrollLeft;
  
  if (direction === 'left') {
    container.scrollTo({
      left: currentScroll - scrollAmount,
      behavior: 'smooth'
    });
  } else if (direction === 'right') {
    container.scrollTo({
      left: currentScroll + scrollAmount,
      behavior: 'smooth'
    });
  }
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi scroll
  setTimeout(() => {
    updateScrollButtons();
  }, 300);
}

function updateScrollButtons() {
  const container = document.getElementById('personalizedCards');
  const leftBtn = document.getElementById('personalizedScrollLeft');
  const rightBtn = document.getElementById('personalizedScrollRight');
  
  if (!container || !leftBtn || !rightBtn) return;
  
  const { scrollLeft, scrollWidth, clientWidth } = container;
  const isAtStart = scrollLeft <= 10;
  const isAtEnd = scrollLeft >= scrollWidth - clientWidth - 10;
  
  // ·∫®n/hi·ªán n√∫t d·ª±a tr√™n v·ªã tr√≠ scroll
  if (isAtStart) {
    leftBtn.classList.add('hidden');
  } else {
    leftBtn.classList.remove('hidden');
  }
  
  if (isAtEnd) {
    rightBtn.classList.add('hidden');
  } else {
    rightBtn.classList.remove('hidden');
  }
}

// Generic Horizontal Scroll Function - D√πng cho t·∫•t c·∫£ c√°c ph·∫ßn
function scrollHorizontal(containerId, direction) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const scrollAmount = 600; // Scroll 600px m·ªói l·∫ßn
  const currentScroll = container.scrollLeft;
  
  if (direction === 'left') {
    container.scrollTo({
      left: currentScroll - scrollAmount,
      behavior: 'smooth'
    });
  } else if (direction === 'right') {
    container.scrollTo({
      left: currentScroll + scrollAmount,
      behavior: 'smooth'
    });
  }
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t sau khi scroll
  setTimeout(() => {
    updateHorizontalScrollButtons(containerId);
  }, 300);
}

function updateHorizontalScrollButtons(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  
  const wrapper = container.closest('.horizontal-scroll-wrapper');
  if (!wrapper) return;
  
  const leftBtn = wrapper.querySelector('.scroll-btn-left');
  const rightBtn = wrapper.querySelector('.scroll-btn-right');
  
  if (!leftBtn || !rightBtn) return;
  
  const { scrollLeft, scrollWidth, clientWidth } = container;
  const isAtStart = scrollLeft <= 10;
  const isAtEnd = scrollLeft >= scrollWidth - clientWidth - 10;
  
  // ·∫®n/hi·ªán n√∫t d·ª±a tr√™n v·ªã tr√≠ scroll
  if (isAtStart) {
    leftBtn.classList.add('hidden');
  } else {
    leftBtn.classList.remove('hidden');
  }
  
  if (isAtEnd) {
    rightBtn.classList.add('hidden');
  } else {
    rightBtn.classList.remove('hidden');
  }
}

// Kh·ªüi t·∫°o scroll buttons khi trang load
document.addEventListener('DOMContentLoaded', function() {
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ban ƒë·∫ßu cho personalized cards
  setTimeout(() => {
    updateScrollButtons();
  }, 500);
  
  // L·∫Øng nghe s·ª± ki·ªán scroll ƒë·ªÉ c·∫≠p nh·∫≠t n√∫t cho personalized cards
  const container = document.getElementById('personalizedCards');
  if (container) {
    container.addEventListener('scroll', updateScrollButtons);
    
    // C·∫≠p nh·∫≠t khi resize window
    window.addEventListener('resize', () => {
      setTimeout(updateScrollButtons, 100);
    });
  }
  
  // Kh·ªüi t·∫°o cho t·∫•t c·∫£ c√°c horizontal scroll containers
  const horizontalContainers = ['latestMovies', 'coldStartRecommendations', 'recentWatched', 'trendingMovies'];
  horizontalContainers.forEach(containerId => {
    const container = document.getElementById(containerId);
    if (container) {
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ban ƒë·∫ßu
      setTimeout(() => {
        updateHorizontalScrollButtons(containerId);
      }, 500);
      
      // L·∫Øng nghe s·ª± ki·ªán scroll
      container.addEventListener('scroll', () => {
        updateHorizontalScrollButtons(containerId);
      });
      
      // C·∫≠p nh·∫≠t khi resize window
      window.addEventListener('resize', () => {
        setTimeout(() => updateHorizontalScrollButtons(containerId), 100);
      });
    }
  });
});
</script>
{% endblock %}


