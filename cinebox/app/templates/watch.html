{% extends 'base.html' %}
{% block title %}{% if is_trailer %}Trailer: {% endif %}{{ movie.title }} ¬∑ CineBox{% endblock %}
{% block content %}
<!-- eslint-disable -->
<section class="watch">
  <div class="watch-hero">
    <div class="watch-hero-backdrop" style="background-image:url('{{ movie.backdrop }}')"></div>
    <div class="watch-hero-overlay"></div>
    <div class="watch-hero-content">
      <div class="watch-layout">
        <div class="watch-player-card">
          {% if tmdb_video %}
            <div class="embed-wrapper">
              {% if tmdb_video.type == 'youtube' %}
                <iframe 
                  class="player-embed" 
                  src="https://www.youtube.com/embed/{{ tmdb_video.key }}?autoplay=0&rel=0" 
                  frameborder="0" 
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                  allowfullscreen>
                </iframe>
              {% elif tmdb_video.type == 'vimeo' %}
                <iframe 
                  class="player-embed" 
                  src="https://player.vimeo.com/video/{{ tmdb_video.key }}?autoplay=0" 
                  frameborder="0" 
                  allow="autoplay; fullscreen; picture-in-picture" 
                  allowfullscreen>
                </iframe>
              {% endif %}
            </div>
          {% else %}
            <video class="player" controls poster="{{ movie.backdrop }}">
              {% for s in movie.sources %}
              <source src="{{ s.url }}" type="video/mp4" />
              {% endfor %}
              Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
            </video>
          {% endif %}
          {% if movie.description %}
          <div class="hero-overview">
            <p id="hero-overview-text" class="hero-overview-text {% if movie.description|length > 240 %}collapsed{% endif %}">{{ movie.description }}</p>
            {% if movie.description|length > 240 %}
            <button class="hero-overview-toggle" type="button" onclick="toggleHeroOverview()">Xem th√™m</button>
            {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="watch-info-card">
          <div class="watch-info-header">
            <h1>{{ movie.title }}</h1>
            {% if is_trailer %}
              <span class="trailer-badge">üé¨ Trailer</span>
            {% endif %}
          </div>
          <div class="watch-info-meta">
            {% if movie.year %}<span>üìÖ {{ movie.year }}</span>{% endif %}
            <span>üëÅÔ∏è {{ "{:,}".format(movie.viewCount) }} l∆∞·ª£t xem</span>
          </div>
          {% if movie.genres %}
          <div class="genre-tags compact">
            {% for genre in movie.genres %}
              <a href="{{ url_for('main.genre_page', genre_slug=genre.slug) }}" class="genre-tag">{{ genre.name }}</a>
            {% endfor %}
          </div>
          {% endif %}
          {% if movie.description %}
          <p class="watch-description">{{ movie.description }}</p>
          {% endif %}

          {% if related_movies %}
          <div class="watch-related-list">
            <div class="watch-related-header">
              <h4>üé¨ Phim li√™n quan</h4>
              <span>{{ related_movies|length }} phim</span>
            </div>
            <div class="watch-related-scroll" id="relatedCards">
              {% for m in related_movies %}
              <a href="{{ url_for('main.watch', movie_id=m.movieId) }}" class="watch-related-item">
                <div class="watch-related-poster" style="background-image:url('{{ m.posterUrl }}')"></div>
                <div class="watch-related-info">
                  <div class="watch-related-title">
                    {{ m.title }}{% if m.releaseYear %} ({{ m.releaseYear }}){% endif %}
                  </div>
                  {% if m.genres %}
                  <div class="watch-related-meta">
                    {{ m.genres }}
                  </div>
                  {% endif %}
                </div>
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if movie.episodes and movie.episodes|length > 1 %}
  <div class="episodes-section">
    <h3>üì∫ T·∫≠p phim</h3>
    <div class="episodes-list">
      {% for episode in movie.episodes %}
      <div class="episode-item">
        <a href="{{ url_for('main.watch', movie_id=movie.id) }}?episode={{ episode.number }}" 
           class="episode-link {{ 'active' if request.args.get('episode')|int == episode.number else '' }}">
          <div class="episode-number">{{ episode.number }}</div>
          <div class="episode-info">
            <div class="episode-title">{{ episode.title }}</div>
            <div class="episode-duration">{{ episode.duration }}</div>
          </div>
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Rating Section -->
  <div class="rating-section">
    <h3>ƒê√°nh gi√° phim</h3>
    <div class="rating-container">
      <div class="rating-info">
        <div class="current-rating">
          <span id="avg-rating-display">‚≠ê 0.0</span>
          <span id="rating-count">(0 ƒë√°nh gi√°)</span>
        </div>
        <div class="user-rating-info">
          <span id="user-rating-text">Ch∆∞a ƒë√°nh gi√°</span>
        </div>
      </div>
      <div class="star-rating" id="star-rating" data-movie-id="{{ movie.id }}" data-user-id="{{ session.get('user_id', 0) }}" data-movie-id-fallback="{{ movie.id }}">
        <span class="star" data-rating="1">‚òÖ</span>
        <span class="star" data-rating="2">‚òÖ</span>
        <span class="star" data-rating="3">‚òÖ</span>
        <span class="star" data-rating="4">‚òÖ</span>
        <span class="star" data-rating="5">‚òÖ</span>
      </div>
      <div class="rating-actions">
        <button id="delete-rating-btn" class="btn-delete-rating" style="display: none;">X√≥a ƒë√°nh gi√°</button>
      </div>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="comments-section">
    <h3>üí¨ B√¨nh lu·∫≠n</h3>
    <div class="comment-form">
      <textarea id="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." maxlength="1000"></textarea>
      <div class="comment-actions">
        <span id="char-count">0/1000</span>
        <button id="submit-comment-btn" class="btn-submit-comment">G·ª≠i b√¨nh lu·∫≠n</button>
      </div>
    </div>
    <div id="comments-container" class="comments-container">
      <!-- Comments will be loaded here -->
    </div>
  </div>

  <!-- Ch·ªâ hi·ªÉn th·ªã phim li√™n quan t·ª´ m√¥ h√¨nh improved_train.py -->
</section>

<style>
/* Watch Page Styles */
.watch-hero {
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 24px;
  overflow: hidden;
  margin-bottom: 30px;
  background: rgba(15, 20, 32, 0.6);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
}

.watch-hero-backdrop {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  filter: blur(24px);
  opacity: 0.45;
}

.watch-hero-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(120deg, rgba(7,11,20,0.95) 10%, rgba(15,23,42,0.85) 55%, rgba(15,23,42,0.55) 100%);
}

.watch-hero-content {
  position: relative;
  padding: 40px;
}

.watch-layout {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  align-items: stretch;
}

.watch-player-card,
.watch-info-card {
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.12);
  background: rgba(11, 17, 31, 0.85);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
}

.watch-player-card {
  flex: 1 1 58%;
  min-width: 320px;
  padding: 0;
  overflow: hidden;
}

.watch-info-card {
  flex: 1 1 35%;
  min-width: 280px;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.watch-info-header h1 {
  color: #fff;
  margin: 0;
  font-size: 2.2rem;
}

.watch-badge,
.trailer-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 0.85rem;
  font-weight: 600;
  background: rgba(111, 177, 255, 0.15);
  border: 1px solid rgba(111, 177, 255, 0.4);
  color: #dbeafe;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.watch-info-meta {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  font-size: 0.95rem;
  color: #c3ccdf;
}

.watch-info-card .genre-tags {
  padding: 0;
  justify-content: flex-start;
}

.watch-info-card .genre-tag {
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 999px;
  text-transform: none;
  letter-spacing: 0;
  font-size: 0.85rem;
  padding: 8px 16px;
}

.watch-info-card .genre-tag:hover {
  background: rgba(111, 177, 255, 0.18);
  border-color: rgba(111, 177, 255, 0.6);
}

.watch-description {
  color: #d1d5db;
  line-height: 1.7;
  margin: 0;
}

.watch-body {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 30px;
  padding-bottom: 40px;
}

@media (max-width: 1024px) {
  .watch-layout {
    flex-direction: column;
  }
  
  .watch-player-card,
  .watch-info-card {
    flex: 1 1 100%;
  }
}

.player {
  width: 100%;
  height: auto;
  min-height: 400px;
  background: #000;
  border-radius: 12px;
}

.embed-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
  overflow: hidden;
  background: #000;
  border-radius: 12px;
}

.player-embed {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  border-radius: 12px;
}

.movie-url-link {
  margin-top: 15px;
  text-align: center;
}

.hero-overview {
  margin-top: 18px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 16px 18px;
  color: #cfd7ed;
  font-size: 0.95rem;
  line-height: 1.6;
}

.hero-overview-text {
  margin: 0;
}

.hero-overview-text.collapsed {
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.hero-overview-toggle {
  margin-top: 10px;
  background: none;
  border: 1px solid rgba(255,255,255,0.3);
  color: #9ac1ff;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.hero-overview-toggle:hover {
  border-color: rgba(111,177,255,0.6);
  color: #fff;
}

.watch-related-list {
  margin-top: 8px;
  padding-top: 16px;
  border-top: 1px solid rgba(255,255,255,0.08);
}

.watch-related-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #e2e8f0;
  margin-bottom: 12px;
}

.watch-related-header h4 {
  margin: 0;
  font-size: 1rem;
  color: #fff;
}

.watch-related-scroll {
  max-height: 360px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-right: 4px;
}

.watch-related-scroll::-webkit-scrollbar {
  width: 6px;
}

.watch-related-scroll::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.25);
  border-radius: 999px;
}

.watch-related-item {
  display: flex;
  gap: 12px;
  padding: 10px;
  border-radius: 14px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.06);
  text-decoration: none;
  color: inherit;
  transition: all 0.2s ease;
  align-items: center;
}

.watch-related-item:hover {
  border-color: rgba(111,177,255,0.6);
  background: rgba(111,177,255,0.08);
  transform: translateY(-1px);
}

.watch-related-poster {
  width: 56px;
  height: 72px;
  border-radius: 10px;
  background-size: cover;
  background-position: center;
  flex-shrink: 0;
}

.watch-related-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.watch-related-title {
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
}

.watch-related-meta {
  color: #cbd5f5;
  font-size: 0.8rem;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

/* Movie Genres - Enhanced */
.movie-genres {
  margin: 30px 0;
  padding: 25px 0;
  border-top: 2px solid rgba(59, 130, 246, 0.3);
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05));
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.movie-genres::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
  animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.movie-genres h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.3em;
  font-weight: 700;
  text-align: left;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.movie-genres h3::after {
  content: 'üé¨';
  margin-left: 10px;
  font-size: 1.1em;
}

.genre-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: flex-start;
  padding: 0 20px;
}

.genre-tag {
  background: linear-gradient(135deg, #1e293b, #334155);
  color: #e2e8f0;
  padding: 10px 20px;
  border-radius: 25px;
  text-decoration: none;
  font-size: 0.95em;
  font-weight: 600;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.genre-tag::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.genre-tag:hover::before {
  left: 100%;
}

.genre-tag:hover {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  color: #fff;
  transform: translateY(-3px) scale(1.05);
  box-shadow: 
    0 8px 25px rgba(59, 130, 246, 0.4),
    0 0 20px rgba(59, 130, 246, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  border-color: #3b82f6;
}

.genre-tag:active {
  transform: translateY(-1px) scale(1.02);
}

/* Episodes Section */
.episodes-section {
  margin: 30px 0;
  padding: 20px 0;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.episodes-section h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.3em;
  font-weight: 600;
}

.episodes-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 15px;
}

.episode-item {
  background: var(--panel);
  border-radius: 12px;
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.episode-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
  border-color: var(--primary);
}

.episode-link {
  display: flex;
  align-items: center;
  padding: 15px;
  text-decoration: none;
  color: inherit;
  transition: all 0.3s ease;
}

.episode-link:hover {
  text-decoration: none;
  color: inherit;
}

.episode-link.active {
  background: linear-gradient(135deg, var(--primary), #4f46e5);
  color: white;
}

.episode-number {
  background: var(--primary);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1em;
  margin-right: 15px;
  flex-shrink: 0;
}

.episode-link.active .episode-number {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.episode-info {
  flex: 1;
}

.episode-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #fff;
  margin-bottom: 5px;
}

.episode-duration {
  font-size: 0.9em;
  color: #ccc;
  opacity: 0.8;
}

.episode-link.active .episode-title,
.episode-link.active .episode-duration {
  color: white;
}

.movie-overview {
  margin: 20px 0;
  padding: 20px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
}

.movie-overview h3 {
  color: #fff;
  margin-bottom: 10px;
  font-size: 1.2em;
}

.movie-overview p {
  color: #ccc;
  line-height: 1.6;
}

.related-section, .new-releases-section {
  margin: 30px 0;
}

.related-section h3, .new-releases-section h3 {
  color: #fff;
  margin-bottom: 15px;
  font-size: 1.3em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.similarity-score {
  margin: 5px 0;
  font-size: 0.9em;
}

.similarity-label {
  color: #888;
}

.similarity-value {
  color: var(--primary);
  font-weight: bold;
}

.cards {
  display: flex;
  gap: 15px;
  overflow-x: auto;
  padding: 10px 0 20px 0;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) #2a2a2a;
}

/* Custom scrollbar for WebKit browsers (Chrome, Safari, Edge) */
.cards::-webkit-scrollbar {
  height: 8px;
}

.cards::-webkit-scrollbar-track {
  background: #2a2a2a;
  border-radius: 4px;
  box-shadow: inset 0 0 2px rgba(0, 0, 0, 0.3);
}

.cards::-webkit-scrollbar-thumb {
  background: linear-gradient(90deg, var(--primary), var(--primary-2));
  border-radius: 4px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.cards::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(90deg, var(--primary-2), var(--primary));
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  transform: scaleY(1.2);
}

.cards::-webkit-scrollbar-thumb:active {
  background: linear-gradient(90deg, #1d4ed8, var(--primary));
}

.cards::-webkit-scrollbar-corner {
  background: #2a2a2a;
}

/* Smooth scrolling */
.cards {
  scroll-behavior: smooth;
}

/* Cards container with scroll buttons */
.cards-container {
  position: relative;
  display: flex;
  align-items: center;
  gap: 10px;
}

.scroll-btn {
  background: rgba(59, 130, 246, 0.8);
  border: none;
  color: white;
  font-size: 24px;
  font-weight: bold;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.scroll-btn:hover {
  background: rgba(59, 130, 246, 1);
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
}

.scroll-btn:active {
  transform: scale(0.95);
}

.scroll-left {
  position: absolute;
  left: -50px;
}

.scroll-right {
  position: absolute;
  right: -50px;
}

/* Hide scroll buttons on mobile */
@media (max-width: 768px) {
  .scroll-btn {
    display: none;
  }
  
  .cards-container {
    gap: 0;
  }
}

.card {
  flex: 0 0 320px;
  text-decoration: none;
  color: inherit;
  transition: transform 0.2s ease;
  height: 140px;
  display: flex;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 12px;
  overflow: hidden;
}

.card:hover {
  transform: translateY(-5px);
}

.card-link {
  display: flex;
  flex-direction: row;
  width: 100%;
  height: 100%;
}

.poster {
  width: 100px;
  height: 100%;
  background-size: cover;
  background-position: center;
  flex-shrink: 0;
  margin-bottom: 0;
  border-radius: 0;
}

.card-content {
  padding: 10px 15px;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.stars {
  color: #ffdf6c;
  font-size: 0.8em;
}

/* Responsive */
@media (max-width: 768px) {
  .cards {
    gap: 10px;
  }
  
  .card {
    flex: 0 0 150px;
  }
  
  .poster {
    height: 200px;
  }
}

.movie-rating {
  display: flex;
  align-items: center;
  gap: 5px;
  margin-top: 5px;
  font-size: 0.9rem;
}

.rating-stars {
  color: #ffc107;
  font-weight: bold;
}

.rating-count {
  color: #ccc;
  font-size: 0.8rem;
}

/* Rating Section Styles for Watch Page */
.rating-section {
  margin: 30px 0;
  padding: 25px;
  border-top: 2px solid rgba(255, 193, 7, 0.3);
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.05), rgba(255, 152, 0, 0.05));
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.rating-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #ffc107, #ff9800, #ff5722, #e91e63);
  animation: shimmer 3s ease-in-out infinite;
}

.rating-section h3 {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1.4em;
  font-weight: 700;
  text-align: left;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.rating-section h3::after {
  content: '‚≠ê';
  margin-left: 10px;
  font-size: 1.2em;
}

.rating-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: flex-start;
}

.rating-info {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}

.current-rating {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

#avg-rating-display {
  color: #ffc107;
  font-weight: bold;
  font-size: 1.2rem;
}

#rating-count {
  color: #ccc;
  font-size: 1rem;
}

.user-rating-info {
  margin-top: 5px;
}

#user-rating-text {
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
}

.star-rating {
  display: flex;
  gap: 8px;
  font-size: 2.5rem;
  cursor: pointer;
  margin: 10px 0;
}

.star {
  color: #666;
  transition: all 0.3s ease;
  user-select: none;
  position: relative;
}

.star.active {
  color: #ffc107 !important;
  transform: scale(1.1);
  text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.star:hover {
  color: #ffc107;
  transform: scale(1.1);
  text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
}

.star:hover ~ .star:not(.active) {
  color: #666;
}

.rating-actions {
  display: flex;
  gap: 15px;
  align-items: center;
}

.btn-delete-rating {
  background: rgba(244, 67, 54, 0.8);
  border: none;
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-delete-rating:hover {
  background: rgba(244, 67, 54, 1);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
}

/* Responsive */
@media (max-width: 768px) {
  .rating-section {
    margin: 20px 0;
    padding: 20px;
  }
  
  .star-rating {
    font-size: 2rem;
  }
  
  .rating-container {
    align-items: center;
  }
  
  .rating-info {
    text-align: center;
  }
}

/* Comments Section Styles */
.comments-section {
  margin: 40px 0;
  padding: 30px 0;
  border-top: 2px solid rgba(59, 130, 246, 0.3);
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05));
  border-radius: 15px;
  position: relative;
  overflow: hidden;
}

.comments-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
  animation: shimmer 3s ease-in-out infinite;
}

.comments-section h3 {
  color: #fff;
  margin-bottom: 25px;
  font-size: 1.5em;
  font-weight: 700;
  text-align: left;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  position: relative;
}

.comment-form {
  margin-bottom: 30px;
  background: rgba(255, 255, 255, 0.05);
  padding: 20px;
  border-radius: 12px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

#comment-input {
  width: 100%;
  min-height: 100px;
  padding: 15px;
  border: 2px solid rgba(59, 130, 246, 0.3);
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 1rem;
  font-family: inherit;
  resize: vertical;
  transition: all 0.3s ease;
}

#comment-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#comment-input::placeholder {
  color: #9ca3af;
}

.comment-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}

#char-count {
  color: #9ca3af;
  font-size: 0.9rem;
}

.btn-submit-comment {
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  border: none;
  color: white;
  padding: 12px 24px;
  border-radius: 25px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.btn-submit-comment:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-submit-comment:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.comments-container {
  max-height: 600px;
  overflow-y: auto;
  padding-right: 10px;
}

.comment-item {
  margin-bottom: 15px;
  padding: 15px 0;
}

.comment-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
}

.comment-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  margin-right: 12px;
  font-size: 1.1rem;
}

.comment-user {
  color: #fff;
  font-weight: 600;
  font-size: 1rem;
}

.comment-time {
  color: #9ca3af;
  font-size: 0.85rem;
  margin-left: auto;
}

.comment-content {
  color: #e5e7eb;
  line-height: 1.6;
  margin-bottom: 8px;
  word-wrap: break-word;
}

.comment-actions {
  display: flex;
  align-items: center;
  gap: 2px;
  margin-top: 6px;
}

.btn-like {
  display: flex;
  align-items: center;
  gap: 5px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-like:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.btn-like.liked {
  background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 140, 140, 0.2));
  border-color: rgba(255, 107, 107, 0.4);
  color: #ff6b6b;
}

.btn-like.liked:hover {
  background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 140, 140, 0.3));
  border-color: rgba(255, 107, 107, 0.5);
}

.like-icon {
  font-size: 1rem;
  transition: transform 0.2s ease;
}

.btn-like:hover .like-icon {
  transform: scale(1.1);
}

.like-count {
  font-weight: 600;
  min-width: 20px;
  text-align: center;
}

.replies {
  margin-left: 35px;
  margin-top: 8px;
  padding-left: 15px;
}

.replies .comment-item {
  margin-bottom: 12px;
  padding: 12px 0;
}

.replies .comment-item:last-child {
  margin-bottom: 0;
}

/* Nested replies (c·∫•p 2) */
.replies .replies {
  margin-left: 25px;
  padding-left: 12px;
}

.replies .replies .comment-item {
  margin-bottom: 10px;
  padding: 10px 0;
}

/* Dropdown menu cho comment actions */
.comment-menu {
  position: relative;
  display: inline-block;
}

.btn-menu {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  padding: 6px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-menu:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  right: 0;
  background: rgba(30, 30, 30, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  min-width: 120px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  z-index: 1000;
  display: none;
  margin-top: 5px;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  display: block;
  width: 100%;
  padding: 10px 15px;
  background: none;
  border: none;
  color: #fff;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.2s ease;
  font-size: 0.85rem;
}

.dropdown-item:hover {
  background: rgba(255, 255, 255, 0.1);
}

.dropdown-item:first-child {
  border-radius: 8px 8px 0 0;
}

.dropdown-item:last-child {
  border-radius: 0 0 8px 8px;
}

.dropdown-item.delete:hover {
  background: rgba(220, 38, 38, 0.2);
  color: #fca5a5;
}

.reply-to-info {
  margin-bottom: 8px;
  padding: 6px 10px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 6px;
  color: #93c5fd;
  font-size: 0.8rem;
}

.btn-reply, .btn-edit, .btn-delete {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #fff;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.btn-reply:hover, .btn-edit:hover, .btn-delete:hover {
  background: rgba(255, 255, 255, 0.2);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.btn-reply:hover {
  border-color: #3b82f6;
  color: #3b82f6;
}

.btn-edit:hover {
  border-color: #f59e0b;
  color: #f59e0b;
}

.btn-delete:hover {
  border-color: #ef4444;
  color: #ef4444;
}

.reply-form {
  margin-top: 15px;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  display: none;
}

.reply-form textarea {
  width: 100%;
  min-height: 60px;
  padding: 10px;
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 6px;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 0.9rem;
  resize: vertical;
}

.reply-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: flex-end;
}

.edit-form {
  margin-top: 15px;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
}

.edit-form textarea {
  width: 100%;
  min-height: 60px;
  padding: 10px;
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 6px;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 0.9rem;
  resize: vertical;
}

.edit-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  justify-content: flex-end;
}

.edit-actions button, .reply-actions button {
  background: none;
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: #9ca3af;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.edit-actions button:hover, .reply-actions button:hover {
  border-color: #3b82f6;
  color: #3b82f6;
}

.replies {
  margin-left: 20px;
  margin-top: 15px;
  border-left: 2px solid rgba(59, 130, 246, 0.3);
  padding-left: 15px;
}

.no-comments {
  text-align: center;
  color: #9ca3af;
  font-style: italic;
  padding: 40px 20px;
}

/* Fix text color and remove underlines for related movies cards */
.card-link {
  text-decoration: none !important;
  color: inherit !important;
}

.card-link:hover {
  text-decoration: none !important;
  color: inherit !important;
}

.card-title {
  color: #fff !important;
}

.card-meta {
  color: #fff !important;
}

.card-genres {
  color: #fff !important;
}

.movie-rating {
  color: #fff !important;
}

.similarity-score {
  color: #fff !important;
}

.similarity-label {
  color: #fff !important;
}

.similarity-value {
  color: #fff !important;
}
</style>

<script>
/* eslint-disable */
function toggleHeroOverview() {
  const text = document.getElementById('hero-overview-text');
  const btn = document.querySelector('.hero-overview-toggle');
  if (!text || !btn) return;
  const isCollapsed = text.classList.toggle('collapsed');
  btn.textContent = isCollapsed ? 'Xem th√™m' : 'Thu g·ªçn';
}

document.addEventListener('DOMContentLoaded', function() {
  // Load ratings for related movies
  loadAllRatings();
  
  // Load rating for current movie
  loadCurrentMovieRating();
  
  // Star rating event listeners
  const stars = document.querySelectorAll('.star');
  stars.forEach(star => {
    star.addEventListener('click', function() {
      const rating = parseInt(this.dataset.rating);
      const starRatingElement = document.getElementById('star-rating');
      let movieId = starRatingElement.dataset.movieId;
      
      // Fallback: try to get movie ID from URL or other sources
      if (!movieId) {
        const urlParams = new URLSearchParams(window.location.search);
        movieId = urlParams.get('movie_id') || starRatingElement.dataset.movieIdFallback;
      }
      
      console.log('Rating clicked:', rating, 'Movie ID:', movieId);
      console.log('Star rating element:', starRatingElement);
      console.log('Dataset:', starRatingElement.dataset);
      
      if (!movieId) {
        console.error('Movie ID not found in dataset or URL');
        showToast('L·ªói: Kh√¥ng t√¨m th·∫•y ID phim', 'error');
        return;
      }
      
      // Update stars immediately on click
      updateStarRating(rating);
      // Then submit to server
      submitRating(movieId, rating);
    });
    
    star.addEventListener('mouseenter', function() {
      const rating = parseInt(this.dataset.rating);
      updateStarRating(rating);
    });
  });
  
  // Star rating container events
  const starRating = document.getElementById('star-rating');
  
  starRating.addEventListener('mouseleave', function() {
    // Restore to user's actual rating
    updateStarRating(currentUserRating);
  });
  
  // Delete rating button
  const deleteBtn = document.getElementById('delete-rating-btn');
  deleteBtn.addEventListener('click', function() {
    const movieId = document.getElementById('star-rating').dataset.movieId;
    deleteRating(movieId);
  });
  
  // Load comments when page loads
  loadComments(document.getElementById('star-rating').dataset.movieId);
  
  // Video progress tracking
  initializeVideoProgressTracking();
  
  // Comment form event listeners
  const commentInput = document.getElementById('comment-input');
  const charCount = document.getElementById('char-count');
  const submitCommentBtn = document.getElementById('submit-comment-btn');
  
  commentInput.addEventListener('input', function() {
    const length = this.value.length;
    charCount.textContent = `${length}/1000`;
    
    if (length > 0 && length <= 1000) {
      submitCommentBtn.disabled = false;
    } else {
      submitCommentBtn.disabled = true;
    }
  });
  
  submitCommentBtn.addEventListener('click', function() {
    const content = commentInput.value.trim();
    if (content && content.length <= 1000) {
      submitComment(document.getElementById('star-rating').dataset.movieId, content);
    }
  });
  
  commentInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      const content = this.value.trim();
      if (content && content.length <= 1000) {
        submitComment(document.getElementById('star-rating').dataset.movieId, content);
      }
    }
  });
}); // End of DOMContentLoaded

// Rating functions for current movie
function loadCurrentMovieRating() {
  const starRatingElement = document.getElementById('star-rating');
  let movieId = starRatingElement.dataset.movieId;
  
  // Fallback: try to get movie ID from URL or other sources
  if (!movieId) {
    const urlParams = new URLSearchParams(window.location.search);
    movieId = urlParams.get('movie_id') || starRatingElement.dataset.movieIdFallback;
  }
  
  console.log('Loading rating for movie:', movieId);
  console.log('Star rating element:', starRatingElement);
  console.log('Dataset:', starRatingElement.dataset);
  
  if (!movieId) {
    console.error('Movie ID not found in dataset or URL');
    return;
  }
  
  fetch(`/get-rating/${movieId}`)
  .then(response => {
    console.log('Get rating response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Get rating response data:', data);
    if (data.success) {
      updateRatingDisplay(data.user_rating, data.avg_rating, data.total_ratings);
      updateStarRating(data.user_rating);
    }
  })
  .catch(error => {
    console.error('Error loading rating for current movie:', error);
  });
}

function submitRating(movieId, rating) {
  console.log('Submitting rating:', movieId, rating);
  fetch(`/submit-rating/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ rating: rating })
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    if (data.success) {
      showToast(data.message, 'success');
      updateRatingDisplay(data.user_rating, data.avg_rating, data.total_ratings);
      updateStarRating(data.user_rating);
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi ƒë√°nh gi√°', 'error');
  });
}

function deleteRating(movieId) {
  fetch(`/delete-rating/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      updateRatingDisplay(0, data.avg_rating, data.total_ratings);
      updateStarRating(0);
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi x√≥a ƒë√°nh gi√°', 'error');
  });
}

function updateRatingDisplay(userRating, avgRating, totalRatings) {
  const avgRatingDisplay = document.getElementById('avg-rating-display');
  const ratingCount = document.getElementById('rating-count');
  const userRatingText = document.getElementById('user-rating-text');
  const deleteBtn = document.getElementById('delete-rating-btn');
  
  avgRatingDisplay.textContent = `‚≠ê ${avgRating}`;
  ratingCount.textContent = `(${totalRatings} ƒë√°nh gi√°)`;
  
  if (userRating > 0) {
    userRatingText.textContent = `B·∫°n ƒë√£ ƒë√°nh gi√°: ${userRating} sao`;
    deleteBtn.style.display = 'inline-block';
  } else {
    userRatingText.textContent = 'Ch∆∞a ƒë√°nh gi√°';
    deleteBtn.style.display = 'none';
  }
}

let currentUserRating = 0; // Track the user's actual rating

function updateStarRating(rating) {
  console.log('updateStarRating called with rating:', rating);
  const stars = document.querySelectorAll('.star');
  stars.forEach((star) => {
    const starRating = parseInt(star.dataset.rating);
    if (starRating <= rating) {
      star.classList.add('active');
      console.log(`Star ${starRating}: adding active class`);
    } else {
      star.classList.remove('active');
      console.log(`Star ${starRating}: removing active class`);
    }
  });
  
  // Verify the state after update
  const activeStars = document.querySelectorAll('.star.active');
  console.log(`After update: ${activeStars.length} stars are active`);
  
  // Store the rating if it's from API
  if (rating > 0) {
    currentUserRating = rating;
  }
}

function showToast(message, type = 'success') {
  // Create toast if it doesn't exist
  let toast = document.getElementById('toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'toast';
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #2d3748;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease-in-out;
      max-width: 300px;
      border-left: 4px solid #48bb78;
    `;
    document.body.appendChild(toast);
  }
  
  // Update toast content and style
  toast.innerHTML = `<div class="toast-content">${message}</div>`;
  toast.className = `toast ${type}`;
  if (type === 'error') {
    toast.style.borderLeftColor = '#f56565';
  } else {
    toast.style.borderLeftColor = '#48bb78';
  }
  
  // Show toast
  toast.style.transform = 'translateX(0)';
  
  // Auto hide after 3 seconds
  setTimeout(() => {
    toast.style.transform = 'translateX(400px)';
  }, 3000);
}

// Rating functions for related movies
function loadAllRatings() {
  const ratingElements = document.querySelectorAll('.movie-rating[data-movie-id]');
  ratingElements.forEach(element => {
    const movieId = element.dataset.movieId;
    loadMovieRating(movieId, element);
  });
}

function loadMovieRating(movieId, element) {
  fetch(`/get-rating/${movieId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const ratingStars = element.querySelector('.rating-stars');
      const ratingCount = element.querySelector('.rating-count');
      
      ratingStars.textContent = `‚≠ê ${data.avg_rating}`;
      ratingCount.textContent = `(${data.total_ratings})`;
    }
  })
  .catch(error => {
    console.error('Error loading rating for movie', movieId, ':', error);
  });
}

// Comment functions
function loadComments(movieId) {
  fetch(`/get-comments/${movieId}`)
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      displayComments(data.comments);
    } else {
      console.error('Error loading comments:', data.message);
    }
  })
  .catch(error => {
    console.error('Error loading comments:', error);
  });
}

function displayComments(comments) {
  const container = document.getElementById('comments-container');
  
  if (comments.length === 0) {
    container.innerHTML = '<div class="no-comments">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n!</div>';
    return;
  }
  
  container.innerHTML = comments.map(comment => renderComment(comment)).join('');
  
  // Attach event listeners to comment actions
  attachCommentEventListeners();
}

function renderComment(comment) {
  const createdAt = new Date(comment.createdAt).toLocaleString('vi-VN');
  const userInitial = comment.user_email ? comment.user_email.charAt(0).toUpperCase() : 'U';
  const currentUserId = parseInt(document.getElementById('star-rating').dataset.userId || '0');
  
  return `
    <div class="comment-item" data-comment-id="${comment.id}">
      <div class="comment-header">
        <div class="comment-avatar">${userInitial}</div>
        <div class="comment-user">${comment.user_email}</div>
        <div class="comment-time">${createdAt}</div>
      </div>
      <div class="comment-content">${escapeHtml(comment.content)}</div>
      <div class="comment-actions">
        <button class="btn-like ${comment.isLiked ? 'liked' : ''}" onclick="toggleCommentLike(${comment.id})" data-comment-id="${comment.id}" type="button">
          <span class="like-icon">${comment.isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
          <span class="like-text">Th√≠ch</span>
          <span class="like-count">${comment.likeCount || 0}</span>
        </button>
        <button class="btn-reply" onclick="toggleReplyForm(${comment.id})">Tr·∫£ l·ªùi</button>
        ${comment.userId === currentUserId ? `
          <div class="comment-menu">
            <button class="btn-menu" onclick="toggleCommentMenu(${comment.id})">‚ãØ</button>
            <div class="dropdown-menu" id="menu-${comment.id}">
              <button class="dropdown-item" onclick="editComment(${comment.id})">‚úèÔ∏è S·ª≠a</button>
              <button class="dropdown-item delete" onclick="confirmDeleteComment(${comment.id})">üóëÔ∏è X√≥a</button>
            </div>
          </div>
        ` : ''}
      </div>
      <div class="reply-form" id="reply-form-${comment.id}" style="display: none;">
        <div class="reply-to-info">
          <small>ƒêang tr·∫£ l·ªùi <strong>${comment.user_email}</strong></small>
        </div>
        <textarea placeholder="Vi·∫øt tr·∫£ l·ªùi..." maxlength="1000"></textarea>
        <div class="reply-actions">
          <button onclick="cancelReply(${comment.id})">H·ªßy</button>
          <button onclick="submitReply(${comment.id})">G·ª≠i tr·∫£ l·ªùi</button>
        </div>
      </div>
      <div class="replies">
        ${comment.replies ? comment.replies.map(reply => renderComment(reply)).join('') : ''}
      </div>
    </div>
  `;
}

function submitComment(movieId, content, parentCommentId = null) {
  fetch(`/submit-comment/${movieId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ 
      content: content,
      parent_comment_id: parentCommentId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(data.message, 'success');
      document.getElementById('comment-input').value = '';
      document.getElementById('char-count').textContent = '0/1000';
      document.getElementById('submit-comment-btn').disabled = true;
      loadComments(movieId);
    } else {
      showToast(data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi g·ª≠i b√¨nh lu·∫≠n', 'error');
  });
}

function toggleReplyForm(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  if (replyForm.style.display === 'none') {
    replyForm.style.display = 'block';
    replyForm.querySelector('textarea').focus();
  } else {
    replyForm.style.display = 'none';
  }
}

function submitReply(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  const content = replyForm.querySelector('textarea').value.trim();
  
  if (content && content.length <= 1000) {
    const movieId = document.getElementById('star-rating').dataset.movieId;
    submitComment(movieId, content, commentId);
    replyForm.style.display = 'none';
    replyForm.querySelector('textarea').value = '';
  }
}

function cancelReply(commentId) {
  const replyForm = document.getElementById(`reply-form-${commentId}`);
  replyForm.style.display = 'none';
  replyForm.querySelector('textarea').value = '';
}

function editComment(commentId) {
  // ƒê√≥ng menu dropdown
  const menu = document.getElementById(`menu-${commentId}`);
  if (menu) menu.classList.remove('show');
  
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const contentDiv = commentItem.querySelector('.comment-content');
  const currentContent = contentDiv.textContent;
  
  const editForm = document.createElement('div');
  editForm.className = 'edit-form';
  editForm.innerHTML = `
    <textarea maxlength="1000">${currentContent}</textarea>
    <div class="edit-actions">
      <button onclick="cancelEdit(${commentId})">H·ªßy</button>
      <button onclick="saveEdit(${commentId})">L∆∞u</button>
    </div>
  `;
  
  contentDiv.style.display = 'none';
  contentDiv.parentNode.insertBefore(editForm, contentDiv.nextSibling);
}

function saveEdit(commentId) {
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const editForm = commentItem.querySelector('.edit-form');
  const content = editForm.querySelector('textarea').value.trim();
  
  if (content && content.length <= 1000) {
    fetch(`/update-comment/${commentId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(data.message, 'success');
        loadComments(document.getElementById('star-rating').dataset.movieId);
      } else {
        showToast(data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n', 'error');
    });
  }
}

function cancelEdit(commentId) {
  const commentItem = document.querySelector(`[data-comment-id="${commentId}"]`);
  const editForm = commentItem.querySelector('.edit-form');
  const contentDiv = commentItem.querySelector('.comment-content');
  
  editForm.remove();
  contentDiv.style.display = 'block';
}

function deleteComment(commentId) {
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) {
    fetch(`/delete-comment/${commentId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast(data.message, 'success');
        loadComments(document.getElementById('star-rating').dataset.movieId);
      } else {
        showToast(data.message, 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('C√≥ l·ªói x·∫£y ra khi x√≥a b√¨nh lu·∫≠n', 'error');
    });
  }
}

function toggleCommentLike(commentId) {
  console.log('toggleCommentLike called with commentId:', commentId);
  
  // Ki·ªÉm tra user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a - s·ª≠ d·ª•ng c√°ch kh√°c
  const userIdMeta = document.querySelector('meta[name="user-id"]');
  const currentUserId = document.getElementById('star-rating')?.dataset?.userId;
  
  if (!userIdMeta && !currentUserId) {
    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch b√¨nh lu·∫≠n', 'warning');
    return;
  }

  const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .btn-like`);
  console.log('Found like button:', likeBtn);
  
  if (!likeBtn) {
    console.error('Like button not found for commentId:', commentId);
    return;
  }

  // Disable button ƒë·ªÉ tr√°nh spam click
  likeBtn.disabled = true;
  console.log('Sending request to /toggle-comment-like/' + commentId);

  fetch(`/toggle-comment-like/${commentId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    }
  })
  .then(response => {
    console.log('Response status:', response.status);
    return response.json();
  })
  .then(data => {
    console.log('Response data:', data);
    
    if (data.success) {
      // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
      const likeIcon = likeBtn.querySelector('.like-icon');
      const likeCount = likeBtn.querySelector('.like-count');
      
      if (data.is_liked) {
        likeBtn.classList.add('liked');
        likeIcon.textContent = '‚ù§Ô∏è';
      } else {
        likeBtn.classList.remove('liked');
        likeIcon.textContent = 'ü§ç';
      }
      
      likeCount.textContent = data.new_like_count || 0;
      
      // Hi·ªÉn th·ªã th√¥ng b√°o
      showToast(data.message, 'success');
    } else {
      console.error('API error:', data.message);
      showToast(data.message || 'C√≥ l·ªói x·∫£y ra', 'error');
    }
  })
  .catch(error => {
    console.error('Error toggling like:', error);
    showToast('C√≥ l·ªói x·∫£y ra khi th√≠ch b√¨nh lu·∫≠n', 'error');
  })
  .finally(() => {
    // Re-enable button
    likeBtn.disabled = false;
  });
}

function toggleCommentMenu(commentId) {
  const menu = document.getElementById(`menu-${commentId}`);
  const allMenus = document.querySelectorAll('.dropdown-menu');
  
  // ƒê√≥ng t·∫•t c·∫£ menu kh√°c
  allMenus.forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });
  
  // Toggle menu hi·ªán t·∫°i
  menu.classList.toggle('show');
}

function confirmDeleteComment(commentId) {
  // ƒê√≥ng menu
  const menu = document.getElementById(`menu-${commentId}`);
  menu.classList.remove('show');
  
  // Hi·ªÉn th·ªã dialog x√°c nh·∫≠n
  if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) {
    deleteComment(commentId);
  }
}

// ƒê√≥ng menu khi click b√™n ngo√†i
document.addEventListener('click', function(event) {
  if (!event.target.closest('.comment-menu')) {
    const allMenus = document.querySelectorAll('.dropdown-menu');
    allMenus.forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

function attachCommentEventListeners() {
  // Event listeners are attached via onclick attributes in the HTML
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Video progress tracking functions
function initializeVideoProgressTracking() {
  const video = document.querySelector('.player');
  if (!video) return;
  
  const movieId = document.getElementById('star-rating').dataset.movieId;
  if (!movieId) return;
  
  let progressUpdateInterval;
  let lastProgressUpdate = 0;
  
  // Track video progress every 10 seconds
  video.addEventListener('timeupdate', function() {
    const currentTime = video.currentTime;
    const duration = video.duration;
    
    // Only update if video has loaded and we have meaningful progress
    if (duration && currentTime > 0) {
      const progressPercent = (currentTime / duration) * 100;
      
      // Update progress every 10 seconds or if significant progress made
      if (currentTime - lastProgressUpdate >= 10 || progressPercent >= 90) {
        updateWatchProgress(movieId, Math.floor(currentTime), progressPercent >= 90);
        lastProgressUpdate = currentTime;
      }
    }
  });
  
  // Mark as finished when video ends
  video.addEventListener('ended', function() {
    const duration = video.duration;
    if (duration) {
      updateWatchProgress(movieId, Math.floor(duration), true);
      showToast('üéâ B·∫°n ƒë√£ xem xong phim!', 'success');
    }
  });
  
  // Track when user starts playing
  video.addEventListener('play', function() {
    const currentTime = video.currentTime;
    if (currentTime > 0) {
      updateWatchProgress(movieId, Math.floor(currentTime), false);
    }
  });
}

function updateWatchProgress(movieId, progressSec, isFinished = false) {
  fetch('/api/update_watch_progress', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      movie_id: parseInt(movieId),
      progress_sec: progressSec,
      is_finished: isFinished
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Watch progress updated:', data.message);
      if (isFinished) {
        console.log('Movie marked as completed');
        showToast('üéâ Phim ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u ho√†n th√†nh!', 'success');
      }
    } else {
      console.error('Error updating watch progress:', data.message);
      showToast('L·ªói c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô xem: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('Error updating watch progress:', error);
    showToast('L·ªói c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô xem', 'error');
  });
}

</script>
{% endblock %}